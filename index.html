<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valulens - PE 전용 딥 리서치</title>
    <style>
        :root {
            /* Primary - Navy Blue (템플릿 #373c5f 계열) */
            --primary: #373c5f;
            --primary-dark: #2a2e4a;
            --primary-light: #4a5080;

            /* Accent - Gold (템플릿 #b49132) */
            --accent: #b49132;
            --accent-dark: #9a7c2a;
            --accent-light: #c9a64a;

            /* Text Colors */
            --text-dark: #1a1a1a;
            --text-medium: #4a5568;
            --text-light: #6b7280;

            /* Background Colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;

            /* Border Colors */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            overflow-y: auto;
        }

        body {
            font-family: 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 110px 20px 40px 20px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            background: #ffffff;
            border-radius: 12px;
            padding: 48px;
            width: 100%;
            max-width: 840px;
            margin: 0 auto;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
        }

        /* 초기 상태: 화면 가운데 약간 위 */
        .container.centered {
            margin-top: calc(25vh - 80px);
            transition: margin-top 0.4s ease;
        }

        .container.centered .hero-tagline {
            display: block;
        }

        .hero-tagline {
            display: none;
            text-align: center;
            margin-bottom: 32px;
        }

        .hero-tagline .tagline-main {
            font-size: 2rem;
            font-weight: 700;
            color: #C8A45A;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .hero-tagline .tagline-sub {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-medium);
            letter-spacing: 0.5px;
        }

        /* 하단 확장 컨테이너 (결과 영역) */
        .container-full {
            display: none;
            background: #ffffff;
            border-radius: 12px;
            padding: 32px 48px;
            width: calc(100% - 40px);
            max-width: 1200px;
            margin: 20px auto 0 auto;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
            text-align: center;
            overflow-x: auto;
        }

        .container-full.show {
            display: block;
        }

        .container-full.expanded {
            max-width: none;
        }
        
        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 36px;
            font-size: 0.9rem;
            font-weight: 400;
        }
        
        /* 검색 섹션 */
        .search-section {
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fafafa;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(180, 145, 50, 0.2);
            background: #ffffff;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
            box-shadow: 0 2px 8px rgba(180, 145, 50, 0.35);
        }

        .btn-secondary {
            background: #131313;
            color: white;
        }

        .btn-secondary:hover {
            background: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        }

        .btn-danger {
            background: #7d7d7d;
            color: white;
        }

        .btn-danger:hover {
            background: #5c5c5c;
            box-shadow: 0 2px 8px rgba(125, 125, 125, 0.25);
        }
        
        .btn-success {
            background: #131313;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        }

        .btn-success:disabled {
            background: #6a6a6a;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 공통 호버 툴팁 */
        .hover-tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .hover-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            background: #333;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
            transition: opacity 0.2s, visibility 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .hover-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            border-width: 8px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .hover-tooltip-wrapper:hover .hover-tooltip:not(.hidden) {
            visibility: visible;
            opacity: 1;
        }

        .hover-tooltip.hidden {
            display: none;
        }

        /* 다운로드 버튼 툴팁 위치 */
        .download-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        .download-btn-wrapper .hover-tooltip {
            right: 0;
        }

        .download-btn-wrapper .hover-tooltip::after {
            right: 20px;
        }

        .download-btn-wrapper:hover .hover-tooltip:not(.hidden) {
            visibility: visible;
            opacity: 1;
        }

        /* 분석 탭 버튼 툴팁 위치 */
        .insight-tab-wrapper .hover-tooltip {
            left: 50%;
            transform: translateX(-50%);
        }

        .insight-tab-wrapper .hover-tooltip::after {
            left: 50%;
            transform: translateX(-50%);
        }

        .insight-tab-wrapper:hover .hover-tooltip:not(.hidden) {
            visibility: visible;
            opacity: 1;
        }

        .btn-ai {
            background: var(--accent);
            color: white;
        }

        .btn-ai:hover {
            background: var(--accent-dark);
            box-shadow: 0 2px 8px rgba(180, 145, 50, 0.4);
        }

        .btn-ai:disabled {
            background: #c9b896;
            cursor: not-allowed;
        }

        .btn-large {
            padding: 14px 28px;
            font-size: 1rem;
        }

        /* AI 분석 시작 컨테이너 */
        .analysis-start-container {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
            border-radius: 12px;
            margin: 10px 0;
        }

        .analysis-start-description {
            color: #6b7280;
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        /* AI 분석 섹션 */
        .analysis-section {
            margin-top: 20px;
            background: #f5f5f5;
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 20px;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .analysis-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--primary-dark);
        }

        .analysis-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #e2e8f0;
            color: var(--primary);
        }

        .analysis-status.running {
            background: #fef3c7;
            color: #d97706;
        }

        .analysis-status.completed {
            background: #d1fae5;
            color: #059669;
        }

        .analysis-status.failed {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-copy {
            font-size: 0.8rem;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-copy:hover {
            background: var(--primary-dark);
        }

        .btn-copy.copied {
            background: var(--accent);
        }

        .analysis-message {
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
            margin: 8px 0;
        }

        .analysis-message.loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .analysis-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
            text-align: left;
        }

        .analysis-result h1 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        .analysis-result h2 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .analysis-result h3 {
            font-size: 1rem;
            color: var(--primary-dark);
            margin-top: 28px;
            margin-bottom: 6px;
        }

        .analysis-result h3.finding-header {
            font-size: 1rem;
            color: var(--primary-dark);
            margin-top: 24px;
            margin-bottom: 8px;
            padding-left: 0;
        }

        .analysis-result h3.finding-header .finding-number {
            color: var(--accent);
            font-weight: 700;
            margin-right: 4px;
        }

        .analysis-result ul, .analysis-result ol {
            padding-left: 0;
            margin-left: 0;
            list-style: none;
        }

        .analysis-result li {
            margin-bottom: 4px;
            padding-left: 0;
            text-indent: 0;
        }

        .analysis-result p {
            margin: 4px 0;
        }

        .analysis-result strong {
            color: var(--primary);
        }

        .analysis-result hr {
            display: none;
        }

        /* 기업 리서치 결과 영역 - vcm-wrapper와 유사한 너비 */
        .super-research-result {
            max-width: 1100px;
        }

        /* 기업 리서치 테이블 스타일 */
        .analysis-result table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.85rem;
        }

        .analysis-result th,
        .analysis-result td {
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            text-align: left;
            vertical-align: top;
        }

        .analysis-result th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary-dark);
            white-space: nowrap;
        }

        .analysis-result td {
            background: white;
        }

        .analysis-result tr:hover td {
            background: #fafafa;
        }

        .analysis-result thead th {
            background: var(--primary-dark);
            color: white;
        }

        /* 기업 리서치 테이블 줄무늬 */
        .analysis-result tbody tr:nth-child(even) td {
            background: #f9fafb;
        }

        /* 기업 리서치 헤더 스타일 */
        .super-research-result h1 {
            font-size: 1.6rem;
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin: 0 0 24px 0;
        }

        .super-research-result h2 {
            font-size: 1.25rem;
            color: var(--primary-dark);
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 12px 16px;
            border-left: 4px solid var(--primary);
            margin: 28px 0 16px 0;
            border-radius: 0 8px 8px 0;
        }

        .super-research-result h3 {
            font-size: 1.05rem;
            color: #374151;
            font-weight: 600;
            margin: 20px 0 8px 0;
        }

        .super-research-result h3.finding-header {
            border-left: none;
            padding-left: 0;
        }

        .super-research-result h4 {
            font-size: 0.95rem;
            color: #4b5563;
            margin: 16px 0 10px 0;
        }

        .super-research-result p {
            line-height: 1.7;
            color: #374151;
            margin: 12px 0;
        }

        .super-research-result ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .super-research-result li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .super-research-result li ul {
            margin: 6px 0;
        }

        /* Mermaid 차트 컨테이너 */
        .super-research-result .mermaid {
            background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            overflow-x: auto;
        }

        .super-research-result .mermaid svg {
            max-width: 100%;
            height: auto;
            min-height: 200px;
            display: block;
            margin: 0 auto;
        }

        /* 기업 개요 테이블 특별 스타일 */
        .super-research-result table:first-of-type {
            border: 2px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
        }

        /* JSON 기반 리서치 보고서 스타일 */
        .research-title {
            font-size: 1.5rem;
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin: 0 0 24px 0;
        }

        .research-section {
            margin: 24px 0;
            padding: 16px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .research-section h3 {
            font-size: 1.15rem;
            color: var(--primary-dark);
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

        .research-section h4 {
            font-size: 1rem;
            color: #374151;
            margin: 20px 0 12px 0;
            font-weight: 600;
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        .overview-table th {
            width: 120px;
            background: var(--primary-dark);
            color: white;
            padding: 10px 14px;
            text-align: left;
            font-weight: 500;
        }

        .overview-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #e5e7eb;
        }

        .business-summary {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.7;
            margin-bottom: 16px;
        }

        .business-areas {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .business-areas li {
            padding: 10px 14px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .business-areas li strong {
            color: var(--primary-dark);
        }

        .competitors-list {
            display: grid;
            gap: 12px;
        }

        .competitor-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 14px;
        }

        .competitor-header {
            margin-bottom: 10px;
        }

        .competitor-name {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1rem;
        }

        .competitor-ticker {
            color: #6b7280;
            font-size: 0.9rem;
            margin-left: 6px;
        }

        .competitor-field,
        .competitor-reason {
            font-size: 0.9rem;
            color: #374151;
            margin: 6px 0;
        }

        .competitor-details {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e5e7eb;
            line-height: 1.6;
        }

        .mna-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 8px;
        }

        .mna-table th {
            background: #f3f4f6;
            color: #374151;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .mna-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .mna-table tbody tr:hover {
            background: #f9fafb;
        }

        .news-content {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .news-item {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 8px 10px;
            font-size: 0.93rem;
            color: #374151;
            line-height: 1.6;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .news-item:last-child { border-bottom: none; }
        .news-header {
            display: flex;
            align-items: baseline;
            gap: 10px;
            width: 100%;
        }
        .news-description {
            width: 100%;
            font-size: 0.85rem;
            color: #6b7280;
            padding-left: 2px;
            line-height: 1.5;
        }
        .news-date {
            flex-shrink: 0;
            font-size: 0.82rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            min-width: 65px;
            text-align: center;
        }
        .news-type {
            flex-shrink: 0;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 4px;
            min-width: 32px;
            text-align: center;
        }
        .news-type.type-news {
            color: #1d4ed8;
            background: #dbeafe;
        }
        .news-type.type-disclosure {
            color: #b45309;
            background: #fef3c7;
        }
        .badge-unverified {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 600;
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .mna-source-link {
            color: #2563eb;
            text-decoration: none;
            font-size: 0.85rem;
        }
        .mna-source-link:hover {
            text-decoration: underline;
        }
        .news-title { flex: 1; }
        .news-link {
            flex-shrink: 0;
            color: #2563eb;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .news-link:hover {
            background: #eff6ff;
            text-decoration: none;
        }

        .research-error {
            padding: 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #991b1b;
        }

        .research-error pre {
            margin-top: 12px;
            padding: 12px;
            background: #fff5f5;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-shake {
            animation: shake 0.5s ease-in-out;
            background: #f59e0b !important;
            border-color: #f59e0b !important;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-4px); }
            40% { transform: translateX(4px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }
        
        /* 검색 히스토리 */
        .search-history {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .search-history:empty {
            display: none;
        }
        
        .history-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .history-item:hover {
            background: #e5e7eb;
        }
        
        .history-item .history-name {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-item .history-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #9ca3af;
            color: #fff;
            font-size: 10px;
            line-height: 1;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .history-item .history-remove:hover {
            background: #6b7280;
        }
        
        /* 검색 결과 */
        .search-results {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            display: none;
            background: #ffffff;
        }
        
        .search-results.show {
            display: block;
            margin-top: 16px;
        }
        
        .result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .result-item:hover {
            background: #f9fafb;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-name {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .result-info {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        
        .result-market {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: 500;
        }
        
        .market-kospi {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .market-kosdaq {
            background: #fef3c7;
            color: #b45309;
        }
        
        .market-etc {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        /* 진행 상태 섹션 */
        .progress-section {
            display: none;
            margin-top: 24px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .progress-section.show {
            display: block;
        }

        /* 기업개황정보 스타일 */
        .company-info-wrapper {
            max-width: 840px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .company-info-section {
            margin: 20px auto 0 auto;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            max-width: 840px;
        }

        .company-info-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .company-info-title:hover {
            color: var(--primary-dark);
        }

        .company-info-toggle {
            font-size: 0.75rem;
            color: #7d7d7d;
        }

        .company-info-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .company-info-content.collapsed {
            max-height: 0 !important;
        }

        .company-info-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 0.9rem;
            padding: 12px 0;
        }

        .company-info-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .company-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .company-info-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .company-info-table td:first-child {
            width: 120px;
            color: #6b7280;
            font-weight: 500;
            background: #f9fafb;
        }

        .company-info-table td:last-child {
            color: #111827;
        }

        .company-info-table tr:last-child td {
            border-bottom: none;
        }

        .company-info-table a {
            color: var(--primary);
            text-decoration: none;
        }

        .company-info-table a:hover {
            text-decoration: underline;
        }

        .selected-company {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-company-name {
            font-weight: 500;
            color: #374151;
        }
        
        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            height: 100%;
            background: #131313;
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
            font-size: 0;
            overflow: hidden;
        }

        /* 분석 진행바 (더 큰 사이즈) */
        .analysis-progress .progress-bar-container {
            height: 24px;
            margin-bottom: 16px;
        }

        .analysis-progress .progress-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            min-width: fit-content;
            padding: 0 8px;
        }
        
        .progress-message {
            text-align: center;
            color: #6b7280;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* 완료 섹션 */
        .complete-section {
            display: none;
            text-align: center;
            margin-top: 24px;
        }

        .complete-section.show {
            display: inline-block;
            text-align: left;
        }
        
        .complete-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: #059669;
        }
        
        .complete-message {
            font-size: 1rem;
            color: #374151;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        /* 에러 메시지 */
        .error-message {
            background: #fef2f2;
            color: #b91c1c;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            margin-top: 12px;
            display: none;
            font-size: 0.9rem;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* 로딩 스피너 */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 연도 선택 */
        .year-selection {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .year-selection label {
            color: #6b7280;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .year-selection select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: #fafafa;
        }

        .year-selection .btn {
            white-space: nowrap;
        }
        
        /* 미리보기 섹션 */
        .preview-section {
            text-align: left;
            overflow-x: auto;
        }
        
        .preview-tabs-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn-ai-analysis {
            padding: 8px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-ai-analysis:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-ai-analysis.analyzing {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-ai-analysis.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .financials-content {
            overflow-x: auto;
        }

        .vcm-sub-tabs {
            display: none;
            gap: 8px;
            margin-bottom: 10px;
            padding-left: 4px;
        }

        .vcm-sub-tabs.show {
            display: flex;
        }

        .vcm-sub-tab {
            padding: 6px 14px;
            font-size: 0.8rem;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #9ca3af;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vcm-sub-tab:hover {
            background: #f9fafb;
            color: #6b7280;
        }

        .vcm-sub-tab.active {
            background: #374151;
            color: #ffffff;
            border-color: #374151;
        }

        .vcm-sub-tab.active:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        .vcm-sub-tab.analyzing {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* VCM 서브탭 AI 버튼 툴팁 */
        .vcm-ai-tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .vcm-ai-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #fbbf24;
            color: #78350f;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .vcm-ai-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: #fbbf24 transparent transparent transparent;
        }

        .vcm-ai-tooltip-wrapper:hover .vcm-ai-tooltip:not(.hidden) {
            visibility: visible;
            opacity: 1;
        }

        .vcm-ai-tooltip.hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .vcm-box.hidden {
            display: none !important;
        }

        .preview-tab {
            padding: 6px 14px;
            font-size: 0.8rem;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #9ca3af;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preview-tab:hover {
            background: #f9fafb;
            color: #6b7280;
        }

        .preview-tab.active {
            background: #374151;
            color: #ffffff;
            border-color: #374151;
        }

        .preview-tab.active:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        /* 분석 진행 상태 메시지 */
        .analysis-status-message {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            color: #333;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .analysis-status-message.completed {
            background: #fafafa;
            border-color: #ccc;
            color: #1a1a1a;
        }

        .analysis-status-message .status-icon {
            font-size: 1.1rem;
        }

        .analysis-status-message.completed .status-icon {
            color: #b8860b;
            font-weight: bold;
        }

        /* 상위 탭 메뉴 (재무정보 / 재무분석 AI) */
        .main-tabs-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .main-tabs {
            display: flex;
            gap: 8px;
        }

        .main-tab {
            padding: 10px 28px;
            border: 1px solid transparent;
            background: rgba(19, 19, 19, 0.08);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: #131313;
            transition: all 0.15s;
        }

        .main-tab:hover {
            background: rgba(19, 19, 19, 0.15);
            color: #131313;
        }

        .main-tab.active {
            background: #131313;
            border-color: #131313;
            color: #ffffff;
        }

        .main-tab.analyzing {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
            animation: pulse-analyzing 1.5s ease-in-out infinite;
        }

        @keyframes pulse-analyzing {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .main-tab.completed:not(.active) {
            background: rgba(19, 19, 19, 0.15);
            border-color: transparent;
            color: #131313;
        }

        .main-tab.completed.active {
            background: #131313;
            border-color: #131313;
            color: #ffffff;
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        .preview-content {
            border: none;
            border-radius: 0;
            background: transparent;
            overflow-x: auto;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f3f4f6;
            text-align: right;
            white-space: nowrap;
        }
        
        .preview-table td:first-child {
            text-align: left;
            font-weight: 500;
            color: #374151;
        }

        .preview-table th:first-child {
            text-align: left;
            font-weight: 600;
            color: #ffffff;
        }
        
        .preview-table th {
            background: #131313;
            font-weight: 600;
            color: #ffffff;
            position: sticky;
            top: 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .preview-table tr:hover {
            background: #f9fafb;
        }

        /* 주석 구분선 */
        .preview-table .notes-separator td {
            text-align: center !important;
            padding: 10px 0;
            color: #9ca3af;
            font-size: 0.72rem;
            border-top: 2px solid #d1d5db;
            background: #f9fafb;
            letter-spacing: 3px;
            font-weight: 500;
        }

        /* 주석 그룹 헤더 (FY에 텍스트가 있는 섹션 헤더) */
        .preview-table .note-group-header td {
            font-weight: 600 !important;
            background: #f3f4f6;
            color: #6b7280 !important;
            text-align: left !important;
            font-size: 0.75rem;
            border-top: 1px solid #d1d5db;
        }

        /* 주석 영역 일반 행 */
        .preview-table .note-row td {
            color: #9ca3af;
        }
        .preview-table .note-row td:first-child {
            color: #6b7280 !important;
            padding-left: 24px;
        }
        .preview-table .note-row:hover {
            background: #f3f4f6;
        }
        
        .preview-placeholder {
            padding: 48px;
            text-align: center;
            color: #9ca3af;
        }
        
        .preview-info {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 8px;
            text-align: center;
        }
        
        .preview-unit {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 8px;
            margin-bottom: 8px;
            text-align: left;
            font-weight: 500;
        }

        /* 재무상태표/손익계산서/현금흐름표 테이블 wrapper */
        .preview-table-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
            overflow-x: auto;
            background: #fafafa;
            border-radius: 8px;
        }

        .preview-table-wrapper .preview-table {
            width: 100%;
            max-width: 100%;
        }

        /* VCM 전용 포맷 스타일 */
        .vcm-wrapper {
            display: inline-flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            text-align: left;
            border: none;
            background: transparent;
            outline: none;
            box-shadow: none;
        }

        /* 재무 상세 프리뷰 (다중 선택) */
        .preview-wrapper {
            display: inline-flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            text-align: left;
        }

        .preview-box {
            flex: 1 1 500px;
            min-width: 500px;
            max-width: fit-content;
            overflow-x: auto;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .preview-title {
            background: #131313;
            color: white;
            padding: 10px 14px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            margin: -16px -16px 16px -16px;
            border-radius: 8px 8px 0 0;
        }

        .vcm-box {
            flex: 1 1 500px;
            min-width: 500px;
            max-width: fit-content;
            overflow-x: auto;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        /* 재무분석 AI 박스 전용 스타일 */
        .vcm-box-analysis {
            flex: 1 1 500px;
            min-width: 400px;
            max-width: 600px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* height는 JS에서 동적으로 설정 */
        }

        .vcm-analysis-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
            padding-right: 8px;
        }

        .vcm-analysis-content h1 {
            font-size: 1.1rem;
            margin: 0 0 12px 0;
            color: #1f2937;
        }

        .vcm-analysis-content h2 {
            font-size: 1rem;
            margin: 16px 0 8px 0;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 4px;
        }

        .vcm-analysis-content h3 {
            font-size: 0.9rem;
            margin: 12px 0 6px 0;
            color: #4b5563;
        }

        .vcm-analysis-content p {
            margin: 8px 0;
            color: #4b5563;
        }

        .vcm-analysis-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .vcm-analysis-content li {
            margin: 4px 0;
            color: #4b5563;
        }

        .vcm-title {
            background: #131313;
            color: white;
            padding: 10px 14px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            margin: -16px -16px 16px -16px;
            border-radius: 8px 8px 0 0;
        }

        .vcm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
        }
        
        .vcm-table th,
        .vcm-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
            white-space: nowrap;
        }
        
        .vcm-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid #d1d5db;
        }
        
        .vcm-table td:first-child,
        .vcm-table th:first-child {
            text-align: left;
            color: #374151;
        }
        
        .vcm-table .category-row {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        .vcm-table .sub-item {
            padding-left: 20px;
            color: #6b7280;
        }
        
        .vcm-table .total-row {
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
        }
        
        .vcm-table .highlight-row {
            color: #991b1b;
            font-weight: 600;
            background: #fef2f2;
        }
        
        .vcm-table .percent-row {
            font-style: normal;
            color: #9ca3af;
            font-size: 0.7rem;
        }

        /* 합산된 셀 스타일 (파란색 글자) */
        .vcm-table .calc-cell {
            color: #2563eb;
            cursor: help;
            position: relative;
        }

        .vcm-table .calc-cell:hover {
            color: #1d4ed8;
            font-weight: 600;
            text-decoration: underline;
        }

        /* 툴팁이 있는 셀 */
        .vcm-table td[title]:not([title=""]) {
            cursor: help;
        }

        .vcm-table td[title]:not([title=""]):hover {
            outline: 2px solid #2563eb;
            outline-offset: -2px;
        }

        /* ============================================================
           상단 고정 헤더 스타일
           ============================================================ */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #131313;
            border-bottom: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #131313;
        }

        .brand-section h1 {
            text-align: left;
            margin-bottom: 2px;
            font-size: 1.5rem;
            color: #b49132;
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: unset;
            background-clip: unset;
        }

        .brand-section .subtitle {
            text-align: left;
            margin-bottom: 0;
            font-size: 0.8rem;
            color: darkgray;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-guest {
            display: flex;
            gap: 8px;
        }

        .user-logged-in {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .user-email {
            font-size: 0.9rem;
            color: #ffffff;
            font-weight: 500;
        }

        .user-menu-container {
            position: relative;
        }

        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .user-menu-trigger:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-menu-trigger .arrow {
            font-size: 0.6rem;
            color: #9ca3af;
            transition: transform 0.2s;
        }

        .user-menu-trigger.open .arrow {
            transform: rotate(180deg);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            background: none;
            border: none;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: background 0.15s;
        }

        .user-menu-item:hover {
            background: #f3f4f6;
        }

        .user-menu-item.danger {
            color: #dc2626;
        }

        .user-menu-item.danger:hover {
            background: #fef2f2;
        }

        .user-menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }

        /* 내 정보 모달 스타일 */
        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .profile-modal-overlay.show {
            display: flex;
        }

        .profile-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .profile-modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #111827;
        }

        .profile-modal-body {
            padding: 24px;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .profile-section:last-child {
            margin-bottom: 0;
        }

        .profile-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .profile-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .profile-info-row:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .profile-info-value {
            color: #111827;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .profile-form-group {
            margin-bottom: 16px;
        }

        .profile-form-group label {
            display: block;
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 6px;
        }

        .profile-form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .profile-form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(180, 145, 50, 0.2);
        }

        .profile-btn-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .profile-message {
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 12px;
        }

        .profile-message.success {
            background: #dcfce7;
            color: #166534;
        }

        .profile-message.error {
            background: #fef2f2;
            color: #dc2626;
        }

        .user-tier {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-tier.free {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .user-tier.basic {
            background: var(--accent);
            color: white;
        }

        .user-tier.pro {
            background: var(--accent);
            color: white;
        }

        .user-search-count {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .user-search-count.low {
            background: var(--accent);
            color: white;
        }

        /* 헤더용 (다크 배경) */
        .top-header .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
        }

        .top-header .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* 모달용 (밝은 배경) */
        .btn-outline {
            background: transparent;
            border: 1px solid #e6e6e6;
            color: var(--primary);
        }

        .btn-outline:hover {
            background: #f4f4f4;
            border-color: #d1d1d1;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .btn-full {
            width: 100%;
        }

        /* ============================================================
           로그인/회원가입 모달 스타일
           ============================================================ */
        .auth-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: #ffffff;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .auth-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: #f3f4f6;
            border-radius: 50%;
            font-size: 1.25rem;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .auth-modal-close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .auth-form h2 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .auth-logo {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 28px;
            font-size: 0.9rem;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .auth-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fafafa;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(180, 145, 50, 0.2);
            background: #ffffff;
        }

        .auth-error {
            color: #dc2626;
            font-size: 0.85rem;
            margin-bottom: 16px;
            min-height: 20px;
            text-align: center;
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* 반응형 헤더 */
        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                gap: 12px;
                padding: 12px 20px;
            }

            body {
                padding-top: 130px;
            }

            .brand-section {
                text-align: center;
            }

            .brand-section h1 {
                text-align: center;
                font-size: 1.3rem;
            }

            .brand-section .subtitle {
                text-align: center;
            }

            .auth-modal {
                margin: 20px;
                padding: 32px 24px;
            }
        }

        /* ============================================================
           관리자 버튼 스타일
           ============================================================ */
        .btn-admin {
            background: #7d7d7d;
            color: white;
            border: none;
        }

        .btn-admin:hover {
            background: #5c5c5c;
            box-shadow: 0 2px 8px rgba(125, 125, 125, 0.3);
        }

        /* ============================================================
           회원관리 모달 스타일
           ============================================================ */
        .admin-modal-overlay,
        .edit-user-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }

        .admin-modal-overlay.active,
        .edit-user-modal-overlay.active {
            display: flex;
        }

        .admin-modal {
            background: #ffffff;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .edit-user-modal {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }

        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
        }

        .admin-modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #1a1a1a;
        }

        .admin-stats {
            display: flex;
            gap: 16px;
            padding: 20px 32px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* 관리자 분석 대시보드 */
        .admin-analytics {
            padding: 20px 32px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .analytics-section {
            margin-bottom: 20px;
        }

        .analytics-section:last-child {
            margin-bottom: 0;
        }

        .analytics-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .analytics-card.highlight {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            border: 1px solid rgba(55, 60, 95, 0.1);
        }

        .analytics-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .analytics-value.small {
            font-size: 1rem;
        }

        .analytics-sublabel {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        .analytics-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        /* 인기 검색 종목 */
        .top-searched-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .top-searched-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .top-searched-rank {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-searched-rank.top3 {
            background: var(--accent);
            color: white;
        }

        .top-searched-name {
            flex: 1;
            font-size: 0.8rem;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-searched-count {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .admin-table-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 32px 32px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .admin-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .admin-table tr:hover {
            background: #f9fafb;
        }

        .admin-table .loading-row {
            text-align: center;
            color: #6b7280;
            padding: 40px;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tier-badge.free {
            background: #f4f4f4;
            color: #7d7d7d;
        }

        .tier-badge.basic {
            background: #e6e6e6;
            color: var(--primary);
        }

        .tier-badge.pro {
            background: rgba(180, 145, 50, 0.15);
            color: var(--accent);
        }

        .tier-badge.admin {
            background: rgba(55, 60, 95, 0.15);
            color: var(--primary);
        }

        .usage-info {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
        }

        /* 인라인 편집 스타일 */
        .inline-select {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85rem;
            background: #fafafa;
            cursor: pointer;
            min-width: 80px;
        }

        .inline-select:hover {
            border-color: #d1d5db;
        }

        .inline-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(180, 145, 50, 0.2);
        }

        .inline-select:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .inline-date {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.8rem;
            background: #fafafa;
            width: 130px;
        }

        .inline-date:hover {
            border-color: #d1d5db;
        }

        .inline-date:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(180, 145, 50, 0.2);
        }

        .usage-cell {
            text-align: center;
            font-weight: 600;
            color: #374151;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            padding: 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #fafafa;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-right: 4px;
        }

        .btn-icon:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .btn-icon-danger:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .admin-modal {
                max-height: 95vh;
            }

            .admin-stats {
                flex-wrap: wrap;
            }

            .stat-item {
                flex: 1 1 45%;
            }

            .admin-table {
                font-size: 0.8rem;
            }

            .admin-table th,
            .admin-table td {
                padding: 8px 4px;
            }

            .edit-user-actions {
                flex-direction: column;
            }
        }

        /* ============================================================
           PE 챗봇 스타일
           ============================================================ */

        /* 탭 바 */
        .ci-tabs {
            display: none;
            gap: 8px;
            padding-left: 4px;
            margin-top: 24px;
            margin-bottom: 10px;
        }

        .ci-tabs.show {
            display: flex;
        }

        .ci-tab {
            padding: 6px 14px;
            font-size: 0.8rem;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #9ca3af;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Pretendard', sans-serif;
        }

        .ci-tab:hover {
            background: #f9fafb;
            color: #6b7280;
        }

        .ci-tab.active {
            background: #374151;
            color: #ffffff;
            border-color: #374151;
        }

        .ci-tab.active:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        /* 패널 영역 */
        .ci-panels {
            display: flex;
            gap: 16px;
        }

        .company-info-wrapper.with-chatbot {
            max-width: 1060px;
            padding: 0 20px;
        }

        .company-info-wrapper.with-chatbot .company-info-section {
            flex: 1;
            max-width: none;
            margin: 0;
        }

        .chatbot-section {
            flex: 1;
            min-width: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: var(--ci-height, 500px);
            align-self: flex-start;
        }

        /* 확장 모드: 하나만 선택 시 전체 너비 사용 */
        .ci-panels.expanded-info .chatbot-section {
            display: none !important;
        }
        .ci-panels.expanded-info .company-info-section {
            flex: 1;
            max-width: none;
        }

        .ci-panels.expanded-chat .company-info-section {
            display: none !important;
        }
        .ci-panels.expanded-chat .chatbot-section {
            flex: 1;
            max-width: none;
            height: calc(var(--ci-height, 500px) + 200px);
        }

        .chatbot-header {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .chatbot-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .chatbot-badge {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .chatbot-status {
            margin-left: auto;
            font-size: 0.75rem;
            opacity: 0.8;
            display: none;
        }

        .chatbot-fullscreen-btn {
            margin-left: auto;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .chatbot-fullscreen-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* 챗봇 확장 모드 — 화면 중앙 고정 패널 */
        .chatbot-fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 998;
        }
        .chatbot-fullscreen-overlay.active { display: block; }

        .chatbot-section.fullscreen-mode {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 820px;
            height: 820px;
            z-index: 999;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .chatbot-section.fullscreen-mode {
                width: 95vw;
                height: 80vh;
            }
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chatbot-messages::-webkit-scrollbar {
            width: 4px;
        }
        .chatbot-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chatbot-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .chat-message {
            display: flex;
            max-width: 90%;
        }

        .chat-message.user {
            align-self: flex-end;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.88rem;
            line-height: 1.55;
            word-break: break-word;
        }

        .chat-bubble h1, .chat-bubble h2, .chat-bubble h3, .chat-bubble h4 {
            margin: 12px 0 6px 0;
            font-weight: 600;
        }
        .chat-bubble h1 { font-size: 0.95rem; }
        .chat-bubble h2 { font-size: 0.92rem; border-bottom: 1px solid #dee2e6; padding-bottom: 4px; }
        .chat-bubble h3 { font-size: 0.9rem; }
        .chat-bubble h4 { font-size: 0.88rem; }

        .chat-bubble p {
            margin: 6px 0;
        }

        .chat-bubble ul, .chat-bubble ol {
            margin: 6px 0;
            padding-left: 20px;
            list-style-position: inside;
        }

        .chat-bubble ul {
            list-style-type: disc;
        }

        .chat-bubble ol {
            list-style-type: decimal;
        }

        .chat-bubble li {
            margin: 4px 0;
            text-indent: -20px;
            padding-left: 20px;
        }

        /* 감싸지 않은 li 태그 (ul/ol 없이 직접 나온 경우) */
        .chat-bubble > li {
            list-style: none;
            margin: 6px 0;
            padding-left: 12px;
            border-left: 2px solid var(--primary);
            text-indent: 0;
        }

        .chat-references {
            margin-top: 8px;
            border-top: 1px solid #dee2e6;
            padding-top: 6px;
        }

        .chat-references summary {
            font-size: 0.78rem;
            color: var(--text-medium);
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .chat-references summary:hover {
            color: var(--primary);
        }

        .chat-references .ref-list {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-references .ref-item {
            font-size: 0.75rem;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .chat-references .ref-num {
            color: var(--text-light);
            flex-shrink: 0;
            font-size: 0.7rem;
        }

        .chat-references .ref-item a {
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }

        .chat-references .ref-item a:hover {
            text-decoration: underline;
        }

        .chat-bubble table.md-table {
            font-size: 0.8rem;
            margin: 8px 0;
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #d1d5db;
        }

        .chat-bubble table.md-table th,
        .chat-bubble table.md-table td {
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            text-align: left;
        }

        .chat-bubble table.md-table th {
            background: #e5e7eb;
            font-weight: 600;
        }

        .chat-bubble table.md-table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .chat-bubble strong {
            font-weight: 600;
        }

        .chat-bubble pre {
            background: #e9ecef;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            overflow-x: auto;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .chat-bubble {
            background: #f1f3f5;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-status-msg {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-light);
            padding: 6px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .chat-status-msg .status-dots {
            display: inline-flex;
            gap: 3px;
        }
        .chat-status-msg .status-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-light);
            animation: statusWave 1.4s ease-in-out infinite;
        }
        .chat-status-msg .status-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-status-msg .status-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes statusWave {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .chat-status-msg .spinner {
            display: none;
        }

        .chatbot-input-area {
            border-top: 1px solid var(--border-light);
            padding: 12px;
            flex-shrink: 0;
            background: #fafbfc;
        }

        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .suggestion-btn {
            background: white;
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.75rem;
            color: var(--text-medium);
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Pretendard', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .suggestion-btn .q-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .suggestion-btn .remove-btn {
            font-size: 0.6rem;
            opacity: 0.3;
            cursor: pointer;
            flex-shrink: 0;
        }
        .suggestion-btn .remove-btn:hover { opacity: 1; }

        .suggestion-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chatbot-input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chatbot-input-row textarea {
            flex: 1;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.88rem;
            font-family: 'Pretendard', sans-serif;
            resize: none;
            max-height: 80px;
            line-height: 1.4;
            outline: none;
            transition: border-color 0.15s;
        }

        .chatbot-input-row textarea:focus {
            border-color: var(--primary);
        }

        .chatbot-input-row button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            transition: background 0.15s;
            white-space: nowrap;
            height: 36px;
        }

        .chatbot-input-row button:hover {
            background: var(--primary-dark);
        }

        .chatbot-input-row button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .chat-typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 8px 14px;
            background: #f1f3f5;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
        }

        .chat-typing-indicator span {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: chatTyping 1.2s infinite;
        }

        .chat-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes chatTyping {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* 챗봇 반응형 */
        @media (max-width: 900px) {
            .ci-panels {
                flex-direction: column;
            }

            .company-info-wrapper.with-chatbot .company-info-section {
                flex: none;
                max-width: 100%;
                width: 100%;
            }

            .chatbot-section {
                min-width: unset;
                width: 100%;
                height: 420px;
            }
        }
    </style>
    <!-- Mermaid 다이어그램 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'neutral',
            themeVariables: {
                primaryColor: '#373c5f',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2a2e4a',
                lineColor: '#b49132',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            }
        });
    </script>
</head>
<body>
    <!-- 상단 고정 헤더 -->
    <header class="top-header">
        <div class="header-content">
            <div class="brand-section">
                <h1 onclick="location.reload()" style="cursor: pointer;">Valulens</h1>
                <p class="subtitle">LLM & DART 기반 딥 리서치 플랫폼 밸류랜즈</p>
            </div>
            <div class="user-section" id="userSection">
                <!-- 비로그인 상태 -->
                <div class="user-guest" id="userGuest">
                    <button class="btn btn-outline" onclick="showAuthModal('login')">로그인</button>
                    <button class="btn btn-primary" onclick="showAuthModal('register')">회원가입</button>
                </div>
                <!-- 로그인 상태 -->
                <div class="user-logged-in" id="userLoggedIn" style="display: none;">
                    <div class="user-info">
                        <div class="user-menu-container">
                            <div class="user-menu-trigger" id="userMenuTrigger" onclick="toggleUserMenu()">
                                <span class="user-email" id="userEmail"></span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="user-menu-dropdown" id="userMenuDropdown">
                                <button class="user-menu-item" onclick="showProfileModal()">내 정보</button>
                                <a href="/admin" class="user-menu-item" id="adminMenuItem" style="display: none; text-decoration: none;">회원관리</a>
                                <div class="user-menu-divider"></div>
                                <button class="user-menu-item danger" onclick="logout()">로그아웃</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <span class="user-tier" id="userTier"></span>
                            <span class="user-search-count" id="userSearchCount"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container centered" id="mainContainer">
        <!-- 히어로 태그라인 (초기 상태에서만 표시) -->
        <div class="hero-tagline" id="heroTagline">
            <div class="tagline-main">밸류렌즈</div>
            <div class="tagline-sub">PE Insight Research All In One 플랫폼</div>
        </div>

        <!-- 검색 섹션 (로그인 후에만 표시) -->
        <div class="search-section" id="mainContent" style="display: none;">
            <div class="input-group">
                <input type="text" id="companyInput" placeholder="기업명을 입력하세요 (예: 삼성전자)" />
                <button class="btn btn-primary" id="searchBtn" onclick="searchCompany()">검색</button>
            </div>
            
            <!-- 검색 히스토리 -->
            <div class="search-history" id="searchHistory"></div>
            
            <div class="search-results" id="searchResults"></div>
            
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <!-- 진행 상태 섹션 -->
        <div class="progress-section" id="progressSection">
            <div class="selected-company">
                <span class="selected-company-name" id="selectedCompanyName"></span>
                <button class="btn btn-danger" onclick="resetAll()">✕</button>
            </div>
            
            <div class="year-selection">
                <label>시작 연도:</label>
                <select id="startYear"></select>
                <label>~ 종료 연도:</label>
                <select id="endYear"></select>
                <button class="btn btn-secondary" id="extractBtn" onclick="startExtraction(true)" title="AI분석과 재무제표 분석이 모두 한번에 진행됩니다.">통합추출</button>
            </div>
        </div>

        <!-- 추출 진행 섹션 -->
        <div class="progress-section" id="extractingSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <p class="progress-message" id="progressMessage">준비 중...</p>
            <div class="action-buttons">
                <button class="btn btn-danger" id="cancelBtn" onclick="cancelExtraction()">취소</button>
            </div>
        </div>
    </div>

    <!-- 기업개황정보 + 챗봇 (container 밖 — 넓은 레이아웃) -->
    <div class="company-info-wrapper" id="companyInfoWrapper" style="display: none;">
        <!-- 탭 바 -->
        <div class="ci-tabs" id="ciTabs">
            <button class="ci-tab active" data-ci-panel="info" onclick="toggleCiPanel('info')">기업개황</button>
            <button class="ci-tab" data-ci-panel="chat" onclick="toggleCiPanel('chat')" disabled style="opacity:0.5; cursor:not-allowed;">AI 어시스턴트</button>
        </div>

        <!-- 패널 영역 -->
        <div class="ci-panels expanded-info" id="ciPanels">
            <div class="company-info-section" id="companyInfoSection">
                <h3 class="company-info-title" onclick="toggleCompanyInfo()">
                    <span>기업개황정보</span>
                    <span style="font-size: 0.75rem; font-weight: normal; color: #9ca3af; margin-left: 12px;">대표자와 주소는 통합 추출 이후에 최신정보를 반영하여 업데이트 됩니다.</span>
                    <span class="company-info-toggle" id="companyInfoToggle">접기 ▲</span>
                </h3>
                <div class="company-info-content" id="companyInfoContent">
                    <div class="company-info-loading" id="companyInfoLoading">
                        <span class="spinner"></span> 기업정보 로딩 중...
                    </div>
                    <table class="company-info-table" id="companyInfoTable" style="display: none;">
                        <tbody id="companyInfoBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 챗봇 확장 오버레이 배경 -->
            <div class="chatbot-fullscreen-overlay" id="chatFullscreenOverlay" onclick="toggleChatFullscreen()"></div>
            <!-- PE 챗봇 섹션 -->
            <div class="chatbot-section" id="chatbotSection" style="display: none;">
                <div class="chatbot-header">
                    <span class="chatbot-title">AI 어시스턴트</span>
                    <span class="chatbot-badge">PE 전문</span>
                    <span class="chatbot-status" id="chatbotStatus">대기 중</span>
                    <button class="chatbot-fullscreen-btn" id="chatFullscreenBtn" onclick="toggleChatFullscreen()">&#x26F6; 전체 화면</button>
                </div>
                <div class="chatbot-messages" id="chatbotMessages">
                    <div class="chat-message assistant">
                        <div class="chat-bubble">
                            안녕하세요! 재무 데이터를 분석할 준비가 되었습니다. PE 관점의 분석이 필요하시면 무엇이든 물어보세요.
                        </div>
                    </div>
                </div>
                <div class="chatbot-input-area">
                    <div class="chatbot-suggestions" id="chatbotSuggestions"></div>
                    <div class="chatbot-input-row">
                        <textarea id="chatInput" placeholder="질문을 입력하세요..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
                        <button id="chatSendBtn" onclick="sendChatMessage()">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 확장 영역 (결과) -->
    <div class="container-full" id="resultContainer">
        <!-- 완료 섹션 -->
        <div class="complete-section" id="completeSection">
            <!-- 분석 진행 상태 메시지 -->
            <div class="analysis-status-message" id="analysisStatusMessage" style="display: none;">
                <span class="status-icon">⏳</span>
                <span class="status-text" id="analysisStatusText">재무분석 AI는 평균 2~3분 이내, 기업 리서치는 최대 10분 내외 소요될 수 있습니다.</span>
            </div>
            <!-- 상위 탭 메뉴 -->
            <div class="main-tabs-container">
                <div class="main-tabs">
                    <button class="main-tab active" data-main-tab="financials" onclick="showMainTab('financials')">Financials</button>
                    <button class="main-tab" data-main-tab="financial" onclick="showMainTab('financial')">재무 상세</button>
                    <span class="hover-tooltip-wrapper super-research-tab-wrapper" style="display: none;">
                        <button class="main-tab" data-main-tab="superResearch" id="superResearchTabBtn" onclick="showMainTab('superResearch')">기업 리서치</button>
                        <div class="hover-tooltip hidden" id="superResearchTooltip">기업 리서치는 최대 10분 내외 소요될 수 있습니다.</div>
                    </span>
                </div>
                <div class="download-btn-wrapper" id="downloadBtnWrapper">
                    <button class="btn btn-success" id="downloadBtn" onclick="downloadFile()" disabled>엑셀 다운로드</button>
                    <div class="hover-tooltip" id="downloadTooltip">재무분석 AI 작업이 완료되면 다운로드가 가능합니다.</div>
                </div>
            </div>

            <!-- Financials 서브 탭 (vcm-box 토글) -->
            <div class="vcm-sub-tabs" id="vcmSubTabs">
                <button class="vcm-sub-tab active" data-vcm-box="bs" onclick="toggleVcmBox('bs')">재무상태표</button>
                <button class="vcm-sub-tab active" data-vcm-box="is" onclick="toggleVcmBox('is')">손익계산서</button>
                <span class="vcm-ai-tooltip-wrapper">
                    <button class="vcm-sub-tab" data-vcm-box="ai" onclick="toggleVcmBox('ai')">재무분석 AI</button>
                    <div class="vcm-ai-tooltip hidden" id="vcmAiTooltip">분석 작업은 약 1~3분 정도 소요됩니다.</div>
                </span>
            </div>

            <!-- Financials 탭 콘텐츠 (VCM) -->
            <div class="main-tab-content active" id="financialsTabContent">
                <div class="financials-content" id="financialsContent">
                    <p class="preview-placeholder">데이터 로딩 중...</p>
                </div>
            </div>

            <!-- 기업 리서치 탭 콘텐츠 -->
            <div class="main-tab-content" id="superResearchTabContent">
                <div class="super-research-section" id="superResearchSection">
                    <div class="analysis-header" id="superResearchHeader" style="display: none;">
                        <button class="btn btn-copy" id="superResearchCopyBtn" onclick="copySuperResearchResult()" style="display: none;">복사</button>
                    </div>
                    <div class="analysis-progress" id="superResearchProgress" style="display: none;">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="superResearchProgressBar">0%</div>
                        </div>
                        <p class="analysis-message" id="superResearchMessage">리서치 준비 중...</p>
                    </div>
                    <div class="analysis-result super-research-result" id="superResearchResult" style="display: none;"></div>
                </div>
            </div>

            <!-- 재무분석 AI 탭 콘텐츠 -->
            <div class="main-tab-content" id="insightTabContent">
                <div class="analysis-section" id="analysisSection">
                    <div class="analysis-header">
                        <span class="analysis-status" id="analysisStatus"></span>
                        <button class="btn btn-copy" id="analysisCopyBtn" onclick="copyAnalysisResult()" style="display: none;">복사</button>
                        <button class="btn btn-copy" id="analysisOriginalBtn" onclick="toggleOriginalReport()" style="display: none;">원본보기</button>
                    </div>
                    <!-- AI 분석 시작 버튼 (재무제표만 추출 시 표시) -->
                    <div class="analysis-start-container" id="analysisStartContainer" style="display: none;">
                        <p class="analysis-start-description">재무제표 데이터를 기반으로 AI가 이상 패턴을 분석하고 인사이트를 제공합니다.</p>
                        <button class="btn btn-ai btn-large" id="analyzeBtn" onclick="startAnalysis()">재무분석 AI 분석 시작</button>
                    </div>
                    <div class="analysis-progress" id="analysisProgress" style="display: none;">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="analysisProgressBar">0%</div>
                        </div>
                        <p class="analysis-message" id="analysisMessage">분석 준비 중...</p>
                    </div>
                    <div class="analysis-result" id="analysisResult" style="display: none;"></div>
                </div>
            </div>

            <!-- 재무정보 탭 콘텐츠 -->
            <div class="main-tab-content" id="financialTabContent">
                <div class="preview-section" id="previewSection">
                    <div class="preview-tabs">
                        <button class="preview-tab active" data-tab="bs" onclick="togglePreviewTab('bs')">재무상태표</button>
                        <button class="preview-tab active" data-tab="is" onclick="togglePreviewTab('is')">손익계산서</button>
                        <button class="preview-tab" data-tab="cf" onclick="togglePreviewTab('cf')">현금흐름표</button>
                    </div>
                    <div class="preview-content" id="previewContent">
                        <p class="preview-placeholder">데이터 로딩 중...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 로그인/회원가입 모달 -->
    <div class="auth-modal-overlay" id="authModalOverlay" onclick="closeAuthModal(event)">
        <div class="auth-modal" onclick="event.stopPropagation()">
            <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>

            <!-- 로그인 폼 -->
            <div class="auth-form" id="loginForm">
                <div class="auth-logo">Valulens</div>
                <h2>로그인</h2>
                <p class="auth-subtitle">LLM & DART 기반 딥 리서치 플랫폼</p>

                <div class="auth-input-group">
                    <label for="loginEmail">이메일</label>
                    <input type="email" id="loginEmail" placeholder="email@example.com" />
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">비밀번호</label>
                    <input type="password" id="loginPassword" placeholder="비밀번호 입력" />
                </div>

                <div class="auth-error" id="loginError"></div>

                <button class="btn btn-primary btn-full" id="loginSubmitBtn" onclick="submitLogin()">로그인</button>

                <p class="auth-switch">
                    계정이 없으신가요? <a href="#" onclick="switchAuthForm('register')">회원가입</a>
                </p>
            </div>

            <!-- 회원가입 폼 -->
            <div class="auth-form" id="registerForm" style="display: none;">
                <div class="auth-logo">Valulens</div>
                <h2>회원가입</h2>
                <p class="auth-subtitle">무료로 시작하세요</p>

                <div class="auth-input-group">
                    <label for="registerEmail">이메일</label>
                    <input type="email" id="registerEmail" placeholder="email@example.com" />
                </div>
                <div class="auth-input-group">
                    <label for="registerPassword">비밀번호</label>
                    <input type="password" id="registerPassword" placeholder="6자 이상 입력" />
                </div>
                <div class="auth-input-group">
                    <label for="registerPasswordConfirm">비밀번호 확인</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="비밀번호 재입력" />
                </div>

                <div class="auth-error" id="registerError"></div>

                <button class="btn btn-primary btn-full" id="registerSubmitBtn" onclick="submitRegister()">회원가입</button>

                <p class="auth-switch">
                    이미 계정이 있으신가요? <a href="#" onclick="switchAuthForm('login')">로그인</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 내 정보 모달 -->
    <div class="profile-modal-overlay" id="profileModalOverlay" onclick="closeProfileModal(event)">
        <div class="profile-modal" onclick="event.stopPropagation()">
            <div class="profile-modal-header">
                <h2>내 정보</h2>
                <button class="auth-modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="profile-modal-body">
                <!-- 계정 정보 -->
                <div class="profile-section">
                    <div class="profile-section-title">계정 정보</div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">이메일</span>
                        <span class="profile-info-value" id="profileEmail">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">등급</span>
                        <span class="profile-info-value" id="profileTier">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">잔여 검색횟수</span>
                        <span class="profile-info-value" id="profileSearchCount">-</span>
                    </div>
                </div>

                <!-- 이용권 정보 -->
                <div class="profile-section">
                    <div class="profile-section-title">이용권 정보</div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">시작일</span>
                        <span class="profile-info-value" id="profileStartDate">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">만료일</span>
                        <span class="profile-info-value" id="profileEndDate">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">가입일</span>
                        <span class="profile-info-value" id="profileCreatedAt">-</span>
                    </div>
                </div>

                <!-- 비밀번호 변경 -->
                <div class="profile-section">
                    <button class="btn btn-outline" onclick="togglePasswordChange()" id="passwordChangeBtn" style="width: 100%;">비밀번호 변경</button>
                    <div id="passwordChangeForm" style="display: none; margin-top: 16px;">
                        <div class="profile-form-group">
                            <label>현재 비밀번호</label>
                            <input type="password" id="currentPassword" placeholder="현재 비밀번호 입력">
                        </div>
                        <div class="profile-form-group">
                            <label>새 비밀번호</label>
                            <input type="password" id="newPassword" placeholder="새 비밀번호 입력">
                        </div>
                        <div class="profile-form-group">
                            <label>새 비밀번호 확인</label>
                            <input type="password" id="confirmPassword" placeholder="새 비밀번호 다시 입력">
                        </div>
                        <div class="profile-btn-row">
                            <button class="btn btn-outline" onclick="togglePasswordChange()">취소</button>
                            <button class="btn btn-primary" onclick="changePassword()">변경</button>
                        </div>
                        <div class="profile-message" id="passwordMessage" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 회원관리 모달 (관리자 전용) -->
    <div class="admin-modal-overlay" id="adminModalOverlay" onclick="closeAdminModal(event)">
        <div class="admin-modal" onclick="event.stopPropagation()">
            <div class="admin-modal-header">
                <h2>회원관리</h2>
                <button class="auth-modal-close" onclick="closeAdminModal()">&times;</button>
            </div>

            <div class="admin-stats" id="adminStats">
                <div class="stat-item">
                    <span class="stat-value" id="statTotalUsers">-</span>
                    <span class="stat-label">전체 회원</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statProUsers">-</span>
                    <span class="stat-label">Pro 회원</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statBasicUsers">-</span>
                    <span class="stat-label">Basic 회원</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statFreeUsers">-</span>
                    <span class="stat-label">Free 회원</span>
                </div>
            </div>

            <!-- 분석 대시보드 -->
            <div class="admin-analytics" id="adminAnalytics">
                <!-- 활성 사용자 & 리텐션 -->
                <div class="analytics-section">
                    <div class="analytics-section-title">활성 사용자 & 리텐션</div>
                    <div class="analytics-grid">
                        <div class="analytics-card highlight">
                            <div class="analytics-value" id="statDAU">-</div>
                            <div class="analytics-label">DAU (오늘)</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statWAU">-</div>
                            <div class="analytics-label">WAU (7일)</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statMAU">-</div>
                            <div class="analytics-label">MAU (30일)</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value small" id="statRetention7d">-</div>
                            <div class="analytics-label">리텐션 7일</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value small" id="statRetention30d">-</div>
                            <div class="analytics-label">리텐션 30일</div>
                        </div>
                    </div>
                </div>

                <!-- API 사용량 -->
                <div class="analytics-section">
                    <div class="analytics-section-title">API 사용량</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="statTokensTotal">-</div>
                            <div class="analytics-label">전체</div>
                        </div>
                        <div class="analytics-card highlight">
                            <div class="analytics-value" id="statTokensWeek">-</div>
                            <div class="analytics-label">이번 주</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statTokensToday">-</div>
                            <div class="analytics-label">오늘</div>
                        </div>
                    </div>
                </div>

                <!-- 추출 & AI 분석 -->
                <div class="analytics-section">
                    <div class="analytics-section-title">추출 & 검색 현황</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="statExtractionsTotal">-</div>
                            <div class="analytics-sublabel">전체</div>
                            <div class="analytics-label">추출</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statExtractionsWeek">-</div>
                            <div class="analytics-sublabel">이번 주</div>
                            <div class="analytics-label">추출</div>
                        </div>
                        <div class="analytics-card highlight">
                            <div class="analytics-value" id="statExtractionsToday">-</div>
                            <div class="analytics-sublabel">오늘</div>
                            <div class="analytics-label">추출</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statSearchesTotal">-</div>
                            <div class="analytics-sublabel">전체</div>
                            <div class="analytics-label">검색</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statSearchesWeek">-</div>
                            <div class="analytics-sublabel">이번 주</div>
                            <div class="analytics-label">검색</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="statAITotal">-</div>
                            <div class="analytics-sublabel">전체</div>
                            <div class="analytics-label">AI분석</div>
                        </div>
                    </div>
                </div>

                <!-- 인기 검색 종목 -->
                <div class="analytics-section">
                    <div class="analytics-section-title">인기 검색 종목 (최근 30일)</div>
                    <div class="top-searched-list" id="topSearchedList">
                        <div class="top-searched-item">
                            <span class="top-searched-name" style="color: #9ca3af;">로딩 중...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-table-container">
                <table class="admin-table" id="adminUserTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>이메일</th>
                            <th>등급</th>
                            <th>마지막 접속</th>
                            <th>API 사용</th>
                            <th>일평균</th>
                            <th>주간</th>
                            <th>만료일</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="adminUserTableBody">
                        <tr><td colspan="9" class="loading-row">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // 전역 변수
        // ============================================================
        let currentUser = null;   // 현재 로그인한 사용자
        let selectedCorp = null;  // 선택된 기업 정보
        let currentTaskId = null;  // 현재 작업 ID
        let currentFilename = null;  // 현재 파일명 (다운로드용)
        let statusCheckInterval = null;  // 상태 확인 인터벌
        let heartbeatInterval = null;  // heartbeat 인터벌 (작업 유지용)
        let previewData = null;  // 미리보기 데이터
        let isIntegratedMode = false;  // 통합추출 모드 (AI 분석 자동 실행)
        let isExtractionComplete = false;  // 추출 완료 여부 (중복 호출 방지)
        let isAnalysisCompleted = false;  // AI 분석 완료 여부
        let isSuperResearchCompleted = false;  // 기업 리서치 완료 여부
        let superResearchData = null;  // 기업 리서치 결과 데이터
        let superResearchCheckInterval = null;  // 기업 리서치 상태 확인 인터벌

        // ============================================================
        // 인증 관련 함수
        // ============================================================

        // 모달 열기
        function showAuthModal(type) {
            const overlay = document.getElementById('authModalOverlay');
            overlay.classList.add('active');
            switchAuthForm(type);
        }

        // 모달 닫기 (로그인 상태에서만 가능)
        function closeAuthModal(event) {
            if (event && event.target !== event.currentTarget) return;
            // 비로그인 상태에서는 닫을 수 없음
            if (!currentUser) return;

            const overlay = document.getElementById('authModalOverlay');
            overlay.classList.remove('active');
            // 에러 메시지 초기화
            document.getElementById('loginError').textContent = '';
            document.getElementById('registerError').textContent = '';
        }

        // 폼 전환
        function switchAuthForm(type) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (type === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        // 로그인 제출
        async function submitLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginSubmitBtn');

            errorEl.textContent = '';

            if (!email || !password) {
                errorEl.textContent = '이메일과 비밀번호를 입력해주세요.';
                return;
            }

            btn.disabled = true;
            btn.textContent = '로그인 중...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.detail || '로그인에 실패했습니다.';
                    return;
                }

                // 성공 - 전체 사용자 정보(검색횟수 포함) 가져오기
                await checkAuth();
                closeAuthModal();

                // 입력 필드 초기화
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';

            } catch (err) {
                console.error('Login error:', err);
                errorEl.textContent = '서버 연결에 실패했습니다.';
            } finally {
                btn.disabled = false;
                btn.textContent = '로그인';
            }
        }

        // 회원가입 제출
        async function submitRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const errorEl = document.getElementById('registerError');
            const btn = document.getElementById('registerSubmitBtn');

            errorEl.textContent = '';

            if (!email || !password || !passwordConfirm) {
                errorEl.textContent = '모든 필드를 입력해주세요.';
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = '비밀번호가 일치하지 않습니다.';
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = '비밀번호는 6자 이상이어야 합니다.';
                return;
            }

            btn.disabled = true;
            btn.textContent = '가입 중...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.detail || '회원가입에 실패했습니다.';
                    return;
                }

                // 성공 - 자동 로그인
                alert('회원가입이 완료되었습니다! 로그인해주세요.');
                switchAuthForm('login');
                document.getElementById('loginEmail').value = email;

                // 입력 필드 초기화
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerPasswordConfirm').value = '';

            } catch (err) {
                console.error('Register error:', err);
                errorEl.textContent = '서버 연결에 실패했습니다.';
            } finally {
                btn.disabled = false;
                btn.textContent = '회원가입';
            }
        }

        // 로그아웃
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
            } catch (err) {
                console.error('Logout error:', err);
            }
            currentUser = null;
            closeUserMenu();
            updateUserUI();
        }

        // 사용자 메뉴 토글
        function toggleUserMenu() {
            const trigger = document.getElementById('userMenuTrigger');
            const dropdown = document.getElementById('userMenuDropdown');
            const isOpen = dropdown.classList.toggle('show');
            trigger.classList.toggle('open', isOpen);
        }

        function closeUserMenu() {
            const trigger = document.getElementById('userMenuTrigger');
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.remove('show');
            trigger.classList.remove('open');
        }

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            const menuContainer = document.querySelector('.user-menu-container');
            if (menuContainer && !menuContainer.contains(e.target)) {
                closeUserMenu();
            }
        });

        // 내 정보 모달
        function showProfileModal() {
            closeUserMenu();
            const overlay = document.getElementById('profileModalOverlay');
            overlay.classList.add('show');

            // 사용자 정보 채우기
            if (currentUser) {
                document.getElementById('profileEmail').textContent = currentUser.email;

                const tierNames = { free: 'Free', basic: 'Basic', pro: 'Pro' };
                document.getElementById('profileTier').textContent = tierNames[currentUser.tier] || currentUser.tier;

                if (currentUser.role === 'admin') {
                    document.getElementById('profileSearchCount').textContent = '무제한';
                } else {
                    const sc = currentUser.search_count !== null && currentUser.search_count !== undefined ? currentUser.search_count : 0;
                    document.getElementById('profileSearchCount').textContent = sc + '회';
                }

                // 이용권 정보
                document.getElementById('profileStartDate').textContent = currentUser.subscription_start || '-';
                document.getElementById('profileEndDate').textContent = currentUser.subscription_end || '-';
                document.getElementById('profileCreatedAt').textContent = currentUser.created_at ? currentUser.created_at.split('T')[0] : '-';
            }

            // 비밀번호 변경 폼 숨기기 및 초기화
            document.getElementById('passwordChangeBtn').style.display = 'block';
            document.getElementById('passwordChangeForm').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordMessage').style.display = 'none';
        }

        function closeProfileModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('profileModalOverlay').classList.remove('show');
        }

        function togglePasswordChange() {
            const btn = document.getElementById('passwordChangeBtn');
            const form = document.getElementById('passwordChangeForm');
            const isHidden = form.style.display === 'none';

            btn.style.display = isHidden ? 'none' : 'block';
            form.style.display = isHidden ? 'block' : 'none';

            // 폼 숨길 때 초기화
            if (!isHidden) {
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('passwordMessage').style.display = 'none';
            }
        }

        // 비밀번호 변경
        async function changePassword() {
            const currentPw = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            const confirmPw = document.getElementById('confirmPassword').value;
            const messageEl = document.getElementById('passwordMessage');

            messageEl.style.display = 'none';

            if (!currentPw || !newPw || !confirmPw) {
                messageEl.textContent = '모든 필드를 입력해주세요.';
                messageEl.className = 'profile-message error';
                messageEl.style.display = 'block';
                return;
            }

            if (newPw !== confirmPw) {
                messageEl.textContent = '새 비밀번호가 일치하지 않습니다.';
                messageEl.className = 'profile-message error';
                messageEl.style.display = 'block';
                return;
            }

            if (newPw.length < 6) {
                messageEl.textContent = '비밀번호는 6자 이상이어야 합니다.';
                messageEl.className = 'profile-message error';
                messageEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPw,
                        new_password: newPw
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    messageEl.textContent = data.detail || '비밀번호 변경에 실패했습니다.';
                    messageEl.className = 'profile-message error';
                    messageEl.style.display = 'block';
                    return;
                }

                messageEl.textContent = '비밀번호가 변경되었습니다.';
                messageEl.className = 'profile-message success';
                messageEl.style.display = 'block';

                // 필드 초기화
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

            } catch (err) {
                console.error('Change password error:', err);
                messageEl.textContent = '서버 연결에 실패했습니다.';
                messageEl.className = 'profile-message error';
                messageEl.style.display = 'block';
            }
        }

        // 현재 로그인 상태 확인
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.logged_in) {
                    currentUser = data.user;
                } else {
                    currentUser = null;
                }
                updateUserUI();
            } catch (err) {
                console.error('Auth check error:', err);
                currentUser = null;
                updateUserUI();
            }
        }

        // 사용자 UI 업데이트
        function updateUserUI() {
            const guestEl = document.getElementById('userGuest');
            const loggedInEl = document.getElementById('userLoggedIn');
            const emailEl = document.getElementById('userEmail');
            const tierEl = document.getElementById('userTier');
            const searchCountEl = document.getElementById('userSearchCount');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('authModalOverlay');
            const closeBtn = document.querySelector('.auth-modal-close');
            const adminMenuItem = document.getElementById('adminMenuItem');

            if (currentUser) {
                // 로그인 상태
                guestEl.style.display = 'none';
                loggedInEl.style.display = 'flex';
                emailEl.textContent = currentUser.email;

                // 등급 표시
                const tierNames = { free: 'Free', basic: 'Basic', pro: 'Pro' };
                tierEl.textContent = tierNames[currentUser.tier] || currentUser.tier;
                tierEl.className = 'user-tier ' + currentUser.tier;

                // 검색횟수 표시 (관리자는 무제한)
                if (currentUser.role === 'admin') {
                    searchCountEl.textContent = '검색횟수: ∞';
                    searchCountEl.className = 'user-search-count';
                } else {
                    const sc = currentUser.search_count !== null && currentUser.search_count !== undefined ? currentUser.search_count : 0;
                    searchCountEl.textContent = `검색횟수: ${sc}`;
                    searchCountEl.className = sc <= 3 ? 'user-search-count low' : 'user-search-count';
                }

                // 관리자 메뉴 표시/숨김
                if (currentUser.role === 'admin') {
                    adminMenuItem.style.display = 'block';
                } else {
                    adminMenuItem.style.display = 'none';
                }

                // 메인 콘텐츠 표시
                mainContent.style.display = 'block';

                // 모달 닫기
                overlay.classList.remove('active');
                closeBtn.style.display = 'flex';
            } else {
                // 비로그인 상태
                guestEl.style.display = 'flex';
                loggedInEl.style.display = 'none';
                adminMenuItem.style.display = 'none';

                // 메인 콘텐츠 숨김
                mainContent.style.display = 'none';

                // 로그인 모달 자동 표시 (닫기 버튼 숨김)
                overlay.classList.add('active');
                closeBtn.style.display = 'none';
                switchAuthForm('login');
            }
        }

        // ============================================================
        // 회원관리 기능 (관리자 전용)
        // ============================================================
        function showAdminModal() {
            const overlay = document.getElementById('adminModalOverlay');
            overlay.classList.add('active');
            loadUserList();
        }

        function closeAdminModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('adminModalOverlay');
            overlay.classList.remove('active');
        }

        async function loadUserList() {
            const tbody = document.getElementById('adminUserTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="loading-row">로딩 중...</td></tr>';

            try {
                // 사용자 목록과 분석 데이터를 병렬로 로드
                const [usersResponse, analyticsResponse] = await Promise.all([
                    fetch('/api/admin/users'),
                    fetch('/api/admin/analytics')
                ]);

                if (!usersResponse.ok) {
                    throw new Error('권한이 없습니다');
                }

                const usersData = await usersResponse.json();
                const users = usersData.users || [];

                // 분석 데이터 업데이트
                if (analyticsResponse.ok) {
                    const analyticsData = await analyticsResponse.json();
                    const a = analyticsData.analytics || {};

                    // 활성 사용자 & 리텐션
                    document.getElementById('statDAU').textContent = a.dau || 0;
                    document.getElementById('statWAU').textContent = a.wau || 0;
                    document.getElementById('statMAU').textContent = a.mau || 0;
                    document.getElementById('statRetention7d').textContent = (a.retention_7d || 0) + '%';
                    document.getElementById('statRetention30d').textContent = (a.retention_30d || 0) + '%';

                    // API 사용량 (숫자 포맷팅)
                    const formatNum = (n) => n ? n.toLocaleString() : '0';
                    document.getElementById('statTokensTotal').textContent = formatNum(a.tokens_total);
                    document.getElementById('statTokensWeek').textContent = formatNum(a.tokens_week);
                    document.getElementById('statTokensToday').textContent = formatNum(a.tokens_today);

                    // 추출 & 검색
                    document.getElementById('statExtractionsTotal').textContent = formatNum(a.extractions_total);
                    document.getElementById('statExtractionsWeek').textContent = formatNum(a.extractions_week);
                    document.getElementById('statExtractionsToday').textContent = formatNum(a.extractions_today);
                    document.getElementById('statSearchesTotal').textContent = formatNum(a.searches_total);
                    document.getElementById('statSearchesWeek').textContent = formatNum(a.searches_week);
                    document.getElementById('statAITotal').textContent = formatNum(a.ai_analyses_total);

                    // 인기 검색 종목
                    const topList = document.getElementById('topSearchedList');
                    const topSearched = a.top_searched || [];
                    if (topSearched.length > 0) {
                        topList.innerHTML = topSearched.map((item, idx) => `
                            <div class="top-searched-item">
                                <span class="top-searched-rank ${idx < 3 ? 'top3' : ''}">${idx + 1}</span>
                                <span class="top-searched-name" title="${item.corp_name}">${item.corp_name}</span>
                                <span class="top-searched-count">${item.count}회</span>
                            </div>
                        `).join('');
                    } else {
                        topList.innerHTML = '<div class="top-searched-item"><span class="top-searched-name" style="color: #9ca3af;">검색 기록 없음</span></div>';
                    }
                }

                // 회원 통계 업데이트
                document.getElementById('statTotalUsers').textContent = users.length;
                document.getElementById('statProUsers').textContent = users.filter(u => u.tier === 'pro').length;
                document.getElementById('statBasicUsers').textContent = users.filter(u => u.tier === 'basic').length;
                document.getElementById('statFreeUsers').textContent = users.filter(u => u.tier === 'free').length;

                // 테이블 렌더링
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="loading-row">등록된 회원이 없습니다</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => {
                    const isAdmin = user.role === 'admin';
                    const subEnd = user.expires_at ? user.expires_at.split('T')[0] : '-';

                    // 마지막 접속 시간 포맷팅
                    let lastLoginText = '-';
                    let lastLoginTitle = '';
                    if (user.last_login) {
                        const lastLogin = new Date(user.last_login);
                        const now = new Date();
                        const diffMs = now - lastLogin;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor(diffMs / (1000 * 60));

                        if (diffMins < 60) {
                            lastLoginText = diffMins + '분 전';
                        } else if (diffHours < 24) {
                            lastLoginText = diffHours + '시간 전';
                        } else if (diffDays < 30) {
                            lastLoginText = diffDays + '일 전';
                        } else {
                            lastLoginText = lastLogin.toLocaleDateString('ko-KR');
                        }
                        lastLoginTitle = lastLogin.toLocaleString('ko-KR');
                    }

                    return `
                        <tr data-user-id="${user.id}">
                            <td>${user.id}</td>
                            <td>${user.email}${isAdmin ? ' <span class="tier-badge admin">Admin</span>' : ''}</td>
                            <td>
                                <select class="inline-select" onchange="updateUserField(${user.id}, 'tier', this.value)" ${isAdmin ? 'disabled' : ''}>
                                    <option value="free" ${user.tier === 'free' ? 'selected' : ''}>Free</option>
                                    <option value="basic" ${user.tier === 'basic' ? 'selected' : ''}>Basic</option>
                                    <option value="pro" ${user.tier === 'pro' ? 'selected' : ''}>Pro</option>
                                </select>
                            </td>
                            <td title="${lastLoginTitle}">${lastLoginText}</td>
                            <td class="usage-cell">${(user.total_tokens_used || 0).toLocaleString()}</td>
                            <td class="usage-cell">${user.daily_avg_tokens || 0}</td>
                            <td class="usage-cell">${(user.weekly_tokens_used || 0).toLocaleString()}</td>
                            <td>${subEnd}</td>
                            <td>
                                <button class="btn-icon" onclick="resetUserUsageById(${user.id})" title="사용량 초기화">↺</button>
                                ${!isAdmin ? `<button class="btn-icon btn-icon-danger" onclick="deleteUserById(${user.id})" title="삭제">✕</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('Load users error:', err);
                tbody.innerHTML = '<tr><td colspan="9" class="loading-row">회원 목록을 불러올 수 없습니다</td></tr>';
            }
        }

        // 인라인 필드 업데이트
        async function updateUserField(userId, field, value) {
            try {
                const body = {};
                body[field] = value || null;

                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || '수정 실패');
                }

                // 등급 변경 시 통계 새로고침
                if (field === 'tier') {
                    loadUserList();
                }

            } catch (err) {
                alert('오류: ' + err.message);
                loadUserList();  // 실패 시 원래 값으로 복원
            }
        }

        // 사용량 초기화
        async function resetUserUsageById(userId) {
            if (!confirm('이 회원의 사용량을 초기화하시겠습니까?')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-usage`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || '초기화 실패');
                }

                loadUserList();

            } catch (err) {
                alert('오류: ' + err.message);
            }
        }

        // 회원 삭제
        async function deleteUserById(userId) {
            if (!confirm('정말로 이 회원을 삭제하시겠습니까?\n관련된 모든 데이터가 삭제됩니다.')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || '삭제 실패');
                }

                loadUserList();

            } catch (err) {
                alert('오류: ' + err.message);
            }
        }

        // Enter 키로 폼 제출
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const overlay = document.getElementById('authModalOverlay');
                if (overlay.classList.contains('active')) {
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm.style.display !== 'none') {
                        submitLogin();
                    } else {
                        submitRegister();
                    }
                }
            }
        });

        // ============================================================
        // 초기화
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            // 로그인 상태 확인
            checkAuth();
            // 연도 선택 옵션 생성
            const currentYear = new Date().getFullYear();
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            
            // 시작 연도: 5년 전부터 2015년까지
            const defaultStartYear = currentYear - 5;
            for (let year = currentYear; year >= 2015; year--) {
                startYearSelect.add(new Option(year, year));
                endYearSelect.add(new Option(year, year));
            }
            
            // 기본값: 5년 전 ~ 현재
            startYearSelect.value = defaultStartYear;
            endYearSelect.value = currentYear;
            
            // Enter 키로 검색
            document.getElementById('companyInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCompany();
                }
            });
            
            // 브라우저 종료 시 작업 취소
            window.addEventListener('beforeunload', function(e) {
                if (currentTaskId) {
                    cancelExtraction();
                }
            });
        });
        
        // ============================================================
        // 검색 히스토리 (로컬 스토리지)
        // ============================================================
        const HISTORY_KEY = 'pe_search_history';
        const MAX_HISTORY = 4;
        
        function getSearchHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            } catch {
                return [];
            }
        }
        
        function saveSearchHistory(history) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }
        
        function addToHistory(companyName) {
            let history = getSearchHistory();
            // 중복 제거
            history = history.filter(h => h !== companyName);
            // 맨 앞에 추가
            history.unshift(companyName);
            // 최대 5개 유지
            if (history.length > MAX_HISTORY) {
                history = history.slice(0, MAX_HISTORY);
            }
            saveSearchHistory(history);
            renderSearchHistory();
        }
        
        function removeFromHistory(companyName) {
            let history = getSearchHistory();
            history = history.filter(h => h !== companyName);
            saveSearchHistory(history);
            renderSearchHistory();
        }
        
        function renderSearchHistory() {
            const container = document.getElementById('searchHistory');
            const history = getSearchHistory();
            
            if (history.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = history.map(name => `
                <div class="history-item">
                    <span class="history-name" onclick="useHistoryItem('${name}')">${name}</span>
                    <span class="history-remove" onclick="event.stopPropagation(); removeFromHistory('${name}')">✕</span>
                </div>
            `).join('');
        }
        
        function useHistoryItem(companyName) {
            document.getElementById('companyInput').value = companyName;
            searchCompany();
        }
        
        // 페이지 로드 시 히스토리 렌더링
        document.addEventListener('DOMContentLoaded', function() {
            renderSearchHistory();
        });

        // 윈도우 리사이즈 시 AI 박스 높이 재조정
        window.addEventListener('resize', function() {
            updateAiBoxHeight();
        });

        // ============================================================
        // 기업 검색
        // ============================================================
        async function searchCompany() {
            const companyName = document.getElementById('companyInput').value.trim();
            if (!companyName) {
                showError('기업명을 입력해주세요.');
                return;
            }
            
            // 검색 히스토리에 추가
            addToHistory(companyName);
            
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner"></span>검색 중...';
            
            hideError();
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_name: companyName })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '검색 실패');
                }
                
                displaySearchResults(data.data);
                
            } catch (error) {
                showError(error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '검색';
            }
        }
        
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="result-item">검색 결과가 없습니다.</div>';
                container.classList.add('show');
                return;
            }
            
            container.innerHTML = results.map(corp => {
                const marketClass = corp.market === '코스피' ? 'market-kospi' : 
                                   corp.market === '코스닥' ? 'market-kosdaq' : 'market-etc';
                return `
                    <div class="result-item" onclick="selectCompany('${corp.corp_code}', '${corp.corp_name}', '${corp.stock_code}', '${corp.market}')">
                        <div class="result-name">
                            ${corp.corp_name}
                            <span class="result-market ${marketClass}">${corp.market}</span>
                        </div>
                        <div class="result-info">
                            고유번호: ${corp.corp_code}
                            ${corp.stock_code ? ' | 종목코드: ' + corp.stock_code : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.classList.add('show');
        }
        
        // ============================================================
        // 기업 선택
        // ============================================================
        function selectCompany(corpCode, corpName, stockCode, market) {
            selectedCorp = { corpCode, corpName, stockCode, market };

            // 태그라인 숨기고 검색 섹션 상단으로 복귀
            document.getElementById('mainContainer').classList.remove('centered');

            // UI 업데이트
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('selectedCompanyName').textContent = `${corpName} (${market})`;
            document.getElementById('progressSection').classList.add('show');

            // 기업개황정보 로드
            loadCompanyInfo(corpCode);
        }

        // ============================================================
        // 기업개황정보 로드
        // ============================================================
        let companyInfoData = null;  // 기업개황정보 저장용

        function toggleCompanyInfo() {
            const content = document.getElementById('companyInfoContent');
            const toggle = document.getElementById('companyInfoToggle');
            const isCollapsed = content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed', isCollapsed);
            toggle.textContent = isCollapsed ? '펼치기 ▼' : '접기 ▲';
        }

        async function loadCompanyInfo(corpCode) {
            const wrapperEl = document.getElementById('companyInfoWrapper');
            const loadingEl = document.getElementById('companyInfoLoading');
            const tableEl = document.getElementById('companyInfoTable');
            const bodyEl = document.getElementById('companyInfoBody');

            // wrapper 표시 및 로딩 표시
            wrapperEl.style.display = 'block';
            loadingEl.style.display = 'flex';
            loadingEl.innerHTML = '<span class="spinner"></span> 기업정보 로딩 중...';
            tableEl.style.display = 'none';
            bodyEl.innerHTML = '';
            companyInfoData = null;

            try {
                const response = await fetch(`/api/company-info/${corpCode}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.detail || '기업정보 조회 실패');
                }

                const info = result.data;
                companyInfoData = info;  // 저장

                // 테이블 렌더링
                const pendingNote = '<span style="color: #9ca3af; font-size: 0.85em; margin-left: 8px;">(최신정보 업데이트 전)</span>';
                const rows = [
                    ['회사명', info.corp_name],
                    ['영문명', info.corp_name_eng],
                    ['대표자', info.ceo_nm + pendingNote],
                    ['시장구분', info.market_name],
                    ['종목코드', info.stock_code || '-'],
                    ['법인번호', info.jurir_no || '-'],
                    ['사업자번호', info.bizr_no || '-'],
                    ['업종코드', info.induty_code || '-'],
                    ['업종명', info.induty_name || '-'],
                    ['설립일', info.est_dt_formatted || '-'],
                    ['결산월', info.acc_mt_formatted || '-'],
                    ['주소', (info.adres || '-') + pendingNote],
                    ['홈페이지', info.hm_url ? `<a href="${info.hm_url.startsWith('http') ? info.hm_url : 'https://' + info.hm_url}" target="_blank">${info.hm_url}</a>` : '-'],
                ];

                bodyEl.innerHTML = rows
                    .filter(([label, value]) => value && value !== '-')
                    .map(([label, value]) => `<tr><td>${label}</td><td>${value}</td></tr>`)
                    .join('');

                // 테이블 표시
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';

            } catch (error) {
                console.error('기업정보 로드 실패:', error);
                loadingEl.innerHTML = `<span style="color: #ef4444;">기업정보 로드 실패: ${error.message}</span>`;
            }
        }

        function updateCurrentAddress(currentAddress) {
            // 기업개황정보 테이블에서 주소 행 찾아서 현재주소 추가
            const bodyEl = document.getElementById('companyInfoBody');
            if (!bodyEl) return;

            const rows = bodyEl.querySelectorAll('tr');
            for (const row of rows) {
                const labelCell = row.querySelector('td:first-child');
                if (labelCell && labelCell.textContent === '주소') {
                    const valueCell = row.querySelector('td:last-child');
                    if (valueCell) {
                        const originalAddress = valueCell.textContent;
                        // 이미 현재주소가 추가되어 있으면 스킵
                        if (!valueCell.innerHTML.includes('현재주소:')) {
                            valueCell.innerHTML = `${originalAddress} <span style="color: var(--primary); font-weight: 500;">(현재주소: ${currentAddress})</span>`;
                        }
                    }
                    break;
                }
            }
        }

        // AI 분석 완료 후 최신 대표자/주소 업데이트
        function updateCompanyInfoFromAnalysis(currentCeo, currentAddress) {
            const bodyEl = document.getElementById('companyInfoBody');
            if (!bodyEl) return;

            const rows = bodyEl.querySelectorAll('tr');
            for (const row of rows) {
                const labelCell = row.querySelector('td:first-child');
                if (!labelCell) continue;

                const label = labelCell.textContent.trim();
                const valueCell = row.querySelector('td:last-child');
                if (!valueCell) continue;

                // 대표자 업데이트
                if (label === '대표자' && currentCeo) {
                    // 이미 최신정보 확인/상태 배지가 있으면 스킵 (업데이트 전은 제외)
                    const hasLatestBadge = valueCell.innerHTML.includes('최신정보 확인됨') || valueCell.innerHTML.includes('최신정보 상태');
                    if (!hasLatestBadge) {
                        // "(최신정보 업데이트 전)" 제거하고 원본 추출
                        let originalCeo = valueCell.textContent.replace(/\(최신정보 업데이트 전\)/g, '').trim();
                        originalCeo = originalCeo.split('→')[0].trim();

                        // 원본과 최신 상관없이 동일하게 최신정보 표시
                        valueCell.innerHTML = `${currentCeo} <span style="background: var(--accent); color: white; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; margin-left: 8px; display: inline-flex; align-items: center; line-height: 1;">최신정보</span>`;
                    }
                }

                // 주소 업데이트
                if (label === '주소' && currentAddress) {
                    // 이미 최신정보 확인/상태 배지가 있으면 스킵 (업데이트 전은 제외)
                    const hasLatestBadge = valueCell.innerHTML.includes('최신정보 확인됨') || valueCell.innerHTML.includes('최신정보 상태');
                    if (!hasLatestBadge) {
                        // "(최신정보 업데이트 전)" 제거하고 원본 추출
                        let originalAddress = valueCell.textContent.replace(/\(최신정보 업데이트 전\)/g, '').trim();
                        if (originalAddress.includes('(현재주소:')) {
                            originalAddress = originalAddress.split('(현재주소:')[0].trim();
                        }

                        // 원본과 최신 상관없이 동일하게 최신정보 표시
                        valueCell.innerHTML = `${currentAddress} <span style="background: var(--accent); color: white; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; margin-left: 8px; display: inline-flex; align-items: center; line-height: 1;">최신정보</span>`;
                    }
                }
            }

            // 섹션 제목 업데이트
            updateCompanyInfoTitle(true);
        }

        // 기업개황정보 섹션 제목 업데이트
        function updateCompanyInfoTitle(isLatest) {
            const titleEl = document.querySelector('#companyInfoSection .company-info-title span:first-child');
            const subtitleEl = document.querySelector('#companyInfoSection .company-info-title span:nth-child(2)');

            if (isLatest) {
                if (titleEl) {
                    titleEl.textContent = '기업개황정보';
                }
                if (subtitleEl) {
                    subtitleEl.innerHTML = '<span style="color: var(--accent); font-weight: 500;">✓ 최신 정보 상태입니다.</span>';
                }
            } else {
                if (titleEl) {
                    titleEl.textContent = '기업개황정보';
                }
                if (subtitleEl) {
                    subtitleEl.innerHTML = '대표자와 주소는 통합 추출 이후에 최신정보를 반영하여 업데이트 됩니다.';
                    subtitleEl.style.color = '#9ca3af';
                }
            }
        }

        // ============================================================
        // 재무제표 추출 시작
        // ============================================================
        async function startExtraction(integrated = false) {
            if (!selectedCorp) return;

            // 검색횟수 체크
            if (currentUser && currentUser.search_count !== null && currentUser.search_count !== undefined && currentUser.search_count <= 0) {
                alert('검색횟수가 부족합니다.\n유료 결제를 진행해 주세요.');
                return;
            }

            // 상태 플래그 초기화
            isExtractionComplete = false;
            isAnalysisStarting = false;

            // 통합추출 모드 설정
            isIntegratedMode = integrated;
            isAnalysisCompleted = false;

            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);

            if (startYear > endYear) {
                showError('시작 연도가 종료 연도보다 클 수 없습니다.');
                return;
            }

            // UI 전환
            document.getElementById('mainContainer').classList.remove('centered');
            document.getElementById('progressSection').classList.remove('show');
            document.getElementById('extractingSection').classList.add('show');

            try {
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        corp_code: selectedCorp.corpCode,
                        corp_name: selectedCorp.corpName,
                        start_year: startYear,
                        end_year: endYear,
                        company_info: companyInfoData  // 기업개황정보 추가
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '추출 시작 실패');
                }
                
                currentTaskId = data.task_id;
                
                // 상태 확인 시작
                startStatusCheck();
                
            } catch (error) {
                showError(error.message);
                resetAll();
            }
        }
        
        // ============================================================
        // 상태 확인
        // ============================================================
        function startStatusCheck() {
            statusCheckInterval = setInterval(checkStatus, 500);
        }
        
        async function checkStatus() {
            if (!currentTaskId) {
                stopStatusCheck();
                return;
            }
            
            try {
                const response = await fetch(`/api/status/${currentTaskId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '상태 확인 실패');
                }
                
                updateProgress(data.progress, data.message);
                
                if (data.status === 'completed') {
                    stopStatusCheck();
                    // 미리보기 데이터 저장
                    previewData = data.preview_data || null;
                    // 파일명 저장 (다운로드용)
                    currentFilename = data.filename || null;
                    // 현재 대표자/주소 업데이트 (사업보고서 기준)
                    if (data.current_ceo || data.current_address) {
                        updateCompanyInfoFromAnalysis(data.current_ceo, data.current_address);
                    }
                    showComplete();
                } else if (data.status === 'error') {
                    stopStatusCheck();
                    // 에러 시 화면 유지하고 에러 메시지만 표시
                    document.getElementById('extractingSection').classList.remove('show');
                    document.getElementById('progressSection').classList.add('show');
                    showError(data.message);
                } else if (data.status === 'cancelled') {
                    stopStatusCheck();
                    resetAll();
                }
                
            } catch (error) {
                console.error('Status check error:', error);
            }
        }
        
        function stopStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        // Heartbeat: 브라우저가 열려있는 동안 작업 유지
        function startHeartbeat() {
            stopHeartbeat();  // 기존 인터벌 정리
            if (!currentTaskId) return;

            heartbeatInterval = setInterval(async () => {
                if (!currentTaskId) {
                    stopHeartbeat();
                    return;
                }
                try {
                    await fetch(`/api/heartbeat/${currentTaskId}`, { method: 'POST' });
                } catch (e) {
                    // 무시 (서버 연결 끊김 등)
                }
            }, 60000);  // 60초마다
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function updateProgress(progress, message) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            document.getElementById('progressMessage').textContent = message;
        }
        
        // ============================================================
        // 취소
        // ============================================================
        async function cancelExtraction() {
            if (!currentTaskId) return;

            stopStatusCheck();
            stopHeartbeat();

            try {
                await fetch(`/api/cancel/${currentTaskId}`, { method: 'POST' });
            } catch (error) {
                console.error('Cancel error:', error);
            }

            currentTaskId = null;
            resetAll();
        }
        
        // ============================================================
        // 완료 및 다운로드
        // ============================================================
        function showComplete() {
            // 중복 호출 방지
            if (isExtractionComplete) {
                console.log('[Extract] showComplete 중복 호출 무시');
                return;
            }
            isExtractionComplete = true;

            document.getElementById('extractingSection').classList.remove('show');
            document.getElementById('resultContainer').classList.add('show');
            document.getElementById('resultContainer').classList.add('expanded');
            document.getElementById('completeSection').classList.add('show');

            // 기업 리서치 탭 래퍼 표시
            const superResearchWrapper = document.querySelector('.super-research-tab-wrapper');
            if (superResearchWrapper) superResearchWrapper.style.display = 'inline-block';

            // Heartbeat 시작 (브라우저 열려있는 동안 작업 유지)
            startHeartbeat();

            // 검색횟수 갱신 (차감된 검색횟수 반영)
            checkAuth();

            // 미리보기 표시
            if (previewData) {
                renderFinancialsVCM();  // Financials 탭에 VCM 렌더링
                renderActivePreviewTabs();  // 재무 상세 탭 (모든 활성 탭 렌더링)
                showMainTab('financials');  // Financials 탭 활성화
            } else {
                document.getElementById('financialsContent').innerHTML =
                    '<p class="preview-placeholder">미리보기 데이터가 없습니다.</p>';
            }

            if (isIntegratedMode) {
                // 통합추출 모드: 자동으로 AI 분석 + 기업 리서치 시작
                document.getElementById('analysisStartContainer').style.display = 'none';
                setTimeout(() => {
                    startAnalysis();
                    startSuperResearch();  // 기업 리서치도 동시에 시작
                }, 500);
                // 통합모드에서도 추출 직후 챗봇 활성화 (재무데이터 기반 질의 가능)
                setTimeout(() => { initChatbot(); }, 1500);
            } else {
                // 재무제표만 추출: AI 분석 시작 버튼 표시
                document.getElementById('analysisStartContainer').style.display = 'block';
                document.getElementById('analysisStatus').textContent = '';
                // 분석 없이도 챗봇 활성화 (재무데이터 기반 질의 가능)
                setTimeout(() => { initChatbot(); }, 1000);
            }

        }

        // 상위 탭 전환 (재무분석 AI / 재무정보)
        function showMainTab(tabName) {
            // 탭 버튼 활성화 상태 변경
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.mainTab === tabName) {
                    tab.classList.add('active');
                }
            });

            // 탭 콘텐츠 표시/숨김
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // vcm-sub-tabs 표시/숨김
            const vcmSubTabs = document.getElementById('vcmSubTabs');
            if (tabName === 'financials') {
                document.getElementById('financialsTabContent').classList.add('active');
                vcmSubTabs.classList.add('show');
            } else if (tabName === 'superResearch') {
                document.getElementById('superResearchTabContent').classList.add('active');
                vcmSubTabs.classList.remove('show');
            } else if (tabName === 'insight') {
                document.getElementById('insightTabContent').classList.add('active');
                vcmSubTabs.classList.remove('show');
            } else if (tabName === 'financial') {
                document.getElementById('financialTabContent').classList.add('active');
                vcmSubTabs.classList.remove('show');
            }
        }

        // VCM 박스 토글 (재무상태표, 손익계산서, 재무분석 AI)
        function toggleVcmBox(boxType) {
            const btn = document.querySelector(`.vcm-sub-tab[data-vcm-box="${boxType}"]`);
            const allBtns = document.querySelectorAll('.vcm-sub-tab');
            const activeCount = document.querySelectorAll('.vcm-sub-tab.active').length;

            // 마지막 하나 남은 활성 버튼은 비활성화 불가
            if (btn.classList.contains('active') && activeCount <= 1) {
                return;
            }

            btn.classList.toggle('active');

            // vcm-box에 hidden 클래스 토글 (#financialsContent 내의 박스만 대상)
            const financialsContent = document.getElementById('financialsContent');
            const vcmWrapper = financialsContent ? financialsContent.querySelector('.vcm-wrapper') : null;
            if (!vcmWrapper) return;

            const vcmBoxes = vcmWrapper.querySelectorAll('.vcm-box');
            const boxMap = {
                'bs': 0,  // 재무상태표 (첫 번째 vcm-box)
                'is': 1,  // 손익계산서 (두 번째 vcm-box)
                'ai': 2   // 재무분석 AI (세 번째 vcm-box)
            };
            const boxIndex = boxMap[boxType];

            if (vcmBoxes[boxIndex]) {
                if (btn.classList.contains('active')) {
                    vcmBoxes[boxIndex].classList.remove('hidden');
                } else {
                    vcmBoxes[boxIndex].classList.add('hidden');
                }
            }

            // 재무분석 AI 박스 너비/높이 조정
            updateAiBoxWidth();
            updateAiBoxHeight();
        }

        // 재무분석 AI 박스 너비 조정 (BS/IS 중 하나만 선택 시 700px, 둘 다 선택 시 600px)
        function updateAiBoxWidth() {
            const bsBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="bs"]');
            const isBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="is"]');
            const aiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');

            // #financialsContent 내의 AI 박스만 대상
            const financialsContent = document.getElementById('financialsContent');
            const aiBox = financialsContent ? financialsContent.querySelector('.vcm-box-analysis') : null;

            if (!aiBox || !aiBtn || !aiBtn.classList.contains('active')) return;

            const bsActive = bsBtn && bsBtn.classList.contains('active');
            const isActive = isBtn && isBtn.classList.contains('active');

            // BS와 IS 중 하나만 선택된 경우 (XOR)
            if ((bsActive && !isActive) || (!bsActive && isActive)) {
                aiBox.style.maxWidth = '700px';
            } else {
                aiBox.style.maxWidth = '600px';
            }
        }

        // 재무분석 AI 박스 높이 조정 (BS/IS 중 가장 긴 것에 맞춤)
        function updateAiBoxHeight() {
            const financialsContent = document.getElementById('financialsContent');
            if (!financialsContent) return;

            const wrapper = financialsContent.querySelector('.vcm-wrapper');
            if (!wrapper) return;

            const aiBox = wrapper.querySelector('.vcm-box-analysis');
            if (!aiBox || aiBox.classList.contains('hidden')) return;

            // BS, IS 박스만 선택 (AI 제외, hidden 제외)
            const bsBox = wrapper.querySelector('.vcm-box:not(.vcm-box-analysis):nth-child(1)');
            const isBox = wrapper.querySelector('.vcm-box:not(.vcm-box-analysis):nth-child(2)');

            let maxHeight = 0;
            if (bsBox && !bsBox.classList.contains('hidden')) {
                maxHeight = Math.max(maxHeight, bsBox.offsetHeight);
            }
            if (isBox && !isBox.classList.contains('hidden')) {
                maxHeight = Math.max(maxHeight, isBox.offsetHeight);
            }

            console.log('[AI높이] BS:', bsBox?.offsetHeight, 'IS:', isBox?.offsetHeight, '최대:', maxHeight);

            if (maxHeight > 0) {
                aiBox.style.height = maxHeight + 'px';
                aiBox.style.maxHeight = maxHeight + 'px';
                console.log('[AI높이] 설정 완료:', maxHeight + 'px');
            }
        }

        // 프리뷰 탭 토글 (다중 선택 가능)
        function togglePreviewTab(tabName) {
            const btn = document.querySelector(`.preview-tab[data-tab="${tabName}"]`);
            const activeCount = document.querySelectorAll('.preview-tab.active').length;

            // 마지막 하나 남은 활성 버튼은 비활성화 불가
            if (btn.classList.contains('active') && activeCount <= 1) {
                return;
            }

            btn.classList.toggle('active');
            renderActivePreviewTabs();
        }

        // 활성화된 모든 프리뷰 탭 렌더링
        function renderActivePreviewTabs() {
            const content = document.getElementById('previewContent');
            const activeTabs = Array.from(document.querySelectorAll('.preview-tab.active'))
                .map(btn => btn.dataset.tab);

            if (activeTabs.length === 0) {
                content.innerHTML = '<p class="preview-placeholder">탭을 선택해주세요.</p>';
                return;
            }

            let allHtml = '<div class="preview-wrapper">';

            activeTabs.forEach(tabName => {
                allHtml += renderPreviewTable(tabName);
            });

            allHtml += '</div>';
            content.innerHTML = allHtml;
        }

        // 단일 프리뷰 테이블 렌더링
        function renderPreviewTable(tabName) {
            const tabNames = { 'bs': '재무상태표', 'is': '손익계산서', 'cf': '현금흐름표' };

            if (!previewData || !previewData[tabName]) {
                return `<div class="preview-box"><div class="preview-title">${tabNames[tabName]}</div><p class="preview-placeholder">${tabNames[tabName]} 데이터가 없습니다.</p></div>`;
            }

            const data = previewData[tabName];
            if (data.length === 0) {
                return `<div class="preview-box"><div class="preview-title">${tabNames[tabName]}</div><p class="preview-placeholder">데이터가 없습니다.</p></div>`;
            }

            // 테이블 생성 - 필요한 컬럼만 표시 (계정과목 + FY 연도, 분류 컬럼은 엑셀에만 저장)
            const allHeaders = Object.keys(data[0]);
            // 계정과목, FY 연도 컬럼만 필터링 (분류1~4 제외 - 프론트에선 불필요)
            const headers = allHeaders.filter(h =>
                h === '계정과목' ||
                h.startsWith('FY')
            );
            // 정렬: 계정과목 -> FY 연도(오름차순, 최신이 우측)
            headers.sort((a, b) => {
                if (a === '계정과목') return -1;
                if (b === '계정과목') return 1;
                return a.localeCompare(b);
            });

            let tableHtml = '<div class="preview-box">';
            tableHtml += `<div class="preview-title">${tabNames[tabName]}</div>`;
            tableHtml += '<table class="preview-table"><thead><tr>';
            headers.forEach(h => {
                // 헤더에서 계정과목 대신 단위 표시
                if (h === '계정과목') {
                    tableHtml += '<th>(단위: 백만원)</th>';
                } else {
                    tableHtml += `<th>${h}</th>`;
                }
            });
            tableHtml += '</tr></thead><tbody>';

            // FY 컬럼만 추출 (섹션 헤더 행 판별용)
            const fyHeaders = headers.filter(h => h.startsWith('FY'));

            // ========== 주석 경계 감지 ==========
            // 방법1: 분류1 컬럼 — 본문 행은 분류1이 있고, 주석 행은 null
            let noteStartIdx = data.length;
            const has분류1 = data.some(r => r['분류1'] && String(r['분류1']).trim());
            if (has분류1) {
                for (let i = data.length - 1; i >= 0; i--) {
                    const cls1 = data[i]['분류1'];
                    if (cls1 && String(cls1).trim()) {
                        noteStartIdx = i + 1;
                        break;
                    }
                }
            } else {
                // 방법2: 키워드 기반 종료 항목 감지
                const terminalPatterns = {
                    'is': /주당|총포괄이익|총포괄손익/,
                    'cis': /주당|총포괄이익|총포괄손익/,
                    'bs': /부채및자본총계|부채와자본총계/,
                    'cf': /기말현금|기말의현금|현금및현금성자산의증감/
                };
                const pattern = terminalPatterns[tabName];
                if (pattern) {
                    for (let i = data.length - 1; i >= 0; i--) {
                        const name = (data[i]['계정과목'] || '').replace(/\s/g, '');
                        if (pattern.test(name)) {
                            noteStartIdx = i + 1;
                            break;
                        }
                    }
                }
            }

            let notesSeparatorInserted = false;

            data.forEach((row, idx) => {
                const accountName = (row['계정과목'] || '');

                // 주석 구분선 삽입
                if (idx === noteStartIdx && noteStartIdx < data.length && !notesSeparatorInserted) {
                    notesSeparatorInserted = true;
                    tableHtml += `<tr class="notes-separator"><td colspan="${headers.length}">────── 주석 상세 ──────</td></tr>`;
                }

                const isNoteRow = idx >= noteStartIdx;

                // 섹션 헤더 행 감지: FY 컬럼에 숫자가 아닌 텍스트가 있는 행
                const hasTextInFY = fyHeaders.some(fy => {
                    const v = row[fy];
                    if (v === null || v === undefined || v === '' || v === 'nan' || v === 'NaN') return false;
                    if (typeof v === 'number') return false;
                    if (typeof v === 'string') {
                        const cleaned = v.replace(/,/g, '').trim();
                        if (cleaned === '' || cleaned === '-') return false;
                        return !/^-?[\d.]+$/.test(cleaned);
                    }
                    return false;
                });

                // 섹션 헤더 → 주석 영역에서는 그룹 헤더로 렌더링, 본문에서는 스킵
                if (hasTextInFY) {
                    if (isNoteRow) {
                        tableHtml += `<tr class="note-group-header"><td colspan="${headers.length}">${accountName.trim()}</td></tr>`;
                    }
                    return;
                }

                // 일반 행 렌더링
                tableHtml += `<tr class="${isNoteRow ? 'note-row' : ''}">`;
                headers.forEach((h, idx) => {
                    let value = row[h];
                    // 숫자 포맷팅 (첫번째 열(계정과목)은 제외)
                    if (idx > 0 && typeof value === 'number') {
                        // 백만 단위로 변환 후 3자리마다 쉼표
                        const inMillions = Math.round(value / 1000000);
                        value = inMillions.toLocaleString();
                    } else if (idx > 0 && typeof value === 'string' && /^-?\d+$/.test(value.replace(/,/g, ''))) {
                        // 문자열 숫자도 처리
                        const numValue = parseInt(value.replace(/,/g, ''));
                        const inMillions = Math.round(numValue / 1000000);
                        value = inMillions.toLocaleString();
                    }
                    tableHtml += `<td>${value !== null && value !== undefined ? value : ''}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableHtml += '</div>';

            return tableHtml;
        }

        function showPreviewTab(tabName) {
            // 단일 탭 선택 (기존 호환성 유지)
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            renderActivePreviewTabs();
        }

        // ============================================================
        // Financials 탭에 VCM 렌더링
        // ============================================================
        function renderFinancialsVCM() {
            const financialsContent = document.getElementById('financialsContent');
            financialsContent.innerHTML = renderVCMFormat();

            // 재무분석 AI 서브탭 상태에 따라 vcm-box 숨김 처리
            // #financialsContent 범위 내에서만 쿼리 (전역 쿼리 방지)
            const aiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
            const vcmWrapper = financialsContent.querySelector('.vcm-wrapper');
            const vcmBoxes = vcmWrapper ? vcmWrapper.querySelectorAll('.vcm-box') : [];
            const aiBox = vcmWrapper ? vcmWrapper.querySelector('.vcm-box-analysis') : null;

            console.log('[VCM렌더] AI박스 존재:', !!aiBox, 'AI버튼 active:', aiBtn?.classList.contains('active'));

            if (aiBox && aiBtn && !aiBtn.classList.contains('active')) {
                aiBox.classList.add('hidden');
            }

            // 재무분석 AI 박스 너비/높이 조정
            updateAiBoxWidth();
            updateAiBoxHeight();
        }

        // ============================================================
        // VCM 전용 포맷 렌더링
        // ============================================================
        function renderVCMFormat() {
            if (!previewData) {
                return '<p class="preview-placeholder">데이터가 없습니다.</p>';
            }

            // 연도 컬럼 추출 (FY로 시작하는 컬럼)
            const bsData = previewData.bs || [];
            // CIS 우선 (HTML 주석 병합 데이터), 없으면 IS 사용
            const isData = previewData.cis || previewData.is || [];
            
            // 디버깅: 실제 데이터 구조 확인
            console.log('=== VCM 디버깅 ===');
            console.log('IS 데이터 행 수:', isData.length);
            if (isData.length > 0) {
                console.log('=== IS(손익계산서) 전체 계정과목 목록 ===');
                isData.forEach((r, i) => {
                    console.log(`[${i}] ${r['계정과목']}`);
                });
                console.log('=== IS 계정과목 총 개수:', isData.length, '===');
            }
            
            let years = [];
            if (bsData.length > 0) {
                years = Object.keys(bsData[0]).filter(k => k.startsWith('FY')).sort();
            } else if (isData.length > 0) {
                years = Object.keys(isData[0]).filter(k => k.startsWith('FY')).sort();
            }
            
            // 최근 5년만 표시 (내림차순 정렬 후 상위 5개 선택, 다시 오름차순으로 표시)
            if (years.length > 5) {
                years = years.sort().reverse().slice(0, 5).reverse();
            }
            console.log('추출된 연도 (최근 5년):', years);
            
            if (years.length === 0) {
                return '<p class="preview-placeholder">연도 데이터가 없습니다.</p>';
            }
            
            // 동적 단위 결정: 원본 데이터에서 최대 절대값 확인
            // 최소 단위는 백만원, 필요시 억원/십억원으로 조정
            let maxAbsValue = 0;
            const allData = [...bsData, ...isData];
            allData.forEach(row => {
                years.forEach(y => {
                    const val = row[y];
                    if (typeof val === 'number' && !isNaN(val)) {
                        const absVal = Math.abs(val);
                        if (absVal > maxAbsValue) maxAbsValue = absVal;
                    }
                });
            });
            
            // 단위 결정 (원본 데이터 기준)
            // maxAbsValue는 원본 값 (원 단위, Excel raw 데이터)
            // 최대값에 따라 적절한 단위 자동 선택
            let unitDivisor = 1_000_000;  // 기본: 백만원
            let unitLabel = '백만원';

            if (maxAbsValue >= 1_000_000_000_000) {  // 1조 이상
                unitDivisor = 100_000_000;  // 억원
                unitLabel = '억원';
            } else if (maxAbsValue >= 100_000_000_000) {  // 천억(1,000억) 이상
                unitDivisor = 10_000_000;  // 천만원
                unitLabel = '천만원';
            } else if (maxAbsValue >= 10_000_000_000) {  // 백억(100억) 이상
                unitDivisor = 1_000_000;  // 백만원
                unitLabel = '백만원';
            }

            console.log('최대값(원):', maxAbsValue.toLocaleString(), '→ 단위:', unitLabel);
            
            // 계정과목명 정규화 함수 (로마숫자, 주석번호 제거)
            function normalizeAccount(str) {
                if (!str) return '';
                return str
                    .replace(/\s/g, '')           // 공백 제거
                    .replace(/^[ⅠⅡⅢⅣⅤⅥⅦⅧⅨⅩ]+\./g, '')  // 로마숫자 접두어 제거
                    .replace(/\(주석[0-9,]+\)/g, '')   // 주석번호 제거
                    .replace(/\(손실\)/g, '')     // (손실) 제거
                    .replace(/등$/g, '비용');     // "법인세등" -> "법인세비용"
            }
            
            // 값 파싱 헬퍼 함수 (동적 단위 적용)
            function parseValue(val) {
                if (val === null || val === undefined) return null;
                if (typeof val === 'number') return val / unitDivisor;  // 반올림 제거, 정밀한 값 유지

                const str = String(val).trim();
                if (str === '' || str === '-' || str === 'nan' || str === 'NaN') return null;

                // 괄호로 표시된 음수 처리: (1,000,000) -> -1000000
                let isNegative = false;
                let cleanStr = str;
                if (str.startsWith('(') && str.endsWith(')')) {
                    isNegative = true;
                    cleanStr = str.slice(1, -1);
                }

                // 쉼표 제거 후 숫자 변환
                const num = parseFloat(cleanStr.replace(/,/g, ''));
                if (isNaN(num)) return null;

                return (isNegative ? -num : num) / unitDivisor;  // 반올림 제거, 정밀한 값 유지
            }

            // 자동 단위 감지 값 파싱 (손익계산서 전용 - 원/천원 혼재 대응)
            // 100,000,000 이상이면 원 단위, 미만이면 천원 단위로 간주
            function parseValueWithAutoUnit(val) {
                if (val === null || val === undefined) return null;

                let num;
                if (typeof val === 'number') {
                    num = val;
                } else {
                    const str = String(val).trim();
                    if (str === '' || str === '-' || str === 'nan' || str === 'NaN') return null;

                    // 괄호로 표시된 음수 처리
                    let isNegative = false;
                    let cleanStr = str;
                    if (str.startsWith('(') && str.endsWith(')')) {
                        isNegative = true;
                        cleanStr = str.slice(1, -1);
                    }

                    // 쉼표 제거 후 숫자 변환
                    num = parseFloat(cleanStr.replace(/,/g, ''));
                    if (isNaN(num)) return null;

                    if (isNegative) num = -num;
                }

                // 자동 단위 감지: 100,000,000 (1억) 이상이면 원 단위, 미만이면 천원 단위
                if (Math.abs(num) >= 100000000) {
                    return num / 100000000;  // 원 -> 억원
                } else {
                    return num / 100000;  // 천원 -> 억원
                }
            }

            // 자동 단위 감지를 적용한 findValue (손익계산서 전용)
            function findValueIS(data, keywords, year, excludeKeywords = []) {
                if (!keywords || keywords.length === 0) return null;

                // 1차: 정확한 매칭 시도
                for (const row of data) {
                    const accountRaw = row['계정과목'] || '';
                    const account = normalizeAccount(accountRaw);

                    // 제외 키워드 체크
                    let excluded = false;
                    for (const ex of excludeKeywords) {
                        if (account.includes(normalizeAccount(ex))) {
                            excluded = true;
                            break;
                        }
                    }
                    if (excluded) continue;

                    for (const kw of keywords) {
                        const kwNorm = normalizeAccount(kw);
                        if (account === kwNorm || account.startsWith(kwNorm)) {
                            const val = parseValue(row[year]);
                            if (val !== null) return val;
                        }
                    }
                }

                // 2차: 포함 매칭 시도
                for (const row of data) {
                    const accountRaw = row['계정과목'] || '';
                    const account = normalizeAccount(accountRaw);

                    // 제외 키워드 체크
                    let excluded = false;
                    for (const ex of excludeKeywords) {
                        if (account.includes(normalizeAccount(ex))) {
                            excluded = true;
                            break;
                        }
                    }
                    if (excluded) continue;

                    for (const kw of keywords) {
                        if (account.includes(normalizeAccount(kw))) {
                            const val = parseValue(row[year]);
                            if (val !== null) return val;
                        }
                    }
                }

                return null;
            }
            
            // 분류3(유동부채/비유동부채 등)를 고려한 검색 함수
            function findValueWithCategory(data, keywords, year, category3, excludeKeywords = []) {
                if (!keywords || keywords.length === 0) return null;

                for (const row of data) {
                    const accountRaw = row['계정과목'] || '';
                    const account = normalizeAccount(accountRaw);
                    const rowCategory3 = row['분류3'] || '';

                    // 분류3 체크 (지정된 경우만)
                    if (category3 && !rowCategory3.includes(category3)) continue;

                    // 제외 키워드 체크
                    let excluded = false;
                    for (const ex of excludeKeywords) {
                        if (account.includes(normalizeAccount(ex))) {
                            excluded = true;
                            break;
                        }
                    }
                    if (excluded) continue;

                    for (const kw of keywords) {
                        const kwNorm = normalizeAccount(kw);
                        if (account === kwNorm || account.includes(kwNorm)) {
                            const val = parseValue(row[year]);
                            if (val !== null) return val;
                        }
                    }
                }
                return null;
            }

            // 데이터를 계정과목으로 검색하는 헬퍼 함수
            // debugMode: true면 매칭 실패시 로그 출력
            const debugFindValue = true;  // 디버그 모드 ON
            function findValue(data, keywords, year, excludeKeywords = []) {
                if (!keywords || keywords.length === 0) return null;
                
                // 1차: 정확한 매칭 시도
                for (const row of data) {
                    const accountRaw = row['계정과목'] || '';
                    const account = normalizeAccount(accountRaw);
                    
                    // 제외 키워드 체크
                    let excluded = false;
                    for (const ex of excludeKeywords) {
                        if (account.includes(normalizeAccount(ex))) {
                            excluded = true;
                            break;
                        }
                    }
                    if (excluded) continue;
                    
                    for (const kw of keywords) {
                        const kwNorm = normalizeAccount(kw);
                        // 정확한 매칭 (계정과목이 키워드와 동일하거나, 키워드로 시작)
                        if (account === kwNorm || account.startsWith(kwNorm)) {
                            const val = parseValue(row[year]);
                            if (val !== null) return val;
                        }
                    }
                }
                
                // 2차: 포함 매칭 시도 (정확한 매칭 실패 시)
                for (const row of data) {
                    const accountRaw = row['계정과목'] || '';
                    const account = normalizeAccount(accountRaw);
                    
                    // 제외 키워드 체크
                    let excluded = false;
                    for (const ex of excludeKeywords) {
                        if (account.includes(normalizeAccount(ex))) {
                            excluded = true;
                            break;
                        }
                    }
                    if (excluded) continue;
                    
                    for (const kw of keywords) {
                        if (account.includes(normalizeAccount(kw))) {
                            const val = parseValue(row[year]);
                            if (val !== null) return val;
                        }
                    }
                }
                
                // 디버그: 매칭 실패 로그
                if (debugFindValue && keywords.length > 0) {
                    console.log(`[findValue 실패] 키워드: [${keywords.join(', ')}], 연도: ${year}`);
                }
                return null;
            }
            
            // 숫자 포맷팅 (단위 무관, 1 미만은 소수점 2자리, 1 이상은 정수)
            function fmt(val) {
                if (val === null || val === undefined || isNaN(val)) return '';

                // 단위별 최소 표시 단위 (백만원 기준)
                // 백만원 단위: 1 = 백만원 → 정수만
                // 천만원 단위: 0.1 = 백만원 → 소수점 첫째 자리
                // 억원 단위: 0.01 = 백만원 → 소수점 둘째 자리
                let minDisplayValue, decimalPlaces;

                if (unitLabel === '백만원') {
                    minDisplayValue = 1;      // 백만원 미만은 표시 안 함
                    decimalPlaces = 0;        // 정수만
                } else if (unitLabel === '천만원') {
                    minDisplayValue = 0.1;    // 백만원 미만은 표시 안 함
                    decimalPlaces = 1;        // 소수점 첫째 자리까지
                } else {  // 억원
                    minDisplayValue = 0.01;   // 백만원 미만은 표시 안 함
                    decimalPlaces = 2;        // 소수점 둘째 자리까지
                }

                if (Math.abs(val) < minDisplayValue) return '';  // 최소 단위 미만은 빈칸

                // 100 이상: 항상 정수로 표시
                if (Math.abs(val) >= 100) {
                    return Math.round(val).toLocaleString();
                }

                // 소수점 반올림 후 trailing zero 제거
                const rounded = parseFloat(val.toFixed(decimalPlaces));
                const formatted = rounded.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: decimalPlaces
                });

                return formatted;
            }
            
            function pct(val, base) {
                if (!base || !val || isNaN(val) || isNaN(base)) return '';
                return (val / base * 100).toFixed(1) + '%';
            }
            
            // 재무상태표 항목 정의 (excludes: 제외할 키워드)
            // 실제 계정과목명: 'Ⅰ.유동자산', '현금및현금성자산(주석3,19)', '자 산 총 계' 등

            // VCM 데이터에서 부모 항목의 세부항목 찾기 (툴팁용)
            function getVcmBreakdown(parentItem, year, vcmData) {
                const breakdown = [];
                if (!vcmData || !Array.isArray(vcmData)) return breakdown;

                // '부모' 컬럼이 parentItem인 항목들 찾기
                vcmData.forEach(row => {
                    const parent = row['부모'];
                    const item = row['항목'];
                    const val = row[year];

                    if (parent === parentItem && val !== null && val !== undefined && val !== 0) {
                        breakdown.push({
                            name: item,
                            value: parseFloat(val) || 0
                        });
                    }
                });

                return breakdown;
            }

            // 합산 항목의 상세 breakdown 반환 (툴팁용) - VCM 우선, 없으면 기존 로직
            function getBsBreakdown(calcType, year, vcmData) {
                // VCM 데이터에서 세부항목 찾기 시도
                if (vcmData && Array.isArray(vcmData)) {
                    let parentItem = null;
                    switch(calcType) {
                        case 'tradeReceivables': parentItem = '매출채권및기타채권'; break;
                        case 'currentTradePayables': parentItem = '매입채무및기타채무'; break;
                        case 'nonCurrentTradePayables': parentItem = '매입채무및기타채무[비유동]'; break;
                        case 'otherEquity': parentItem = '기타자본구성요소'; break;
                        case 'longTermInvestments': parentItem = '장기투자자산'; break;
                        case 'otherCurrentLiabilities': parentItem = '기타유동부채'; break;
                    }

                    if (parentItem) {
                        const vcmBreakdown = getVcmBreakdown(parentItem, year, vcmData);
                        if (vcmBreakdown.length > 0) {
                            return vcmBreakdown;
                        }
                    }
                }

                // VCM에 없으면 기존 로직 사용
                const breakdown = [];
                switch(calcType) {
                    case 'tradeReceivables':
                        // 세부 항목이 있으면 표시 (통합 계정명 사용 여부와 무관)
                        const 매출채권 = findValue(bsData, ['매출채권'], year, ['대손', '처분']) || 0;
                        const 미수금 = findValue(bsData, ['미수금'], year) || 0;
                        const 미수수익 = findValue(bsData, ['미수수익'], year) || 0;
                        if (매출채권) breakdown.push({ name: '매출채권', value: 매출채권 });
                        if (미수금) breakdown.push({ name: '미수금', value: 미수금 });
                        if (미수수익) breakdown.push({ name: '미수수익', value: 미수수익 });
                        break;
                    case 'otherCurrentAssets':
                        // 세부 항목이 있으면 표시 (통합 계정명 사용 여부와 무관)
                        const 선급금 = findValue(bsData, ['선급금'], year) || 0;
                        const 선급비용 = findValue(bsData, ['선급비용'], year) || 0;
                        if (선급금) breakdown.push({ name: '선급금', value: 선급금 });
                        if (선급비용) breakdown.push({ name: '선급비용', value: 선급비용 });
                        break;
                    case 'tradePayables': {
                        const 매입채무 = findValue(bsData, ['매입채무'], year) || 0;
                        const 미지급금 = findValue(bsData, ['미지급금'], year, ['장기']) || 0;
                        const 미지급비용 = findValue(bsData, ['미지급비용'], year) || 0;
                        if (매입채무) breakdown.push({ name: '매입채무', value: 매입채무 });
                        if (미지급금) breakdown.push({ name: '미지급금', value: 미지급금 });
                        if (미지급비용) breakdown.push({ name: '미지급비용', value: 미지급비용 });
                        break;
                    }
                    case 'currentTradePayables':
                        // 유동 매입채무및기타채무: 통합 계정 또는 세부 항목들
                        const 유동미지급금통합 = findValueWithCategory(bsData, ['미지급금및기타채무'], year, '유동부채') || 0;
                        const 유동매입채무 = findValueWithCategory(bsData, ['매입채무'], year, '유동부채') || 0;
                        const 유동미지급금세부 = findValueWithCategory(bsData, ['미지급금'], year, '유동부채') || 0;
                        const 유동미지급비용 = findValueWithCategory(bsData, ['미지급비용'], year, '유동부채') || 0;
                        const 유동선수금 = findValueWithCategory(bsData, ['선수금'], year, '유동부채') || 0;

                        if (유동미지급금통합) breakdown.push({ name: '미지급금및기타채무', value: 유동미지급금통합 });
                        if (유동매입채무) breakdown.push({ name: '매입채무', value: 유동매입채무 });
                        if (유동미지급금세부) breakdown.push({ name: '미지급금', value: 유동미지급금세부 });
                        if (유동미지급비용) breakdown.push({ name: '미지급비용', value: 유동미지급비용 });
                        if (유동선수금) breakdown.push({ name: '선수금', value: 유동선수금 });
                        break;
                    case 'nonCurrentTradePayables':
                        // 비유동 매입채무및기타채무: 통합 계정 또는 세부 항목들
                        const 비유동미지급금통합 = findValueWithCategory(bsData, ['미지급금및기타채무'], year, '비유동부채') || 0;
                        const 비유동장기매입채무 = findValueWithCategory(bsData, ['장기매입채무', '매입채무'], year, '비유동부채') || 0;
                        const 비유동장기미지급금 = findValueWithCategory(bsData, ['장기미지급금'], year, '비유동부채') || 0;
                        const 비유동장기미지급비용 = findValueWithCategory(bsData, ['장기미지급비용'], year, '비유동부채') || 0;
                        const 비유동장기선수금 = findValueWithCategory(bsData, ['장기선수금'], year, '비유동부채') || 0;
                        const 비유동장기선수수익 = findValueWithCategory(bsData, ['장기선수수익'], year, '비유동부채') || 0;
                        const 비유동장기예수금 = findValueWithCategory(bsData, ['장기예수금'], year, '비유동부채') || 0;
                        const 비유동임대보증금 = findValueWithCategory(bsData, ['임대보증금', '장기예수보증금'], year, '비유동부채') || 0;

                        if (비유동미지급금통합) breakdown.push({ name: '미지급금및기타채무', value: 비유동미지급금통합 });
                        if (비유동장기매입채무) breakdown.push({ name: '장기매입채무', value: 비유동장기매입채무 });
                        if (비유동장기미지급금) breakdown.push({ name: '장기미지급금', value: 비유동장기미지급금 });
                        if (비유동장기미지급비용) breakdown.push({ name: '장기미지급비용', value: 비유동장기미지급비용 });
                        if (비유동장기선수금) breakdown.push({ name: '장기선수금', value: 비유동장기선수금 });
                        if (비유동장기선수수익) breakdown.push({ name: '장기선수수익', value: 비유동장기선수수익 });
                        if (비유동장기예수금) breakdown.push({ name: '장기예수금', value: 비유동장기예수금 });
                        if (비유동임대보증금) breakdown.push({ name: '임대보증금', value: 비유동임대보증금 });
                        break;
                    case 'otherCurrentLiab':
                        const 수탁금 = findValue(bsData, ['수탁금및기타부채'], year) || 0;
                        const 유동리스 = findValue(bsData, ['유동리스부채'], year) || 0;
                        const 선수금 = findValue(bsData, ['선수금'], year) || 0;
                        const 예수금 = findValue(bsData, ['예수금'], year) || 0;
                        const 선수수익 = findValue(bsData, ['선수수익'], year) || 0;
                        if (수탁금) breakdown.push({ name: '수탁금및기타부채', value: 수탁금 });
                        if (유동리스) breakdown.push({ name: '유동리스부채', value: 유동리스 });
                        if (선수금) breakdown.push({ name: '선수금', value: 선수금 });
                        if (예수금) breakdown.push({ name: '예수금', value: 예수금 });
                        if (선수수익) breakdown.push({ name: '선수수익', value: 선수수익 });
                        break;
                    case 'currentLongTermDebt':
                        const 유동성장기차입금_항목 = findValueWithCategory(bsData, ['유동성장기차입금'], year, '유동부채') || 0;
                        const 유동성장기부채_항목 = findValueWithCategory(bsData, ['유동성장기부채'], year, '유동부채') || 0;
                        if (유동성장기차입금_항목) breakdown.push({ name: '유동성장기차입금', value: 유동성장기차입금_항목 });
                        if (유동성장기부채_항목) breakdown.push({ name: '유동성장기부채', value: 유동성장기부채_항목 });
                        break;
                    case 'currentBonds':
                        const 전환유동 = findValueWithCategory(bsData, ['전환사채'], year, '유동부채') || 0;
                        const 신주유동 = findValueWithCategory(bsData, ['신주인수권부사채'], year, '유동부채') || 0;
                        const 유동사채 = findValueWithCategory(bsData, ['유동성사채', '1년내상환사채', '단기사채'], year, '유동부채') || 0;
                        if (전환유동) breakdown.push({ name: '전환사채', value: 전환유동 });
                        if (신주유동) breakdown.push({ name: '신주인수권부사채', value: 신주유동 });
                        if (유동사채) breakdown.push({ name: '유동성사채', value: 유동사채 });
                        break;
                    case 'nonCurrentBonds':
                        const 사채비유동 = findValueWithCategory(bsData, ['사채'], year, '비유동부채', ['유동성', '차입금']) || 0;
                        const 전환비유동 = findValueWithCategory(bsData, ['전환사채'], year, '비유동부채') || 0;
                        const 신주비유동 = findValueWithCategory(bsData, ['신주인수권부사채'], year, '비유동부채') || 0;
                        if (사채비유동) breakdown.push({ name: '사채', value: 사채비유동 });
                        if (전환비유동) breakdown.push({ name: '전환사채', value: 전환비유동 });
                        if (신주비유동) breakdown.push({ name: '신주인수권부사채', value: 신주비유동 });
                        break;
                    case 'longTermDebt':
                        const 장기차입금_항목 = findValueWithCategory(bsData, ['장기차입금'], year, '비유동부채', ['유동성', '사채']) || 0;
                        if (장기차입금_항목) breakdown.push({ name: '장기차입금', value: 장기차입금_항목 });
                        break;
                    case 'otherEquity':
                        // 기타자본구성요소 = 자본잉여금 + 기타자본 + 기타포괄손익누계액 + 재평가잉여금
                        const 자본잉여금 = findValue(bsData, ['자본잉여금'], year) || 0;
                        const 기타자본 = findValue(bsData, ['기타자본', '기타자본항목'], year) || 0;
                        const 기타포괄손익 = findValue(bsData, ['기타포괄손익누계액'], year) || 0;
                        const 재평가잉여금 = findValue(bsData, ['재평가잉여금'], year) || 0;
                        if (자본잉여금) breakdown.push({ name: '자본잉여금', value: 자본잉여금 });
                        if (기타자본) breakdown.push({ name: '기타자본', value: 기타자본 });
                        if (기타포괄손익) breakdown.push({ name: '기타포괄손익누계액', value: 기타포괄손익 });
                        if (재평가잉여금) breakdown.push({ name: '재평가잉여금', value: 재평가잉여금 });
                        break;
                    case 'longTermInvestments':
                        // 장기투자자산 = 장기금융상품 + 장기투자증권 + 관계기업투자
                        const 장기금융상품 = findValue(bsData, ['장기금융상품'], year) || 0;
                        const 장기투자증권 = findValue(bsData, ['장기투자증권', '매도가능증권', '기타포괄손익공정가치측정금융자산', 'FVOCI금융자산'], year) || 0;
                        const 관계기업투자 = findValue(bsData, ['관계기업투자', '종속기업투자', '지분법적용투자주식'], year) || 0;
                        if (장기금융상품) breakdown.push({ name: '장기금융상품', value: 장기금융상품 });
                        if (장기투자증권) breakdown.push({ name: '장기투자증권', value: 장기투자증권 });
                        if (관계기업투자) breakdown.push({ name: '관계기업투자', value: 관계기업투자 });
                        break;
                }
                return breakdown;
            }

            // 재무상태표 합산 계산 함수
            function calcBsValue(calcType, year) {
                switch(calcType) {
                    case 'tradeReceivables':
                        // 매출채권및기타채권: 통합 항목 우선, 없으면 개별 항목 합산
                        const 통합매출채권 = findValue(bsData, ['매출채권및기타채권', '매출채권및기타유동채권'], year);
                        if (통합매출채권) {
                            return 통합매출채권;
                        }
                        // 개별 항목 합산
                        const 매출채권 = findValue(bsData, ['매출채권'], year, ['대손', '처분']) || 0;
                        const 미수금 = findValue(bsData, ['미수금'], year) || 0;
                        const 미수수익 = findValue(bsData, ['미수수익'], year) || 0;
                        return 매출채권 + 미수금 + 미수수익;
                    case 'otherCurrentAssets':
                        // 기타비금융자산: 통합 항목 우선, 없으면 개별 항목 합산
                        const 통합기타자산 = findValue(bsData, ['기타자산', '기타유동자산'], year, ['비유동']);
                        if (통합기타자산) {
                            return 통합기타자산;
                        }
                        // 개별 항목 합산
                        const 선급금 = findValue(bsData, ['선급금'], year) || 0;
                        const 선급비용 = findValue(bsData, ['선급비용'], year) || 0;
                        return 선급금 + 선급비용;
                    case 'tradePayables': {
                        // 매입채무및기타채무 = 매입채무 + 미지급금 + 미지급비용
                        const 매입채무 = findValue(bsData, ['매입채무'], year) || 0;
                        const 미지급금 = findValue(bsData, ['미지급금'], year, ['장기']) || 0;
                        const 미지급비용 = findValue(bsData, ['미지급비용'], year) || 0;
                        return 매입채무 + 미지급금 + 미지급비용;
                    }
                    case 'otherCurrentLiab':
                        // 기타유동부채 = 수탁금및기타부채 + 유동리스부채 + 선수금 + 예수금 + 선수수익 등
                        const 수탁금및기타부채 = findValue(bsData, ['수탁금및기타부채'], year) || 0;
                        const 유동리스부채 = findValue(bsData, ['유동리스부채'], year) || 0;
                        const 선수금 = findValue(bsData, ['선수금'], year) || 0;
                        const 예수금 = findValue(bsData, ['예수금'], year) || 0;
                        const 선수수익 = findValue(bsData, ['선수수익'], year) || 0;
                        const 기타유동부채 = findValue(bsData, ['기타유동부채'], year) || 0;
                        return 수탁금및기타부채 + 유동리스부채 + 선수금 + 예수금 + 선수수익 + 기타유동부채;
                    case 'currentLongTermDebt':
                        // 유동성장기차입금 = 유동성장기차입금 + 유동성장기부채
                        const 유동성장기차입금 = findValueWithCategory(bsData, ['유동성장기차입금'], year, '유동부채') || 0;
                        const 유동성장기부채 = findValueWithCategory(bsData, ['유동성장기부채'], year, '유동부채') || 0;
                        return 유동성장기차입금 + 유동성장기부채;
                    case 'currentBonds':
                        // 유동성사채 = 유동부채의 (전환사채 + 신주인수권부사채 + 유동성사채)
                        const 전환사채_유동 = findValueWithCategory(bsData, ['전환사채'], year, '유동부채') || 0;
                        const 신주인수권부사채_유동 = findValueWithCategory(bsData, ['신주인수권부사채'], year, '유동부채') || 0;
                        const 유동성사채 = findValueWithCategory(bsData, ['유동성사채', '1년내상환사채', '단기사채', '유동사채'], year, '유동부채') || 0;
                        return 전환사채_유동 + 신주인수권부사채_유동 + 유동성사채;
                    case 'nonCurrentBonds':
                        // 비유동 사채 = 비유동부채의 (사채 + 전환사채 + 신주인수권부사채)
                        // '차입금' 제외 - "장기차입금(사채 포함)"과 같은 통합 항목 제외
                        const 사채_비유동 = findValueWithCategory(bsData, ['사채'], year, '비유동부채', ['유동성', '차입금']) || 0;
                        const 전환사채_비유동 = findValueWithCategory(bsData, ['전환사채'], year, '비유동부채') || 0;
                        const 신주인수권부사채_비유동 = findValueWithCategory(bsData, ['신주인수권부사채'], year, '비유동부채') || 0;
                        return 사채_비유동 + 전환사채_비유동 + 신주인수권부사채_비유동;
                    case 'longTermDebt':
                        // 장기차입금 = 비유동부채의 장기차입금
                        // '사채' 제외 - "장기차입금(사채 포함)"과 같은 통합 항목 제외
                        const 장기차입금 = findValueWithCategory(bsData, ['장기차입금'], year, '비유동부채', ['유동성', '사채']) || 0;
                        return 장기차입금;
                    case 'currentTradePayables': {
                        // 유동 매입채무및기타채무: 통합 항목 우선, 없으면 개별 항목 합산
                        const 통합유동매입채무 = findValueWithCategory(bsData, ['미지급금및기타채무'], year, '유동부채');
                        if (통합유동매입채무) {
                            console.log(`[유동 매입채무및기타채무] ${year}: ${통합유동매입채무} (통합항목)`);
                            return 통합유동매입채무;
                        }
                        // 개별 항목 합산 (넥시스 등)
                        const 매입채무 = findValueWithCategory(bsData, ['매입채무'], year, '유동부채') || 0;
                        const 미지급금 = findValueWithCategory(bsData, ['미지급금'], year, '유동부채') || 0;
                        const 미지급비용 = findValueWithCategory(bsData, ['미지급비용'], year, '유동부채') || 0;
                        const 선수금 = findValueWithCategory(bsData, ['선수금'], year, '유동부채') || 0;
                        const 선수수익 = findValueWithCategory(bsData, ['선수수익'], year, '유동부채') || 0;
                        const 예수금 = findValueWithCategory(bsData, ['예수금'], year, '유동부채') || 0;
                        const 예수보증금 = findValueWithCategory(bsData, ['예수보증금'], year, '유동부채') || 0;
                        const 연차충당부채 = findValueWithCategory(bsData, ['연차충당부채'], year, '유동부채') || 0;
                        const 개별합계 = 매입채무 + 미지급금 + 미지급비용 + 선수금 + 선수수익 + 예수금 + 예수보증금 + 연차충당부채;
                        console.log(`[유동 매입채무및기타채무] ${year}: ${개별합계} (개별합산: 매입${매입채무}+미지급금${미지급금}+미지급비용${미지급비용}+선수금${선수금}+선수수익${선수수익}+예수금${예수금}+예수보증금${예수보증금}+연차${연차충당부채})`);
                        return 개별합계;
                    }
                    case 'nonCurrentTradePayables': {
                        // 비유동 매입채무및기타채무: 통합 항목 우선, 없으면 개별 항목 합산
                        const 통합비유동매입채무 = findValueWithCategory(bsData, ['미지급금및기타채무'], year, '비유동부채');
                        if (통합비유동매입채무) {
                            console.log(`[비유동 매입채무및기타채무] ${year}: ${통합비유동매입채무} (통합항목)`);
                            return 통합비유동매입채무;
                        }
                        // 개별 항목 합산 (유동부채와 동일한 논리)
                        const 장기매입채무 = findValueWithCategory(bsData, ['매입채무', '장기매입채무'], year, '비유동부채') || 0;
                        const 장기미지급금 = findValueWithCategory(bsData, ['장기미지급금'], year, '비유동부채') || 0;
                        const 장기미지급비용 = findValueWithCategory(bsData, ['장기미지급비용'], year, '비유동부채') || 0;
                        const 장기선수금 = findValueWithCategory(bsData, ['장기선수금'], year, '비유동부채') || 0;
                        const 장기선수수익 = findValueWithCategory(bsData, ['장기선수수익'], year, '비유동부채') || 0;
                        const 장기예수금 = findValueWithCategory(bsData, ['장기예수금'], year, '비유동부채') || 0;
                        const 임대보증금 = findValueWithCategory(bsData, ['임대보증금', '장기예수보증금'], year, '비유동부채') || 0;
                        const 비유동개별합계 = 장기매입채무 + 장기미지급금 + 장기미지급비용 + 장기선수금 + 장기선수수익 + 장기예수금 + 임대보증금;
                        console.log(`[비유동 매입채무및기타채무] ${year}: ${비유동개별합계} (개별합산: 장기매입${장기매입채무}+장기미지급금${장기미지급금}+장기미지급비용${장기미지급비용}+장기선수금${장기선수금}+장기선수수익${장기선수수익}+장기예수금${장기예수금}+임대보증금${임대보증금})`);
                        return 비유동개별합계;
                    }
                    case 'otherEquity':
                        // 기타자본구성요소 = 자본잉여금 + 기타자본 + 기타포괄손익누계액 + 재평가잉여금
                        const 자본잉여금 = findValue(bsData, ['자본잉여금'], year) || 0;
                        const 기타자본 = findValue(bsData, ['기타자본', '기타자본항목'], year) || 0;
                        const 기타포괄손익 = findValue(bsData, ['기타포괄손익누계액'], year) || 0;
                        const 재평가잉여금 = findValue(bsData, ['재평가잉여금'], year) || 0;
                        return 자본잉여금 + 기타자본 + 기타포괄손익 + 재평가잉여금;
                    case 'longTermInvestments':
                        // 장기투자자산 = 장기금융상품 + 장기투자증권 + 관계기업투자
                        // 통합 항목 우선 확인
                        const 장기투자자산통합 = findValue(bsData, ['장기투자자산', '투자자산'], year) || 0;
                        if (장기투자자산통합) return 장기투자자산통합;

                        // 개별 항목 합산
                        const 장기금융상품 = findValue(bsData, ['장기금융상품'], year) || 0;
                        const 장기투자증권 = findValue(bsData, ['장기투자증권', '매도가능증권', '기타포괄손익공정가치측정금융자산', 'FVOCI금융자산'], year) || 0;
                        const 관계기업투자 = findValue(bsData, ['관계기업투자', '종속기업투자', '지분법적용투자주식'], year) || 0;
                        return 장기금융상품 + 장기투자증권 + 관계기업투자;
                    default:
                        return null;
                }
            }

            // ========== 판관비 동적 항목 선택 (전체 연도 평균 기준) ==========
            function selectTopSgaItems(isData, years) {
                // 모든 가능한 판관비 항목 정의 (is_sum: true면 복수 키워드 합산)
                const sgaCandidates = {
                    '인건비': { keywords: [['급여'], ['퇴직급여'], ['복리후생비']], excludes: [['퇴직', '연차'], [], []], isSum: true },
                    '임차료비용': { keywords: [['지급임차료', '임차료']], excludes: [[]], isSum: false },
                    '수수료비용': { keywords: [['판매수수료'], ['지급수수료', '수수료']], excludes: [[], []], isSum: true },
                    '보험료': { keywords: [['보험료']], excludes: [[]], isSum: false },
                    '여비교통비': { keywords: [['여비교통비']], excludes: [[]], isSum: false },
                    '연구비': { keywords: [['경상연구개발비'], ['경상시험연구비'], ['연구개발비']], excludes: [[], [], []], isSum: true },
                    '감가상각비': { keywords: [['감가상각비']], excludes: [['무형']], isSum: false },
                    '무형자산상각비': { keywords: [['무형자산상각비']], excludes: [[]], isSum: false },
                    '접대비': { keywords: [['접대비']], excludes: [[]], isSum: false },
                    '통신비': { keywords: [['통신비']], excludes: [[]], isSum: false },
                    '세금과공과': { keywords: [['세금과공과']], excludes: [[]], isSum: false },
                    '차량유지비': { keywords: [['차량유지비']], excludes: [[]], isSum: false },
                    '운반비': { keywords: [['운반비']], excludes: [[]], isSum: false },
                    '교육훈련비': { keywords: [['교육훈련비']], excludes: [[]], isSum: false },
                    '도서인쇄비': { keywords: [['도서인쇄비']], excludes: [[]], isSum: false },
                    '사무용품비': { keywords: [['사무용품비']], excludes: [[]], isSum: false },
                    '소모품비': { keywords: [['소모품비']], excludes: [[]], isSum: false },
                    '보관료': { keywords: [['보관료']], excludes: [[]], isSum: false },
                    '광고선전비': { keywords: [['광고선전비']], excludes: [[]], isSum: false },
                    '판매촉진비': { keywords: [['판매촉진비']], excludes: [[]], isSum: false },
                    '건물관리비': { keywords: [['건물관리비']], excludes: [[]], isSum: false },
                    '대손상각비': { keywords: [['대손상각비']], excludes: [[]], isSum: false },
                    '협회비': { keywords: [['협회비']], excludes: [[]], isSum: false },
                    '사택관리비': { keywords: [['사택관리비']], excludes: [[]], isSum: false },
                    '폐기물처리비': { keywords: [['폐기물처리비']], excludes: [[]], isSum: false },
                    '주식보상비용': { keywords: [['주식보상비용']], excludes: [[]], isSum: false }
                };

                // 각 항목별로 전체 연도의 값을 수집
                const sgaItemValues = {};

                for (const [itemName, itemConfig] of Object.entries(sgaCandidates)) {
                    sgaItemValues[itemName] = [];

                    for (const year of years) {
                        let value = 0;

                        if (itemConfig.isSum) {
                            // 복수 키워드 합산
                            for (let i = 0; i < itemConfig.keywords.length; i++) {
                                const val = findValueIS(isData, itemConfig.keywords[i], year, itemConfig.excludes[i]) || 0;
                                value += val;
                            }
                        } else {
                            // 단일 키워드
                            value = findValueIS(isData, itemConfig.keywords[0], year, itemConfig.excludes[0]) || 0;
                        }

                        sgaItemValues[itemName].push(value);
                    }
                }

                // 각 항목의 평균 계산 및 정렬
                const sgaItemAverages = {};
                for (const [itemName, values] of Object.entries(sgaItemValues)) {
                    const sum = values.reduce((a, b) => a + b, 0);
                    const avg = values.length > 0 ? sum / values.length : 0;
                    sgaItemAverages[itemName] = avg;
                }

                // 평균 기준으로 내림차순 정렬
                const sortedSgaItems = Object.entries(sgaItemAverages)
                    .filter(([name, avg]) => avg > 0)  // 값이 있는 항목만
                    .sort((a, b) => b[1] - a[1]);  // 평균 내림차순

                // 상위 8개 항목 선택
                const topSgaItems = sortedSgaItems.slice(0, 8).map(([name]) => name);

                console.log('=== 동적 판관비 항목 선택 ===');
                console.log('선택된 항목 (상위 8개):', topSgaItems);
                sortedSgaItems.slice(0, 8).forEach(([name, avg]) => {
                    console.log(`  ${name}: 평균 ${avg.toFixed(2)}억원`);
                });

                return { topSgaItems, sgaCandidates, sgaItemValues };
            }

            // ========== 새로운 단순화된 렌더링 (vcm_display 사용) ==========
            const vcmDisplay = previewData?.vcm_display || [];
            const vcmMeta = previewData?.vcm || [];

            // vcm_display가 있으면 단순화된 렌더링 사용
            if (vcmDisplay.length > 0 && vcmMeta.length > 0) {
                console.log('[VCM] 단순화된 렌더링 사용 (vcm_display 기반)');
                console.log('[VCM DEBUG] vcmMeta 샘플 (처음 10개):', vcmMeta.slice(0, 10).map(r => ({ 항목: r['항목'], 타입: r['타입'], 부모: r['부모'] })));
                console.log('[VCM DEBUG] vcmDisplay 샘플 (처음 10개):', vcmDisplay.slice(0, 10).map(r => r['항목']));

                // 타입 조회 헬퍼 (vcm 메타데이터에서)
                function getItemType(itemName) {
                    const meta = vcmMeta.find(r => r['항목'] === itemName);
                    if (!meta) {
                        console.log('[VCM DEBUG] 타입 찾기 실패:', itemName, '| vcmMeta에서 찾은 항목들:', vcmMeta.filter(r => r['항목']?.includes(itemName.trim().substring(0,5))).map(r => r['항목']));
                    }
                    return meta ? meta['타입'] : 'item';
                }

                // 부모 조회 헬퍼 (툴팁용)
                function getItemParent(itemName) {
                    const meta = vcmMeta.find(r => r['항목'] === itemName);
                    return meta ? meta['부모'] : '';
                }

                // 자식 항목들 조회 (툴팁용)
                function getChildItems(parentName, year) {
                    // 부모 비교 시 trim해서 비교 (들여쓰기 무시)
                    const parentTrimmed = (parentName || '').trim();
                    const children = vcmMeta.filter(r => {
                        const rParent = (r['부모'] || '').trim();
                        return rParent === parentTrimmed;
                    });
                    return children.map(c => {
                        // 항목명 trim해서 비교
                        const itemName = (c['항목'] || '').trim();
                        // vcmMeta에서만 가져옴 (원 단위) - 툴팁 생성 시 백만원 변환
                        const val = c[year];
                        return {
                            name: itemName.replace(' [NWC]', '').replace(' [NetDebt]', ''),
                            value: val
                        };
                    }).filter(c => c.value !== null && c.value !== undefined && c.value !== '' && c.value !== 0);
                }

                // 타입별 CSS 클래스
                function getRowClass(type) {
                    switch(type) {
                        case 'category': return 'category-row';
                        case 'total': return 'total-row';
                        case 'highlight': return 'total-row highlight-row';
                        case 'percent': return 'percent-row';
                        default: return '';
                    }
                }

                function getTdClass(type) {
                    return (type === 'subitem' || type === 'percent') ? 'sub-item' : '';
                }

                // 테이블 헤더 (단위: 백만원 - 백엔드에서 변환됨)
                let headerHtml = `<tr><th>(단위: 백만원)</th>`;
                years.forEach(y => { headerHtml += `<th>${y}</th>`; });
                headerHtml += '</tr>';

                // ========== 재무상태표 렌더링 ==========
                // 재무상태표: 유동자산 ~ 부채와자본총계 + NWC + Net Debt
                const bsEndItems = ['NWC', 'Net Debt'];  // 재무상태표 마지막에 포함될 항목
                const isStartNames = ['매출'];
                let bsTableHtml = '<table class="vcm-table"><thead>' + headerHtml + '</thead><tbody>';

                for (const row of vcmDisplay) {
                    const itemName = row['항목'];
                    if (!itemName) continue;

                    // 손익계산서 시작 지점 (매출)에서 BS 종료
                    if (itemName.trim() === '매출') break;

                    // NWC/Net Debt 하위항목은 제외 (툴팁에서만 표시)
                    if (itemName.includes('[NWC]') || itemName.includes('[NetDebt]')) continue;

                    const itemType = getItemType(itemName);

                    // 표시 연도에 값이 하나도 없는 하위항목은 스킵 (최근 5년 기준)
                    if (itemType === 'subitem' || itemType === 'item') {
                        const hasDisplayValue = years.some(y => {
                            const v = row[y];
                            return v !== null && v !== undefined && v !== '' && v !== 0;
                        });
                        if (!hasDisplayValue) continue;
                    }

                    const rowClass = getRowClass(itemType);
                    const tdClass = getTdClass(itemType);

                    const parentName = itemName.trim();

                    bsTableHtml += `<tr class="${rowClass}"><td class="${tdClass}">${itemName}</td>`;
                    years.forEach(y => {
                        let val = row[y];
                        let tooltip = '';
                        let hasChildren = false;

                        // BS 대분류는 툴팁 불필요 (이미 하위 항목이 테이블에 표시됨)
                        const bsCategoriesNoTooltip = ['유동자산', '비유동자산', '유동부채', '비유동부채'];
                        const skipTooltip = bsCategoriesNoTooltip.includes(parentName.trim());

                        // 각 연도별 자식 항목 툴팁 생성 (BS 대분류 제외)
                        if (!skipTooltip) {
                            const children = getChildItems(parentName, y);
                            if (children.length > 0) {
                                hasChildren = true;
                                // 중복 항목명 필터링: 같은 이름의 항목은 하나만 유지 (값이 같아도 다른 이름이면 모두 표시)
                                const seenNames = new Map(); // name -> item
                                for (const c of children) {
                                    const nameKey = c.name;
                                    if (!seenNames.has(nameKey)) {
                                        seenNames.set(nameKey, c);
                                    }
                                }
                                const filteredChildren = Array.from(seenNames.values());
                                let childSum = 0;
                                const childLines = filteredChildren.map(c => {
                                    let rawVal = typeof c.value === 'number' ? c.value : parseFloat(String(c.value).replace(/,/g, ''));
                                    // Frontdata는 항상 원 단위 - 백만원으로 변환
                                    let fmtVal;
                                    if (!isNaN(rawVal)) {
                                        const millions = Math.round(rawVal / 1000000);
                                        childSum += millions;
                                        // 백만원 미만(0으로 반올림)이면 원 단위 괄호 표시
                                        if (millions === 0 && rawVal > 0) {
                                            fmtVal = `(${Math.round(rawVal).toLocaleString('ko-KR')}원)`;
                                        } else {
                                            fmtVal = millions.toLocaleString('ko-KR');
                                        }
                                    } else {
                                        fmtVal = c.value;
                                    }
                                    return `${c.name}: ${fmtVal}`;
                                });
                                const displayTotal = (val === null || val === undefined || val === '') ? childSum : val;
                                tooltip = `[${y} 세부내역]\n${childLines.join('\n')}\n─────────\n합계: ${typeof displayTotal === 'number' ? Math.round(displayTotal).toLocaleString('ko-KR') : displayTotal}`;
                            }
                        }

                        // 숫자인 경우 천 단위 콤마 추가 + 음수는 빨간색
                        let displayVal = val;
                        let isNegative = false;
                        if (typeof val === 'number' && !isNaN(val)) {
                            isNegative = val < 0;
                            displayVal = val.toLocaleString('ko-KR');
                        } else if (val === null || val === undefined) {
                            displayVal = '';
                        }
                        const negativeStyle = isNegative ? 'color: #dc2626;' : '';
                        bsTableHtml += `<td class="${hasChildren ? 'calc-cell' : ''}" title="${tooltip}" style="${negativeStyle}">${displayVal}</td>`;
                    });
                    bsTableHtml += '</tr>';
                }
                bsTableHtml += '</tbody></table>';

                // ========== 손익계산서 렌더링 ==========
                let isTableHtml = '<table class="vcm-table"><thead>' + headerHtml + '</thead><tbody>';
                let foundIsStart = false;

                for (const row of vcmDisplay) {
                    const itemName = row['항목'];
                    if (!itemName) continue;

                    // IS 시작 지점 (매출부터)
                    if (itemName.trim() === '매출') foundIsStart = true;
                    if (!foundIsStart) continue;

                    // NWC, Net Debt 관련 항목은 재무상태표에 표시되므로 제외
                    if (itemName.includes('NWC') || itemName.includes('Net Debt')) continue;
                    if (itemName.includes('[NWC]') || itemName.includes('[NetDebt]')) continue;

                    const itemType = getItemType(itemName);

                    // 표시 연도에 값이 하나도 없는 하위항목은 스킵 (최근 5년 기준)
                    if (itemType === 'subitem' || itemType === 'item') {
                        const hasDisplayValue = years.some(y => {
                            const v = row[y];
                            return v !== null && v !== undefined && v !== '' && v !== 0;
                        });
                        if (!hasDisplayValue) continue;
                    }

                    const rowClass = getRowClass(itemType);
                    const tdClass = getTdClass(itemType);

                    const parentName = itemName.trim();

                    isTableHtml += `<tr class="${rowClass}"><td class="${tdClass}">${itemName}</td>`;
                    years.forEach(y => {
                        let val = row[y];
                        let tooltip = '';
                        let hasChildren = false;

                        // EBITDA 특별 처리: 영업이익 + 감가상각비 + 무형자산상각비
                        if (parentName === 'EBITDA') {
                            // 먼저 [EBITDA] 접두사 항목에서 찾기 (새 방식)
                            const ebitda영업이익Row = vcmMeta.find(r => r['항목'] && r['항목'].includes('[EBITDA]영업이익'));
                            const ebitda감가상각비Row = vcmMeta.find(r => r['항목'] && r['항목'].includes('[EBITDA]감가상각비'));
                            const ebitda무형자산상각비Row = vcmMeta.find(r => r['항목'] && r['항목'].includes('[EBITDA]무형자산상각비'));

                            // fallback: 기존 방식
                            const 영업이익Row = ebitda영업이익Row || vcmDisplay.find(r => r['항목'] === '영업이익');
                            const 감가상각비Row = ebitda감가상각비Row || vcmMeta.find(r => r['항목'] && r['항목'].includes('감가상각비') && !r['항목'].includes('무형') && !r['항목'].includes('[EBITDA]'));
                            const 무형자산상각비Row = ebitda무형자산상각비Row || vcmMeta.find(r => r['항목'] && r['항목'].includes('무형자산상각비') && !r['항목'].includes('[EBITDA]'));

                            // 값 추출 및 백만원 변환 (소액은 원 단위 괄호 표시)
                            const toMillionsWithFormat = (v) => {
                                if (v === null || v === undefined) return { num: 0, fmt: '0' };
                                let raw = typeof v === 'number' ? v : parseFloat(String(v).replace(/,/g, ''));
                                if (isNaN(raw)) return { num: 0, fmt: '0' };
                                const millions = Math.round(raw / 1000000);
                                // 백만원 미만이면 원 단위 괄호 표시
                                if (millions === 0 && raw > 0) {
                                    return { num: 0, fmt: `(${Math.round(raw).toLocaleString('ko-KR')}원)` };
                                }
                                return { num: millions, fmt: millions.toLocaleString('ko-KR') };
                            };
                            const 영업이익 = toMillionsWithFormat(영업이익Row ? 영업이익Row[y] : 0);
                            const 감가상각비 = toMillionsWithFormat(감가상각비Row ? 감가상각비Row[y] : 0);
                            const 무형자산상각비 = toMillionsWithFormat(무형자산상각비Row ? 무형자산상각비Row[y] : 0);

                            if (영업이익.num || 감가상각비.num || 무형자산상각비.num || 영업이익.fmt.includes('원') || 감가상각비.fmt.includes('원') || 무형자산상각비.fmt.includes('원')) {
                                hasChildren = true;
                                tooltip = `[${y} 계산식]\n영업이익: ${영업이익.fmt}\n+ 감가상각비: ${감가상각비.fmt}\n+ 무형자산상각비: ${무형자산상각비.fmt}\n─────────\n= EBITDA: ${typeof val === 'number' ? Math.round(val).toLocaleString('ko-KR') : val}`;
                            }
                        } else {
                            // IS 대분류는 툴팁 불필요 (이미 하위 항목이 테이블에 표시됨)
                            const isCategoriesNoTooltip = ['매출', '매출원가', '판매비와관리비', '영업외수익', '영업외비용'];
                            const skipTooltip = isCategoriesNoTooltip.includes(parentName.trim());

                            // 일반 항목: 자식 항목 툴팁 생성 (IS 대분류 제외)
                            if (!skipTooltip) {
                                const children = getChildItems(parentName, y);
                                if (children.length > 0) {
                                    hasChildren = true;
                                    // 중복 항목명 필터링: 같은 이름의 항목은 하나만 유지 (값이 같아도 다른 이름이면 모두 표시)
                                    const seenNames = new Map();
                                    for (const c of children) {
                                        const nameKey = c.name;
                                        if (!seenNames.has(nameKey)) {
                                            seenNames.set(nameKey, c);
                                        }
                                    }
                                    const filteredChildren = Array.from(seenNames.values());
                                    // 자녀 값 합계 계산 (원 단위 → 백만원 변환)
                                    let childSum = 0;
                                    const childLines = filteredChildren.map(c => {
                                        let rawVal = typeof c.value === 'number' ? c.value : parseFloat(String(c.value).replace(/,/g, ''));
                                        // Frontdata는 항상 원 단위 - 백만원으로 변환
                                        let fmtVal;
                                        if (!isNaN(rawVal)) {
                                            const millions = Math.round(rawVal / 1000000);
                                            childSum += millions;
                                            // 백만원 미만(0으로 반올림)이면 원 단위 괄호 표시
                                            if (millions === 0 && rawVal > 0) {
                                                fmtVal = `(${Math.round(rawVal).toLocaleString('ko-KR')}원)`;
                                            } else {
                                                fmtVal = millions.toLocaleString('ko-KR');
                                            }
                                        } else {
                                            fmtVal = c.value;
                                        }
                                        return `${c.name}: ${fmtVal}`;
                                    });
                                    // 부모 값이 없으면 자녀 합계로 대체
                                    const displayTotal = (val === null || val === undefined || val === '') ? childSum : val;
                                    tooltip = `[${y} 세부내역]\n${childLines.join('\n')}\n─────────\n합계: ${typeof displayTotal === 'number' ? Math.round(displayTotal).toLocaleString('ko-KR') : displayTotal}`;
                                    // 부모 값이 없을 때 자녀 합계를 val에 할당
                                    if (val === null || val === undefined || val === '') {
                                        val = childSum > 0 ? childSum : val;
                                    }
                                }
                            }
                        }

                        // 숫자인 경우 천 단위 콤마 추가 + 음수는 빨간색
                        let displayVal = val;
                        let isNegative = false;
                        if (typeof val === 'number' && !isNaN(val)) {
                            isNegative = val < 0;
                            displayVal = val.toLocaleString('ko-KR');
                        } else if (val === null || val === undefined || val === '') {
                            displayVal = '';
                        }
                        const negativeStyle = isNegative ? 'color: #dc2626;' : '';
                        isTableHtml += `<td class="${hasChildren ? 'calc-cell' : ''}" title="${tooltip}" style="${negativeStyle}">${displayVal}</td>`;
                    });
                    isTableHtml += '</tr>';
                }
                isTableHtml += '</tbody></table>';

                // 재무분석 AI 결과가 있으면 3번째 박스로 추가
                const analysisResultEl = document.getElementById('analysisResult');
                const hasAnalysisResult = analysisResultEl && analysisResultEl.innerHTML.trim() !== '' && analysisResultEl.style.display !== 'none';
                console.log('[VCM-vcm_display] hasAnalysisResult:', hasAnalysisResult,
                    'el존재:', !!analysisResultEl,
                    'innerHTML길이:', analysisResultEl?.innerHTML?.trim()?.length || 0,
                    'display:', analysisResultEl?.style?.display);

                let analysisBoxHtml = '';
                if (hasAnalysisResult) {
                    analysisBoxHtml = `
                        <div class="vcm-box vcm-box-analysis">
                            <div class="vcm-title">재무분석 AI</div>
                            <div class="vcm-analysis-content">
                                ${analysisResultEl.innerHTML}
                            </div>
                        </div>
                    `;
                }

                // 최종 HTML 반환 (가로 배치, 각각 별개 컨테이너)
                return `
                    <div class="vcm-wrapper">
                        <div class="vcm-box">
                            <div class="vcm-title">재무상태표</div>
                            ${bsTableHtml}
                        </div>
                        <div class="vcm-box">
                            <div class="vcm-title">손익계산서</div>
                            ${isTableHtml}
                        </div>
                        ${analysisBoxHtml}
                    </div>
                `;
            }

            // ========== 기존 복잡한 렌더링 (fallback) ==========
            console.log('[VCM] 기존 렌더링 사용 (vcm_display 없음)');

            // 동적 bsItems 생성 - VCM 데이터에서 직접 읽기 (백엔드 타입 필드 활용)
            const vcmData = previewData?.vcm || [];
            const bsItems = [];

            // VCM 데이터에서 재무상태표 항목만 추출 (NWC 이전까지)
            const stopNames = ['NWC', 'Net Debt'];

            for (const row of vcmData) {
                const name = row['항목'];
                const itemType = row['타입'] || 'item';  // 백엔드에서 설정한 타입 사용

                // NWC, Net Debt 이후는 손익계산서이므로 제외 (정확히 일치할 때만)
                if (stopNames.includes(name)) break;
                if (!name) continue;

                // 백엔드 타입에 따라 분류 (손익계산서와 동일한 방식)
                const isCategory = itemType === 'category';
                const isTotal = itemType === 'total' || itemType === 'highlight';
                const isSubItem = itemType === 'subitem';
                const isHighlight = itemType === 'highlight';

                bsItems.push({
                    name: name,
                    isCategory: isCategory,
                    isTotal: isTotal,
                    isSubItem: isSubItem,
                    isHighlight: isHighlight,
                    fromVcm: true
                });
            }

            // VCM 데이터가 없으면 기본 구조 사용 (fallback)
            if (bsItems.length === 0) {
                bsItems.push(
                    { name: '유동자산', keywords: ['유동자산'], excludes: ['비유동'], isCategory: true },
                    { name: '현금및현금성자산', keywords: ['현금및현금성자산'], isSubItem: true },
                    { name: '비유동자산', keywords: ['비유동자산'], isCategory: true },
                    { name: '자산총계', keywords: ['자산총계'], isTotal: true },
                    { name: '유동부채', keywords: ['유동부채'], excludes: ['비유동'], isCategory: true },
                    { name: '비유동부채', keywords: ['비유동부채'], isCategory: true },
                    { name: '부채총계', keywords: ['부채총계'], isTotal: true },
                    { name: '자본총계', keywords: ['자본총계'], isTotal: true }
                );
            }

            console.log('[VCM] 동적 bsItems 생성:', bsItems.length, '개 항목');

            // 판관비 동적 항목 선택
            const { topSgaItems, sgaCandidates, sgaItemValues } = selectTopSgaItems(isData, years);

            // 손익계산서 항목 정의 (동적 생성)
            const isItems = [
                { name: '매출', calc: 'revenue', isCategory: true },
                { name: '상품매출', keywords: ['상품매출액', '상품매출'], excludes: ['원가'], isSubItem: true },
                { name: '제품매출', keywords: ['제품매출액', '제품매출'], excludes: ['원가'], isSubItem: true },
                { name: '기타매출', keywords: ['기타매출액', '기타매출'], excludes: ['원가'], isSubItem: true },
                { name: '매출원가', calc: 'cogs', isCategory: true },
                { name: '상품매출원가', keywords: ['상품매출원가'], isSubItem: true },
                { name: '제품매출원가', keywords: ['제품매출원가'], isSubItem: true },
                { name: '매출총이익', calc: 'grossProfit', isTotal: true },
                { name: '판매비와관리비', calc: 'sga', isCategory: true }
            ];

            // 동적 판관비 항목 추가 (상위 8개)
            for (const itemName of topSgaItems) {
                isItems.push({ name: itemName, calc: `dynamic_sga_${itemName}`, isSubItem: true });
            }

            // 기타판매비와관리비 항상 마지막에 추가
            isItems.push({ name: '기타판매비와관리비', calc: 'otherSga', isSubItem: true });

            // 나머지 손익계산서 항목 추가
            isItems.push(
                { name: '영업이익', calc: 'operatingIncome', isTotal: true, isHighlight: true },
                { name: '영업외수익', calc: 'otherIncome', isSubItem: true },
                { name: '금융수익', calc: 'financeIncome', isSubItem: true },
                { name: '영업외비용', calc: 'otherExpense', isSubItem: true },
                { name: '금융비용', calc: 'financeCost', isSubItem: true },
                { name: '법인세비용차감전이익', calc: 'ebt', isSubItem: true },
                { name: '법인세비용', calc: 'tax', isSubItem: true },
                { name: '당기순이익', calc: 'netIncome', isTotal: true, isHighlight: true }
            );
            
            // 테이블 헤더 생성 (동적 단위 표시)
            let headerHtml = `<tr><th>(단위: ${unitLabel})</th>`;
            years.forEach(y => { headerHtml += `<th>${y}</th>`; });
            headerHtml += '</tr>';
            
            // 재무상태표 테이블 생성
            let bsTableHtml = '<table class="vcm-table"><thead>' + headerHtml + '</thead><tbody>';
            bsItems.forEach(item => {
                // 빈 행 필터링: 모든 연도에 값이 없으면 건너뜀
                const vcmDataList = previewData?.vcm || [];
                const hasAnyValue = years.some(y => {
                    if (item.fromVcm) {
                        const vcmRow = vcmDataList.find(row => row['항목'] === item.name);
                        if (vcmRow && vcmRow[y] !== null && vcmRow[y] !== undefined && vcmRow[y] !== 0) return true;
                    }
                    if (item.calc) {
                        const calcVal = calcBsValue(item.calc, y);
                        if (calcVal !== null && calcVal !== undefined && calcVal !== 0) return true;
                    }
                    return false;
                });

                // 카테고리 행(자산, 부채 등 대분류)은 항상 표시, 나머지는 값이 있을 때만 표시
                if (!item.isCategory && !item.isTotal && !hasAnyValue) {
                    return; // 빈 행 건너뜀
                }

                let rowClass = item.isCategory ? 'category-row' : (item.isTotal ? 'total-row' : '');
                let tdClass = item.isSubItem ? 'sub-item' : '';

                // 합산 항목은 셀 배경색으로 표시
                bsTableHtml += `<tr class="${rowClass}"><td class="${tdClass} account-name">${item.name}</td>`;
                years.forEach(y => {
                    let val;
                    let tooltip = '';
                    let isMultipleItems = false;

                    // VCM 데이터에서 값 찾기
                    const vcmDataList = previewData?.vcm || [];

                    // VCM 동적 항목인 경우 직접 매칭
                    if (item.fromVcm) {
                        const vcmRow = vcmDataList.find(row => row['항목'] === item.name);
                        if (vcmRow && vcmRow[y] !== null && vcmRow[y] !== undefined) {
                            val = parseValue(vcmRow[y]);

                            // 세부 항목 툴팁 생성 (부모가 이 항목인 행들)
                            const children = vcmDataList.filter(row => row['부모'] === item.name);
                            if (children.length > 0) {
                                const childValues = children
                                    .filter(c => c[y] !== null && c[y] !== undefined)
                                    .map(c => `${c['항목']}: ${fmt(parseValue(c[y]))}`);
                                if (childValues.length > 0) {
                                    tooltip = `[${y} 세부내역]\n${childValues.join('\n')}`;
                                    isMultipleItems = true;
                                }
                            }
                        }
                        bsTableHtml += `<td class="${isMultipleItems ? 'calc-cell' : ''}" title="${tooltip}">${fmt(val)}</td>`;
                        return; // 다음 연도로
                    }

                    // 기존 로직 (fromVcm이 아닌 경우)
                    const vcmItemName = item.name === '매입채무및기타채무' ?
                        (rowClass.includes('category') ? null : '매입채무및기타채무') :
                        item.name;

                    // 비유동 매입채무및기타채무는 별도 처리
                    let vcmRow;
                    if (item.name === '매입채무및기타채무' && !item.isCategory) {
                        const currentIndex = bsItems.indexOf(item);
                        let isNonCurrent = false;
                        for (let i = currentIndex - 1; i >= 0; i--) {
                            if (bsItems[i].name === '부채총계') break;
                            if (bsItems[i].name === '비유동부채') {
                                isNonCurrent = true;
                                break;
                            }
                            if (bsItems[i].name === '유동부채') break;
                        }
                        vcmRow = vcmDataList.find(row => row['항목'] === (isNonCurrent ? '매입채무및기타채무[비유동]' : '매입채무및기타채무'));
                    } else if (vcmItemName) {
                        vcmRow = vcmDataList.find(row => row['항목'] === vcmItemName);
                    }

                    if (vcmRow && vcmRow[y] !== null && vcmRow[y] !== undefined) {
                        val = parseValue(vcmRow[y]);
                        if (item.calc) {
                            const breakdown = getBsBreakdown(item.calc, y, vcmDataList);
                            if (!item.isCategory && breakdown.length >= 1) {
                                isMultipleItems = true;
                                tooltip = breakdown.map(b => `${b.name}: ${fmt(b.value)}`).join('\n');
                                tooltip = `[${y} 합산 내역]\n${tooltip}`;
                            }
                        }
                    } else {
                        // VCM에 없으면 기존 로직 사용
                        if (item.calc) {
                            val = calcBsValue(item.calc, y);
                            // 각 연도별 툴팁 생성 (카테고리 행은 제외 - 이미 회색으로 합계임을 표시)
                            const breakdown = getBsBreakdown(item.calc, y, vcmDataList);
                            if (!item.isCategory && breakdown.length >= 1) {  // 1개 이상이면 합산 내역 표시
                                isMultipleItems = true;
                                tooltip = breakdown.map(b => `${b.name}: ${fmt(b.value)}`).join('\n');
                                tooltip = `[${y} 합산 내역]\n${tooltip}`;
                            }
                        } else {
                            val = findValue(bsData, item.keywords, y, item.excludes || []);
                        }
                    }

                    bsTableHtml += `<td class="${isMultipleItems ? 'calc-cell' : ''}" title="${tooltip}">${fmt(val)}</td>`;
                });
                bsTableHtml += '</tr>';
            });
            
            // NWC 추가 (VCM 데이터에서 읽기 또는 계산)
            bsTableHtml += '<tr class="highlight-row"><td>NWC</td>';
            years.forEach(y => {
                let nwc, tooltip;

                // VCM 데이터에서 읽기 시도
                const vcmData = previewData?.vcm || [];
                const nwcRow = vcmData.find(row => row['항목'] === 'NWC');

                if (nwcRow && nwcRow[y] !== null && nwcRow[y] !== undefined) {
                    // 백엔드 VCM 값 사용 (단위 변환)
                    nwc = parseValue(nwcRow[y]);

                    // VCM에서 NWC 세부항목 가져오기
                    const nwcBreakdown = getVcmBreakdown('NWC', y, vcmData);
                    if (nwcBreakdown.length > 0) {
                        tooltip = `[${y} 계산식]\n`;
                        nwcBreakdown.forEach(b => {
                            // 원 단위 → 백만원 변환
                            const valInMillions = Math.round(b.value / 1000000);
                            tooltip += `${b.name.replace(' [NWC]', '')}: ${valInMillions.toLocaleString('ko-KR')}\n`;
                        });
                        tooltip += `= NWC: ${fmt(nwc)}`;
                    } else {
                        const 유동자산 = findValue(bsData, ['Ⅰ.유동자산', '유동자산'], y, ['비유동']) || 0;
                        const 유동부채 = findValue(bsData, ['유동부채'], y, ['비유동']) || 0;
                        tooltip = `[${y} 계산식]\n유동자산: ${fmt(유동자산)}\n- 유동부채: ${fmt(유동부채)}\n= NWC: ${fmt(nwc)}`;
                    }
                } else {
                    // VCM 데이터 없으면 직접 계산
                    const 유동자산 = findValue(bsData, ['Ⅰ.유동자산', '유동자산'], y, ['비유동']) || 0;
                    const 유동부채 = findValue(bsData, ['유동부채'], y, ['비유동']) || 0;
                    nwc = 유동자산 - 유동부채;
                    tooltip = `[${y} 계산식]\n유동자산: ${fmt(유동자산)}\n- 유동부채: ${fmt(유동부채)}\n= NWC: ${fmt(nwc)}`;
                }

                bsTableHtml += `<td class="calc-cell" title="${tooltip}">${fmt(nwc)}</td>`;
            });
            bsTableHtml += '</tr>';
            
            bsTableHtml += '<tr class="highlight-row"><td>Net Debt</td>';
            years.forEach(y => {
                let netDebt, tooltip;

                // VCM 데이터에서 읽기 시도
                const vcmData = previewData?.vcm || [];
                const netDebtRow = vcmData.find(row => row['항목'] === 'Net Debt');

                if (netDebtRow && netDebtRow[y] !== null && netDebtRow[y] !== undefined) {
                    // 백엔드 VCM 값 사용 (단위 변환)
                    netDebt = parseValue(netDebtRow[y]);

                    // VCM에서 Net Debt 세부항목 가져오기
                    const netDebtBreakdown = getVcmBreakdown('Net Debt', y, vcmData);
                    if (netDebtBreakdown.length > 0) {
                        tooltip = `[${y} 계산식]\n`;
                        let 총차입금 = 0;
                        let 총현금성자산 = 0;

                        netDebtBreakdown.forEach(b => {
                            const name = b.name.replace(' [NetDebt]', '');
                            // 원 단위 → 백만원 변환
                            const valInMillions = Math.round(b.value / 1000000);
                            if (b.value > 0) {
                                tooltip += `+ ${name}: ${valInMillions.toLocaleString('ko-KR')}\n`;
                                총차입금 += valInMillions;
                            } else if (b.value < 0) {
                                tooltip += `- ${name}: ${Math.abs(valInMillions).toLocaleString('ko-KR')}\n`;
                                총현금성자산 += Math.abs(valInMillions);
                            }
                        });
                        tooltip += `= Net Debt: ${fmt(netDebt)}`;
                    } else {
                        // VCM 세부항목 없으면 기존 로직
                        const 단기차입금 = findValue(bsData, ['단기차입금'], y) || 0;
                        const 유동성장기차입금 = findValueWithCategory(bsData, ['유동성장기차입금', '유동성장기부채'], y, '유동부채') || 0;
                        const 유동성사채 = findValueWithCategory(bsData, ['유동성사채', '1년내상환사채'], y, '유동부채') || 0;
                        const 사채 = findValueWithCategory(bsData, ['사채'], y, '비유동부채', ['유동성', '차입금']) || 0;
                        const 장기차입금 = findValueWithCategory(bsData, ['장기차입금'], y, '비유동부채', ['유동성', '사채']) || 0;
                        const 총차입금 = 단기차입금 + 유동성장기차입금 + 유동성사채 + 사채 + 장기차입금;
                        const 현금 = findValue(bsData, ['현금및현금성자산'], y) || 0;
                        const 단기금융 = findValue(bsData, ['단기금융상품', '단기금융자산'], y) || 0;
                        const 총현금성자산 = 현금 + 단기금융;

                        tooltip = `[${y} 계산식]\n총차입금:\n`;
                        if (단기차입금) tooltip += `  단기차입금: ${fmt(단기차입금)}\n`;
                        if (유동성장기차입금) tooltip += `  유동성장기차입금: ${fmt(유동성장기차입금)}\n`;
                        if (유동성사채) tooltip += `  유동성사채: ${fmt(유동성사채)}\n`;
                        if (사채) tooltip += `  사채: ${fmt(사채)}\n`;
                        if (장기차입금) tooltip += `  장기차입금: ${fmt(장기차입금)}\n`;
                        tooltip += `= ${fmt(총차입금)}\n\n- 현금성자산:\n`;
                        if (현금) tooltip += `  현금: ${fmt(현금)}\n`;
                        if (단기금융) tooltip += `  단기금융: ${fmt(단기금융)}\n`;
                        tooltip += `= ${fmt(총현금성자산)}\n\nNet Debt: ${fmt(netDebt)}`;
                    }
                } else {
                    // VCM 데이터 없으면 직접 계산
                    const 단기차입금 = findValue(bsData, ['단기차입금'], y) || 0;
                    const 유동성장기차입금 = findValueWithCategory(bsData, ['유동성장기차입금', '유동성장기부채'], y, '유동부채') || 0;
                    const 유동성사채 = findValueWithCategory(bsData, ['유동성사채', '1년내상환사채'], y, '유동부채') || 0;
                    const 사채 = findValueWithCategory(bsData, ['사채'], y, '비유동부채', ['유동성', '차입금']) || 0;
                    const 장기차입금 = findValueWithCategory(bsData, ['장기차입금'], y, '비유동부채', ['유동성', '사채']) || 0;
                    const 총차입금 = 단기차입금 + 유동성장기차입금 + 유동성사채 + 사채 + 장기차입금;
                    const 현금 = findValue(bsData, ['현금및현금성자산'], y) || 0;
                    const 단기금융 = findValue(bsData, ['단기금융상품', '단기금융자산'], y) || 0;
                    const 총현금성자산 = 현금 + 단기금융;
                    netDebt = 총차입금 - 총현금성자산;

                    tooltip = `[${y} 계산식]\n총차입금:\n`;
                    if (단기차입금) tooltip += `  단기차입금: ${fmt(단기차입금)}\n`;
                    if (유동성장기차입금) tooltip += `  유동성장기차입금: ${fmt(유동성장기차입금)}\n`;
                    if (유동성사채) tooltip += `  유동성사채: ${fmt(유동성사채)}\n`;
                    if (사채) tooltip += `  사채: ${fmt(사채)}\n`;
                    if (장기차입금) tooltip += `  장기차입금: ${fmt(장기차입금)}\n`;
                    tooltip += `= ${fmt(총차입금)}\n\n- 현금성자산:\n`;
                    if (현금) tooltip += `  현금: ${fmt(현금)}\n`;
                    if (단기금융) tooltip += `  단기금융: ${fmt(단기금융)}\n`;
                    tooltip += `= ${fmt(총현금성자산)}\n\nNet Debt: ${fmt(netDebt)}`;
                }

                bsTableHtml += `<td class="calc-cell" title="${tooltip}">${fmt(netDebt)}</td>`;
            });
            bsTableHtml += '</tr>';
            bsTableHtml += '</tbody></table>';
            
            // 손익계산서 합산 항목의 상세 breakdown 반환 (툴팁용)
            function getIsBreakdown(calcType, year, vcmData) {
                // VCM 데이터에서 세부항목 찾기 시도
                if (vcmData && Array.isArray(vcmData)) {
                    let parentItem = null;
                    switch(calcType) {
                        case 'otherIncome': parentItem = '영업외수익'; break;
                        case 'otherExpense': parentItem = '영업외비용'; break;
                        case 'ebitda': parentItem = 'EBITDA'; break;
                    }
                    if (parentItem) {
                        const vcmBreakdown = getVcmBreakdown(parentItem, year, vcmData);
                        if (vcmBreakdown.length > 0) return vcmBreakdown;
                    }
                }

                const breakdown = [];

                // 동적 SGA 항목 처리
                if (calcType.startsWith('dynamic_sga_')) {
                    const itemName = calcType.replace('dynamic_sga_', '');
                    const itemConfig = sgaCandidates[itemName];
                    if (itemConfig && itemConfig.isSum) {
                        // 복수 키워드 합산인 경우 세부 내역 표시
                        for (let i = 0; i < itemConfig.keywords.length; i++) {
                            const val = findValueIS(isData, itemConfig.keywords[i], year, itemConfig.excludes[i]) || 0;
                            if (val > 0) {
                                breakdown.push({ name: itemConfig.keywords[i].join('/'), value: val });
                            }
                        }
                    }
                    return breakdown;
                }

                switch(calcType) {
                    case 'revenue':
                        const 상품매출 = findValueIS(isData, ['상품매출액', '상품매출'], year, ['원가']) || 0;
                        const 제품매출 = findValueIS(isData, ['제품매출액', '제품매출'], year, ['원가']) || 0;
                        const 기타매출 = findValueIS(isData, ['기타매출액', '기타매출'], year, ['원가']) || 0;
                        const 영업수익 = findValueIS(isData, ['영업수익'], year, ['원가']) || 0;
                        if (영업수익) breakdown.push({ name: '영업수익', value: 영업수익 });
                        if (상품매출) breakdown.push({ name: '상품매출', value: 상품매출 });
                        if (제품매출) breakdown.push({ name: '제품매출', value: 제품매출 });
                        if (기타매출) breakdown.push({ name: '기타매출', value: 기타매출 });
                        break;
                    case 'cogs':
                        const 상품원가 = findValueIS(isData, ['상품매출원가'], year) || 0;
                        const 제품원가 = findValueIS(isData, ['제품매출원가'], year) || 0;
                        if (상품원가) breakdown.push({ name: '상품매출원가', value: 상품원가 });
                        if (제품원가) breakdown.push({ name: '제품매출원가', value: 제품원가 });
                        break;
                    case 'sga':
                        // XBRL 통합 값이 있으면 breakdown 없음
                        const 판관비직접 = findValueIS(isData, ['판매비와관리비'], year) || 0;
                        if (!판관비직접) {
                            // 계산으로 구한 경우: 동적 선택된 상위 8개 항목 + 기타판관비
                            const yearIdx = years.indexOf(year);
                            for (const itemName of topSgaItems) {
                                const val = sgaItemValues[itemName][yearIdx];
                                if (val > 0) {
                                    breakdown.push({ name: itemName, value: val });
                                }
                            }

                            // 기타판관비 (선택되지 않은 항목들의 합)
                            let otherSgaSum = 0;
                            for (const [itemName, values] of Object.entries(sgaItemValues)) {
                                if (!topSgaItems.includes(itemName)) {
                                    otherSgaSum += values[yearIdx];
                                }
                            }
                            if (otherSgaSum > 0) {
                                breakdown.push({ name: '기타판매비와관리비', value: otherSgaSum });
                            }
                        }
                        break;
                    case 'otherSga':
                        // 기타판관비: 선택되지 않은 항목들만 표시
                        const yearIdx2 = years.indexOf(year);
                        for (const [itemName, values] of Object.entries(sgaItemValues)) {
                            if (!topSgaItems.includes(itemName)) {
                                const val = values[yearIdx2];
                                if (val > 0) {
                                    breakdown.push({ name: itemName, value: val });
                                }
                            }
                        }
                        break;
                    case 'otherIncome':
                        // 영업외수익 = 금융수익 + 기타수익 + 세부항목들
                        const 금융수익통합 = findValueIS(isData, ['금융수익'], year) || 0;
                        const 기타수익 = findValueIS(isData, ['기타수익', '기타이익'], year, ['금융', '영업외']) || 0;

                        if (금융수익통합) {
                            // 통합 계정 있으면 그것만 표시
                            breakdown.push({ name: '금융수익', value: 금융수익통합 });
                        } else {
                            // 통합 계정 없으면 세부 항목들 표시
                            const 이자수익 = findValueIS(isData, ['이자수익'], year) || 0;
                            const 배당금수익 = findValueIS(isData, ['배당금수익'], year) || 0;
                            const 외환차익 = findValueIS(isData, ['외환차익'], year) || 0;
                            const 임대료수익 = findValueIS(isData, ['임대료수익'], year) || 0;
                            const 잡이익 = findValueIS(isData, ['잡이익'], year) || 0;
                            const 유형자산처분이익 = findValueIS(isData, ['유형자산처분이익'], year) || 0;
                            if (이자수익) breakdown.push({ name: '이자수익', value: 이자수익 });
                            if (배당금수익) breakdown.push({ name: '배당금수익', value: 배당금수익 });
                            if (외환차익) breakdown.push({ name: '외환차익', value: 외환차익 });
                            if (임대료수익) breakdown.push({ name: '임대료수익', value: 임대료수익 });
                            if (잡이익) breakdown.push({ name: '잡이익', value: 잡이익 });
                            if (유형자산처분이익) breakdown.push({ name: '유형자산처분이익', value: 유형자산처분이익 });
                        }
                        if (기타수익) breakdown.push({ name: '기타수익', value: 기타수익 });
                        break;
                    case 'otherExpense':
                        // 영업외비용 = 금융비용 + 기타비용 + 세부항목들
                        const 금융비용통합 = findValueIS(isData, ['금융비용'], year) || 0;
                        const 기타비용 = findValueIS(isData, ['기타비용', '기타손실'], year, ['금융', '영업외']) || 0;

                        if (금융비용통합) {
                            // 통합 계정 있으면 그것만 표시
                            breakdown.push({ name: '금융비용', value: 금융비용통합 });
                        } else {
                            // 통합 계정 없으면 세부 항목들 표시
                            const 이자비용 = findValueIS(isData, ['이자비용'], year) || 0;
                            const 외환차손 = findValueIS(isData, ['외환차손'], year) || 0;
                            const 투자손상 = findValueIS(isData, ['투자자산손상차손', '투자손상차손'], year) || 0;
                            const 잡손실 = findValueIS(isData, ['잡손실'], year) || 0;
                            const 매출채권처분손실 = findValueIS(isData, ['매출채권처분손실'], year) || 0;
                            const 투자자산처분손실 = findValueIS(isData, ['투자자산처분손실'], year) || 0;
                            if (이자비용) breakdown.push({ name: '이자비용', value: 이자비용 });
                            if (외환차손) breakdown.push({ name: '외환차손', value: 외환차손 });
                            if (투자손상) breakdown.push({ name: '투자자산손상차손', value: 투자손상 });
                            if (잡손실) breakdown.push({ name: '잡손실', value: 잡손실 });
                            if (매출채권처분손실) breakdown.push({ name: '매출채권처분손실', value: 매출채권처분손실 });
                            if (투자자산처분손실) breakdown.push({ name: '투자자산처분손실', value: 투자자산처분손실 });
                        }
                        if (기타비용) breakdown.push({ name: '기타비용', value: 기타비용 });
                        break;
                }
                return breakdown;
            }

            // 손익계산서 계산 함수 (합계 항목용)
            // XBRL 통합 계정명 우선, 없으면 세부 항목 합산
            // 자동 단위 감지 (원/천원 혼재 대응)
            function calcValue(calcType, year) {
                // 동적 SGA 항목 처리
                if (calcType.startsWith('dynamic_sga_')) {
                    const itemName = calcType.replace('dynamic_sga_', '');
                    const yearIdx = years.indexOf(year);
                    if (yearIdx >= 0 && sgaItemValues[itemName]) {
                        return sgaItemValues[itemName][yearIdx];
                    }
                    return null;
                }

                // XBRL 통합 계정명으로 직접 검색 (대기업용) - 자동 단위 감지 적용
                const 매출액직접 = findValueIS(isData, ['매출액', '수익(매출액)', '영업수익', '수익'], year, ['원가', '총이익', '채권', '기타']);
                const 매출원가직접 = findValueIS(isData, ['매출원가', '영업비용', '매출비용'], year, ['판매비', '관리비', '총이익']);
                const 매출총이익직접 = findValueIS(isData, ['매출총이익', '매출총손익'], year);
                const 판관비직접 = findValueIS(isData, ['판매비와관리비', '판매비와관리비용', '판매비및관리비'], year);
                const 영업이익직접 = findValueIS(isData, ['영업이익', '영업손익', '영업이익(손실)'], year);
                const 기타수익직접 = findValueIS(isData, ['기타수익', '기타이익'], year, ['금융', '영업외']) || 0;
                const 기타비용직접 = findValueIS(isData, ['기타비용', '기타손실'], year, ['금융', '영업외']) || 0;
                const 금융수익직접 = findValueIS(isData, ['금융수익', '금융이익', '이자수익'], year) || 0;
                const 금융비용직접 = findValueIS(isData, ['금융비용', '금융원가', '이자비용'], year) || 0;
                const 법인세차감전직접 = findValueIS(isData, ['법인세비용차감전순이익', '법인세비용차감전이익', '법인세차감전순이익', '법인세비용차감전손익'], year);
                const 법인세직접 = findValueIS(isData, ['법인세비용', '법인세비용(수익)', '법인세등'], year, ['차감전']);
                const 당기순이익직접 = findValueIS(isData, ['당기순이익', '당기순손익', '분기순이익', '반기순이익'], year, ['지배', '비지배']);

                // 세부 항목 (중소기업/감사보고서용)
                const 상품매출 = findValueIS(isData, ['상품매출액', '상품매출'], year, ['원가']) || 0;
                const 제품매출 = findValueIS(isData, ['제품매출액', '제품매출'], year, ['원가']) || 0;
                const 기타매출 = findValueIS(isData, ['기타매출액', '기타매출', '기타수익'], year, ['원가']) || 0;
                const 상품원가 = findValueIS(isData, ['상품매출원가'], year) || 0;
                const 제품원가 = findValueIS(isData, ['제품매출원가'], year) || 0;

                // 동적 판관비 계산: 상위 8개 항목의 합 + 기타판관비
                const yearIdx = years.indexOf(year);
                let 선택된판관비합 = 0;
                let 기타판관비 = 0;

                // 모든 판관비 항목 값 계산
                for (const [itemName, itemConfig] of Object.entries(sgaCandidates)) {
                    let itemValue = 0;

                    if (itemConfig.isSum) {
                        // 복수 키워드 합산
                        for (let i = 0; i < itemConfig.keywords.length; i++) {
                            const val = findValueIS(isData, itemConfig.keywords[i], year, itemConfig.excludes[i]) || 0;
                            itemValue += val;
                        }
                    } else {
                        // 단일 키워드
                        itemValue = findValueIS(isData, itemConfig.keywords[0], year, itemConfig.excludes[0]) || 0;
                    }

                    // 상위 8개에 포함되면 선택된판관비합에, 아니면 기타판관비에 추가
                    if (topSgaItems.includes(itemName)) {
                        선택된판관비합 += itemValue;
                    } else {
                        기타판관비 += itemValue;
                    }
                }

                // 영업외 수익/비용 (자동 단위 감지)
                const 이자수익 = findValueIS(isData, ['이자수익'], year) || 0;
                const 배당금수익 = findValueIS(isData, ['배당금수익'], year) || 0;
                const 외환차익 = findValueIS(isData, ['외환차익'], year) || 0;
                const 임대료수익 = findValueIS(isData, ['임대료수익'], year) || 0;
                const 잡이익 = findValueIS(isData, ['잡이익'], year) || 0;
                const 유형자산처분이익 = findValueIS(isData, ['유형자산처분이익'], year) || 0;
                const 이자비용 = findValueIS(isData, ['이자비용'], year) || 0;
                const 외환차손 = findValueIS(isData, ['외환차손'], year) || 0;
                const 투자손상 = findValueIS(isData, ['투자자산손상차손'], year) || 0;
                const 잡손실 = findValueIS(isData, ['잡손실'], year) || 0;
                const 매출채권처분손실 = findValueIS(isData, ['매출채권처분손실'], year) || 0;
                const 투자자산처분손실 = findValueIS(isData, ['투자자산처분손실'], year) || 0;

                // 법인세 (여러 키워드로 검색)
                const 법인세 = findValueIS(isData, ['법인세비용', '법인세등'], year, ['차감전']) || 0;

                // 계산된 값 (세부 항목 합산 - 감사보고서용)
                const revenue계산 = 상품매출 + 제품매출 + 기타매출;
                const cogs계산 = 상품원가 + 제품원가;
                const sga계산 = 선택된판관비합 + 기타판관비;
                const 영업외수익계산 = 이자수익 + 배당금수익 + 외환차익 + 임대료수익 + 잡이익 + 유형자산처분이익;
                const 영업외비용계산 = 이자비용 + 외환차손 + 투자손상 + 잡손실 + 매출채권처분손실 + 투자자산처분손실;
                
                // XBRL 직접값 우선, 없으면 계산값 사용
                const revenue = 매출액직접 !== null ? 매출액직접 : revenue계산;
                const cogs = 매출원가직접 !== null ? 매출원가직접 : cogs계산;
                const grossProfit = 매출총이익직접 !== null ? 매출총이익직접 : (revenue - cogs);
                const sga = 판관비직접 !== null ? 판관비직접 : sga계산;
                const operatingIncome = 영업이익직접 !== null ? 영업이익직접 : (grossProfit - sga);
                
                // 영업외수익/비용: XBRL(기타수익+금융수익) 우선, 없으면 계산값
                const 영업외수익합 = (기타수익직접 + 금융수익직접) > 0 ? (기타수익직접 + 금융수익직접) : 영업외수익계산;
                const 영업외비용합 = (기타비용직접 + 금융비용직접) > 0 ? (기타비용직접 + 금융비용직접) : 영업외비용계산;
                
                // 법인세: XBRL 직접값 우선
                const 법인세최종 = 법인세직접 !== null ? 법인세직접 : 법인세;
                
                const ebt = 법인세차감전직접 !== null ? 법인세차감전직접 : (operatingIncome + 영업외수익합 - 영업외비용합);
                const netIncome = 당기순이익직접 !== null ? 당기순이익직접 : (ebt - 법인세최종);
                
                switch(calcType) {
                    case 'revenue': return revenue;
                    case 'cogs': return cogs;
                    case 'grossProfit': return grossProfit;
                    case 'sga': return sga;
                    case 'otherSga': return 기타판관비;
                    case 'operatingIncome': return operatingIncome;
                    case 'otherIncome': return 영업외수익합;
                    case 'otherExpense': return 영업외비용합;
                    case 'ebt': return ebt;
                    case 'tax': return 법인세최종;
                    case 'netIncome': return netIncome;
                    case 'financeIncome': return 금융수익직접;
                    case 'financeCost': return 금융비용직접;
                    default: return null;
                }
            }
            
            // VCM 항목 매칭 헬퍼 함수 (상품매출 vs 상품매출액 등 유연하게 매칭)
            function findVcmRow(vcmData, itemName) {
                return vcmData.find(row => {
                    const rowItem = (row['항목'] || '').trim();
                    const searchName = itemName.trim();
                    // 정확한 매칭
                    if (rowItem === searchName) return true;
                    // '액' 접미사 변형 매칭 (상품매출 ↔ 상품매출액)
                    if (rowItem === searchName + '액') return true;
                    if (rowItem + '액' === searchName) return true;
                    return false;
                });
            }

            // 손익계산서 테이블 생성
            let isTableHtml = '<table class="vcm-table"><thead>' + headerHtml + '</thead><tbody>';
            isItems.forEach(item => {
                // 빈 행 필터링: 모든 연도에 값이 없으면 건너뜀
                const vcmData = previewData?.vcm || [];
                const vcmRow = findVcmRow(vcmData, item.name);
                const hasAnyValue = years.some(y => {
                    if (vcmRow && vcmRow[y] !== null && vcmRow[y] !== undefined && vcmRow[y] !== 0) return true;
                    if (item.calc) {
                        const calcVal = calcValue(item.calc, y);
                        if (calcVal !== null && calcVal !== undefined && calcVal !== 0) return true;
                    }
                    // keywords 기반 항목도 체크 (상품매출, 제품매출 등)
                    if (item.keywords) {
                        const keyVal = findValue(isData, item.keywords, y, item.excludes || []);
                        if (keyVal !== null && keyVal !== undefined && keyVal !== 0) return true;
                    }
                    return false;
                });

                // 카테고리 행(매출, 매출원가 등 대분류)은 항상 표시, 나머지는 값이 있을 때만 표시
                if (!item.isCategory && !item.isTotal && !hasAnyValue) {
                    return; // 빈 행 건너뜀
                }

                let rowClass = item.isCategory ? 'category-row' : (item.isTotal ? 'total-row' : '');
                if (item.isHighlight) rowClass += ' highlight-row';
                let tdClass = item.isSubItem ? 'sub-item' : '';

                isTableHtml += `<tr class="${rowClass}"><td class="${tdClass}">${item.name}</td>`;
                years.forEach(y => {
                    let val;
                    let tooltip = '';
                    let isMultipleItems = false;

                    // VCM 데이터에서 먼저 찾기 시도
                    const vcmData = previewData?.vcm || [];
                    const vcmRow = findVcmRow(vcmData, item.name);

                    if (vcmRow && vcmRow[y] !== null && vcmRow[y] !== undefined) {
                        // VCM 데이터 사용 (단위 변환)
                        val = parseValue(vcmRow[y]);

                        // 합산 항목인 경우 툴팁 생성
                        if (item.calc) {
                            const breakdown = getIsBreakdown(item.calc, y, vcmData);
                            if (!item.isCategory && breakdown.length >= 1) {
                                isMultipleItems = true;
                                tooltip = breakdown.map(b => `${b.name}: ${fmt(b.value)}`).join('\n');
                                tooltip = `[${y} 합산 내역]\n${tooltip}`;
                            }
                        }
                    } else {
                        // VCM에 없으면 기존 로직 사용
                        if (item.calc) {
                            val = calcValue(item.calc, y);
                            // 각 연도별 툴팁 생성 (카테고리 행은 제외 - 이미 회색으로 합계임을 표시)
                            const breakdown = getIsBreakdown(item.calc, y, vcmData);
                            if (!item.isCategory && breakdown.length >= 1) {  // 1개 이상이면 합산 내역 표시
                                isMultipleItems = true;
                                tooltip = breakdown.map(b => `${b.name}: ${fmt(b.value)}`).join('\n');
                                tooltip = `[${y} 합산 내역]\n${tooltip}`;
                            }
                        } else {
                            val = findValue(isData, item.keywords, y, item.excludes || []);
                        }
                    }
                    // 값 표시 (빈칸 유지)
                    isTableHtml += `<td class="${isMultipleItems ? 'calc-cell' : ''}" title="${tooltip}">${fmt(val)}</td>`;
                });
                isTableHtml += '</tr>';
                
                // 매출총이익, 영업이익, 당기순이익 다음에 % of Sales 추가
                if (item.name === '매출총이익' || item.name === '영업이익' || item.name === '당기순이익') {
                    isTableHtml += '<tr class="percent-row"><td class="sub-item">% of Sales</td>';
                    years.forEach(y => {
                        const 매출 = calcValue('revenue', y) || 0;
                        let val;
                        if (item.calc) {
                            val = calcValue(item.calc, y);
                        } else {
                            val = findValue(isData, item.keywords, y, item.excludes || []);
                        }
                        isTableHtml += `<td>${pct(val, 매출)}</td>`;
                    });
                    isTableHtml += '</tr>';
                }
            });
            
            // EBITDA 추가 (VCM 데이터에서 읽기 또는 계산)
            isTableHtml += '<tr class="total-row highlight-row"><td>EBITDA</td>';
            const ebitdaValues = {};  // % of Sales 계산을 위해 저장
            years.forEach(y => {
                let ebitda, tooltip;

                // VCM 데이터에서 읽기 시도
                const vcmData = previewData?.vcm || [];
                const ebitdaRow = vcmData.find(row => row['항목'] === 'EBITDA');

                if (ebitdaRow && ebitdaRow[y] !== null && ebitdaRow[y] !== undefined) {
                    // 백엔드 VCM 값 사용 (단위 변환)
                    ebitda = parseValue(ebitdaRow[y]);

                    // 툴팁용 세부 데이터 - VCM [EBITDA] 항목 먼저 확인
                    const ebitda영업이익Row = vcmData.find(r => r['항목'] && r['항목'].includes('[EBITDA]영업이익'));
                    const ebitda감가상각비Row = vcmData.find(r => r['항목'] && r['항목'].includes('[EBITDA]감가상각비'));
                    const ebitda무형자산상각비Row = vcmData.find(r => r['항목'] && r['항목'].includes('[EBITDA]무형자산상각비'));

                    const 영업이익 = ebitda영업이익Row ? parseValue(ebitda영업이익Row[y]) : (calcValue('operatingIncome', y) || 0);
                    const 감가상각비 = ebitda감가상각비Row ? parseValue(ebitda감가상각비Row[y]) : (findValue(isData, ['감가상각비'], y, ['무형']) || 0);
                    const 무형자산상각비 = ebitda무형자산상각비Row ? parseValue(ebitda무형자산상각비Row[y]) : (findValue(isData, ['무형자산상각비'], y) || 0);

                    tooltip = `[${y} 계산식]\n영업이익: ${fmt(영업이익)}\n`;
                    if (감가상각비) tooltip += `+ 감가상각비: ${fmt(감가상각비)}\n`;
                    if (무형자산상각비) tooltip += `+ 무형자산상각비: ${fmt(무형자산상각비)}\n`;
                    tooltip += `= EBITDA: ${fmt(ebitda)}`;
                } else {
                    // VCM 데이터 없으면 직접 계산
                    const 영업이익 = calcValue('operatingIncome', y) || 0;
                    const 감가상각비 = findValue(isData, ['감가상각비'], y, ['무형']) || 0;
                    const 무형자산상각비 = findValue(isData, ['무형자산상각비'], y) || 0;
                    ebitda = 영업이익 + 감가상각비 + 무형자산상각비;

                    tooltip = `[${y} 계산식]\n영업이익: ${fmt(영업이익)}\n`;
                    if (감가상각비) tooltip += `+ 감가상각비: ${fmt(감가상각비)}\n`;
                    if (무형자산상각비) tooltip += `+ 무형자산상각비: ${fmt(무형자산상각비)}\n`;
                    tooltip += `= EBITDA: ${fmt(ebitda)}`;
                }

                ebitdaValues[y] = ebitda;
                isTableHtml += `<td class="calc-cell" title="${tooltip}">${fmt(ebitda)}</td>`;
            });
            isTableHtml += '</tr>';
            isTableHtml += '<tr class="percent-row"><td class="sub-item">% of Sales</td>';
            years.forEach(y => {
                const 매출 = calcValue('revenue', y) || 0;
                const ebitda = ebitdaValues[y];
                isTableHtml += `<td>${pct(ebitda, 매출)}</td>`;
            });
            isTableHtml += '</tr>';
            isTableHtml += '</tbody></table>';
            
            // 최종 HTML (가로 배치, 각각 별개 컨테이너)
            // 재무분석 AI 결과가 있으면 3번째 박스로 추가
            const analysisResultEl = document.getElementById('analysisResult');
            const hasAnalysisResult = analysisResultEl && analysisResultEl.innerHTML.trim() !== '' && analysisResultEl.style.display !== 'none';
            console.log('[VCM-fallback] hasAnalysisResult:', hasAnalysisResult,
                'el존재:', !!analysisResultEl,
                'innerHTML길이:', analysisResultEl?.innerHTML?.trim()?.length || 0,
                'display:', analysisResultEl?.style?.display);

            let analysisBoxHtml = '';
            if (hasAnalysisResult) {
                analysisBoxHtml = `
                    <div class="vcm-box vcm-box-analysis">
                        <div class="vcm-title">재무분석 AI</div>
                        <div class="vcm-analysis-content">
                            ${analysisResultEl.innerHTML}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="vcm-wrapper">
                    <div class="vcm-box">
                        <div class="vcm-title">재무상태표</div>
                        ${bsTableHtml}
                    </div>
                    <div class="vcm-box">
                        <div class="vcm-title">손익계산서</div>
                        ${isTableHtml}
                    </div>
                    ${analysisBoxHtml}
                </div>
                <p class="preview-info" style="text-align: center; margin-top: 16px;">* 상세 재무정보는 엑셀 파일을 다운로드하여 확인하세요.</p>
            `;
        }

        // ============================================================
        // 재무분석 AI 분석
        // ============================================================
        let analysisCheckInterval = null;
        let isAnalysisStarting = false;  // 중복 분석 시작 방지 플래그

        async function startAnalysis() {
            if (!currentTaskId) return;

            // 중복 호출 방지
            if (isAnalysisStarting) {
                console.log('[Analysis] 이미 분석 시작 중 - 중복 호출 무시');
                return;
            }
            isAnalysisStarting = true;

            // 시작 버튼 숨기고 진행 표시
            document.getElementById('analysisStartContainer').style.display = 'none';
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('analysisResult').style.display = 'none';

            // 버튼 텍스트 원복 (재시도 시)
            document.getElementById('analyzeBtn').textContent = '재무분석 AI 분석 시작';

            // VCM 서브탭 버튼 분석 중 표시
            const vcmAiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
            if (vcmAiBtn) {
                vcmAiBtn.textContent = '재무분석중...(0%)';
                vcmAiBtn.classList.add('analyzing');
            }

            // VCM 서브탭 AI 버튼 툴팁 초기화
            const vcmAiTooltip = document.getElementById('vcmAiTooltip');
            if (vcmAiTooltip) {
                vcmAiTooltip.textContent = '분석 준비 중';
                vcmAiTooltip.classList.remove('hidden');
            }

            // 복사 버튼 숨김
            document.getElementById('analysisCopyBtn').style.display = 'none';

            // 진행바 초기화
            const progressBar = document.getElementById('analysisProgressBar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';

            // 메시지에 로딩 애니메이션 추가
            const messageEl = document.getElementById('analysisMessage');
            messageEl.textContent = '분석 준비 중';
            messageEl.classList.add('loading');

            const statusEl = document.getElementById('analysisStatus');
            statusEl.textContent = '진행 중';
            statusEl.style.display = '';
            statusEl.className = 'analysis-status running';

            // 상단 분석 진행 상태 메시지 표시
            const analysisStatusMessage = document.getElementById('analysisStatusMessage');
            const analysisStatusText = document.getElementById('analysisStatusText');
            if (analysisStatusMessage && analysisStatusText) {
                analysisStatusMessage.style.display = 'flex';
                analysisStatusMessage.classList.remove('completed');
                analysisStatusText.textContent = '재무분석 AI는 평균 2~3분 이내, 기업 리서치는 최대 10분 내외 소요될 수 있습니다.';
                analysisStatusMessage.querySelector('.status-icon').textContent = '⏳';
            }

            try {
                const response = await fetch(`/api/analyze/${currentTaskId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('분석 시작 실패');
                }

                // 상태 체크 시작
                startAnalysisStatusCheck();

            } catch (error) {
                console.error('분석 시작 실패:', error);
                statusEl.textContent = '실패';
                statusEl.className = 'analysis-status failed';
                const messageEl = document.getElementById('analysisMessage');
                messageEl.textContent = error.message;
                messageEl.classList.remove('loading');
                // 실패 시 다시 시작 버튼 표시
                document.getElementById('analysisStartContainer').style.display = 'block';
                document.getElementById('analysisProgress').style.display = 'none';
            }
        }

        let analysisStatusErrorCount = 0;  // 연속 에러 횟수
        const ANALYSIS_MAX_ERRORS = 10;  // 최대 연속 에러 허용 횟수

        function startAnalysisStatusCheck() {
            if (analysisCheckInterval) {
                clearInterval(analysisCheckInterval);
            }
            analysisStatusErrorCount = 0;

            analysisCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/analyze-status/${currentTaskId}`);

                    // 404 에러 처리 (작업을 찾을 수 없음 — 서버 재시작 등)
                    if (response.status === 404) {
                        stopAnalysisStatusCheck();
                        showAnalysisError('작업을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
                        return;
                    }

                    // 502/503 등 서버 에러
                    if (!response.ok) {
                        analysisStatusErrorCount++;
                        console.warn(`[Analysis] 서버 에러 (${response.status}), 연속 ${analysisStatusErrorCount}/${ANALYSIS_MAX_ERRORS}`);
                        if (analysisStatusErrorCount >= ANALYSIS_MAX_ERRORS) {
                            stopAnalysisStatusCheck();
                            showAnalysisError('서버 연결이 불안정합니다. 페이지를 새로고침해주세요.');
                        }
                        return;
                    }

                    // 성공 시 에러 카운터 리셋
                    analysisStatusErrorCount = 0;

                    const data = await response.json();

                    // 진행률 업데이트
                    const progressBar = document.getElementById('analysisProgressBar');
                    progressBar.style.width = `${data.progress}%`;
                    progressBar.textContent = `${data.progress}%`;

                    // VCM 서브탭 버튼에 진행률 표시
                    const vcmAiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
                    if (vcmAiBtn && vcmAiBtn.classList.contains('analyzing')) {
                        vcmAiBtn.textContent = `재무분석중...(${data.progress}%)`;
                    }

                    const messageEl = document.getElementById('analysisMessage');
                    messageEl.textContent = data.message || '분석 중';
                    messageEl.classList.add('loading');

                    // VCM 서브탭 AI 버튼 툴팁에도 상태 메시지 동기화
                    const vcmAiTooltip = document.getElementById('vcmAiTooltip');
                    if (vcmAiTooltip && vcmAiBtn && vcmAiBtn.classList.contains('analyzing')) {
                        vcmAiTooltip.textContent = data.message || '분석 중';
                        vcmAiTooltip.classList.remove('hidden');
                    }

                    if (data.status === 'completed') {
                        stopAnalysisStatusCheck();
                        // 파일명 업데이트 (AI 분석 완료 후 엑셀 파일 생성됨)
                        if (data.filename) {
                            currentFilename = data.filename;
                        }
                        showAnalysisResult(data.result);
                        updateChatbotContext();  // 챗봇 컨텍스트 업데이트
                    } else if (data.status === 'failed') {
                        stopAnalysisStatusCheck();
                        showAnalysisError(data.message);
                    }

                } catch (error) {
                    analysisStatusErrorCount++;
                    console.error(`[Analysis] 상태 확인 실패 (${analysisStatusErrorCount}/${ANALYSIS_MAX_ERRORS}):`, error);
                    if (analysisStatusErrorCount >= ANALYSIS_MAX_ERRORS) {
                        stopAnalysisStatusCheck();
                        showAnalysisError('서버 연결이 불안정합니다. 페이지를 새로고침해주세요.');
                    }
                }
            }, 2000);  // 2초마다 체크
        }

        function stopAnalysisStatusCheck() {
            if (analysisCheckInterval) {
                clearInterval(analysisCheckInterval);
                analysisCheckInterval = null;
            }
        }

        let analysisReportText = '';           // 현재 표시 중인 보고서 텍스트 (복사용)
        let analysisOriginalReportText = '';   // 원본 보고서 텍스트
        let analysisSummaryReportText = '';    // 요약본 보고서 텍스트
        let isShowingOriginal = false;         // 현재 원본 표시 중 여부

        function showAnalysisResult(result) {
            // 중복 방지 플래그 리셋
            isAnalysisStarting = false;

            // 분석 실패 또는 이상 패턴 없음 체크
            if (!result || !result.report || result.no_anomalies || result.success === false) {
                const errorMsg = result?.error || '이상 패턴을 감지하지 못했습니다. 다시 시도해주세요.';
                showAnalysisError(errorMsg);
                return;
            }

            const statusEl = document.getElementById('analysisStatus');
            statusEl.style.display = 'none';  // 상태 텍스트 숨김

            // 복사 버튼 표시
            const copyBtn = document.getElementById('analysisCopyBtn');
            copyBtn.style.display = 'inline-block';

            // 원본보기 버튼 표시 (요약본이 있을 때만)
            const originalBtn = document.getElementById('analysisOriginalBtn');
            if (result.summary_report) {
                originalBtn.style.display = 'inline-block';
            }

            // 로딩 애니메이션 제거
            document.getElementById('analysisMessage').classList.remove('loading');
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('analysisStartContainer').style.display = 'none';

            const resultEl = document.getElementById('analysisResult');
            resultEl.style.display = 'block';

            // 원본/요약 텍스트 저장
            analysisOriginalReportText = result.report;
            analysisSummaryReportText = result.summary_report || result.report;
            isShowingOriginal = false;

            // 기본: 요약본 표시
            analysisReportText = analysisSummaryReportText;
            resultEl.innerHTML = markdownToHtml(analysisSummaryReportText);

            // 엑셀에 재무분석 AI 탭 추가 (원본 + 요약 모두)
            addInsightToExcel(result.report, result.summary_report);

            isAnalysisCompleted = true;

            // 상단 분석 진행 상태 메시지 업데이트 (재무분석 AI 완료)
            const analysisStatusMessage = document.getElementById('analysisStatusMessage');
            const analysisStatusText = document.getElementById('analysisStatusText');
            if (analysisStatusMessage && analysisStatusText) {
                // 기업 리서치가 아직 안 끝났으면 메시지 업데이트
                if (!isSuperResearchCompleted) {
                    analysisStatusText.textContent = '재무분석 AI 분석이 완료되었습니다. 기업 리서치를 진행중입니다.';
                    analysisStatusMessage.querySelector('.status-icon').textContent = '✔';
                } else {
                    // 기업 리서치도 이미 완료된 경우
                    analysisStatusMessage.classList.add('completed');
                    analysisStatusText.textContent = '기업 리서치가 완료되었습니다.';
                    analysisStatusMessage.querySelector('.status-icon').textContent = '✔';
                }
            }

            // 결과 컨테이너 확장 (재무분석 완료 시)
            document.getElementById('resultContainer').classList.add('expanded');

            // 다운로드 버튼 활성화 및 툴팁 숨김
            enableDownloadButton();

            // VCM 서브탭 버튼 완료 표시 + 활성화
            const vcmAiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
            if (vcmAiBtn) {
                vcmAiBtn.textContent = '재무분석 AI';
                vcmAiBtn.classList.remove('analyzing');
                vcmAiBtn.classList.add('active');  // 분석 완료 시 활성화
            }

            // 재무분석 AI vcm-box도 표시
            const vcmBoxes = document.querySelectorAll('.vcm-box');
            if (vcmBoxes[2]) {
                vcmBoxes[2].classList.remove('hidden');
            }

            // 재무분석 AI 박스 높이 조정 (다른 테이블에 맞춤)
            updateAiBoxHeight();

            // VCM 서브탭 AI 버튼 툴팁 숨김
            const vcmAiTooltip = document.getElementById('vcmAiTooltip');
            if (vcmAiTooltip) {
                vcmAiTooltip.classList.add('hidden');
            }

            // 최신 대표자/주소 정보가 있으면 기업개황정보 업데이트
            if (result.current_ceo || result.current_address) {
                updateCompanyInfoFromAnalysis(result.current_ceo, result.current_address);
                console.log('기업개황정보 업데이트 완료:', { ceo: result.current_ceo, address: result.current_address });
            }

            // Financials 탭에 재무분석 AI 결과 반영 (항상 갱신)
            renderFinancialsVCM();

            // Financials 탭으로 전환하여 결과 표시
            showMainTab('financials');

            // PE 챗봇 초기화 (재무분석 완료 후 활성화 — API 충돌 방지)
            setTimeout(() => { initChatbot(); }, 1000);
        }

        // ============================================================
        // 기업 리서치 관련 함수
        // ============================================================

        // 기업 리서치 시작
        async function startSuperResearch() {
            if (!currentTaskId) {
                console.error('[SuperResearch] task_id가 없습니다.');
                return;
            }

            console.log('[SuperResearch] 기업 리서치 시작:', currentTaskId);

            // 기업 리서치 탭 표시
            const superResearchWrapper = document.querySelector('.super-research-tab-wrapper');
            if (superResearchWrapper) {
                superResearchWrapper.style.display = 'inline-block';
            }

            // 탭 버튼 분석 중 표시
            const superResearchTabBtn = document.getElementById('superResearchTabBtn');
            superResearchTabBtn.textContent = '리서치중...(0%)';
            superResearchTabBtn.classList.add('analyzing');
            superResearchTabBtn.classList.remove('completed');

            // 진행 상태 표시 (헤더, 결과는 숨김)
            document.getElementById('superResearchHeader').style.display = 'none';
            document.getElementById('superResearchProgress').style.display = 'block';
            document.getElementById('superResearchResult').style.display = 'none';
            document.getElementById('superResearchProgressBar').style.width = '0%';
            document.getElementById('superResearchProgressBar').textContent = '0%';
            document.getElementById('superResearchMessage').textContent = '기업 리서치 시작 중...';

            isSuperResearchCompleted = false;
            superResearchData = null;

            try {
                // 기업 리서치 API 호출
                const response = await fetch(`/api/super-research/${currentTaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('기업 리서치 시작 실패');
                }

                const data = await response.json();
                console.log('[SuperResearch] 시작 응답:', data);

                // 상태 확인 시작
                startSuperResearchStatusCheck();

            } catch (error) {
                console.error('[SuperResearch] 시작 오류:', error);
                document.getElementById('superResearchMessage').textContent = '기업 리서치 시작 실패: ' + error.message;
                superResearchTabBtn.textContent = '기업 리서치';
                superResearchTabBtn.classList.remove('analyzing');
            }
        }

        // 기업 리서치 상태 확인 시작
        let superResearchErrorCount = 0;
        const SUPER_RESEARCH_MAX_ERRORS = 10;

        function startSuperResearchStatusCheck() {
            if (superResearchCheckInterval) {
                clearInterval(superResearchCheckInterval);
            }
            superResearchErrorCount = 0;

            superResearchCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/super-research-status/${currentTaskId}`);

                    // 404 에러 처리 (작업을 찾을 수 없음 — 서버 재시작 등)
                    if (response.status === 404) {
                        console.warn('[SuperResearch] 작업을 찾을 수 없음 (404) — 폴링 중지');
                        clearInterval(superResearchCheckInterval);
                        superResearchCheckInterval = null;
                        const superResearchTabBtn = document.getElementById('superResearchTabBtn');
                        superResearchTabBtn.textContent = '기업 리서치';
                        superResearchTabBtn.classList.remove('analyzing');
                        document.getElementById('superResearchMessage').textContent = '작업이 만료되었습니다. 새로 검색해주세요.';
                        return;
                    }

                    // 502/503 등 서버 에러
                    if (!response.ok) {
                        superResearchErrorCount++;
                        console.warn(`[SuperResearch] 서버 에러 (${response.status}), 연속 ${superResearchErrorCount}/${SUPER_RESEARCH_MAX_ERRORS}`);
                        if (superResearchErrorCount >= SUPER_RESEARCH_MAX_ERRORS) {
                            clearInterval(superResearchCheckInterval);
                            superResearchCheckInterval = null;
                            const superResearchTabBtn = document.getElementById('superResearchTabBtn');
                            superResearchTabBtn.textContent = '기업 리서치';
                            superResearchTabBtn.classList.remove('analyzing');
                            document.getElementById('superResearchMessage').textContent = '서버 연결이 불안정합니다. 페이지를 새로고침해주세요.';
                        }
                        return;
                    }

                    // 성공 시 에러 카운터 리셋
                    superResearchErrorCount = 0;

                    const data = await response.json();
                    console.log('[SuperResearch] 상태:', data.status, 'progress:', data.progress);

                    // 진행률 업데이트
                    const superResearchTabBtn = document.getElementById('superResearchTabBtn');
                    if (data.status === 'running') {
                        superResearchTabBtn.textContent = `리서치중...(${data.progress}%)`;
                        superResearchTabBtn.classList.add('analyzing');
                        document.getElementById('superResearchProgressBar').style.width = `${data.progress}%`;
                        document.getElementById('superResearchProgressBar').textContent = `${data.progress}%`;
                        document.getElementById('superResearchMessage').textContent = data.message || '리서치 진행 중...';
                    } else if (data.status === 'completed') {
                        console.log('[SuperResearch] 완료! 결과:', data.result);
                        clearInterval(superResearchCheckInterval);
                        superResearchCheckInterval = null;
                        displaySuperResearchResult(data.result);
                    } else if (data.status === 'error') {
                        console.error('[SuperResearch] 에러:', data.error);
                        clearInterval(superResearchCheckInterval);
                        superResearchCheckInterval = null;
                        document.getElementById('superResearchMessage').textContent = '리서치 실패: ' + (data.error || '알 수 없는 오류');
                        superResearchTabBtn.textContent = '기업 리서치';
                        superResearchTabBtn.classList.remove('analyzing');
                    }
                } catch (error) {
                    superResearchErrorCount++;
                    console.error(`[SuperResearch] 상태 확인 오류 (${superResearchErrorCount}/${SUPER_RESEARCH_MAX_ERRORS}):`, error);
                    if (superResearchErrorCount >= SUPER_RESEARCH_MAX_ERRORS) {
                        clearInterval(superResearchCheckInterval);
                        superResearchCheckInterval = null;
                        const superResearchTabBtn = document.getElementById('superResearchTabBtn');
                        superResearchTabBtn.textContent = '기업 리서치';
                        superResearchTabBtn.classList.remove('analyzing');
                        document.getElementById('superResearchMessage').textContent = '서버 연결이 불안정합니다. 페이지를 새로고침해주세요.';
                    }
                }
            }, 3000);  // 3초마다 확인
        }

        // 기업 리서치 결과 표시
        function displaySuperResearchResult(result) {
            console.log('[SuperResearch] 결과 수신:', result);

            isSuperResearchCompleted = true;
            superResearchData = result;

            // 상단 분석 진행 상태 메시지 업데이트 (기업 리서치 완료)
            const analysisStatusMessage = document.getElementById('analysisStatusMessage');
            const analysisStatusText = document.getElementById('analysisStatusText');
            if (analysisStatusMessage && analysisStatusText) {
                analysisStatusMessage.classList.add('completed');
                analysisStatusText.textContent = '기업 리서치가 완료되었습니다.';
                analysisStatusMessage.querySelector('.status-icon').textContent = '✔';
            }

            // 진행 상태 숨기고 결과 및 헤더 표시
            document.getElementById('superResearchProgress').style.display = 'none';
            document.getElementById('superResearchHeader').style.display = 'flex';
            document.getElementById('superResearchResult').style.display = 'block';

            // 챗봇 컨텍스트 업데이트
            updateChatbotContext();

            // 결과 렌더링 (JSON → HTML)
            const resultContainer = document.getElementById('superResearchResult');
            if (result && result.report) {
                // report가 JSON 객체인지 문자열인지 확인
                if (typeof result.report === 'object') {
                    resultContainer.innerHTML = renderResearchReport(result.report);
                } else if (typeof result.report === 'string') {
                    // 문자열인 경우 JSON 파싱 시도
                    try {
                        const jsonData = JSON.parse(result.report);
                        resultContainer.innerHTML = renderResearchReport(jsonData);
                    } catch (e) {
                        // 파싱 실패 시 기존 마크다운 렌더링 (fallback)
                        console.log('[SuperResearch] JSON 파싱 실패, 마크다운 fallback 사용');
                        resultContainer.innerHTML = markdownToHtml(result.report);
                    }
                }
            } else {
                resultContainer.innerHTML = '<p>리서치 결과가 없습니다.</p>';
            }

            // 탭 버튼 완료 표시
            const superResearchTabBtn = document.getElementById('superResearchTabBtn');
            superResearchTabBtn.textContent = '기업 리서치';
            superResearchTabBtn.classList.remove('analyzing');
            superResearchTabBtn.classList.add('completed');

            // 복사 버튼 표시
            document.getElementById('superResearchCopyBtn').style.display = 'inline-block';
        }

        // 기업 리서치 결과 복사
        function copySuperResearchResult() {
            // 렌더링된 텍스트를 복사 (HTML 태그 제거)
            const resultContainer = document.getElementById('superResearchResult');
            if (!resultContainer || !resultContainer.innerText.trim()) {
                alert('복사할 내용이 없습니다.');
                return;
            }

            navigator.clipboard.writeText(resultContainer.innerText).then(() => {
                const copyBtn = document.getElementById('superResearchCopyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '복사됨!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('복사 실패:', err);
                alert('복사에 실패했습니다.');
            });
        }

        // ============================================================
        // 전체 목업 테스트 함수 (콘솔에서 loadMockData() 호출)
        // ============================================================
        function loadMockData() {
            console.log('[MOCK] 전체 목업 데이터 로딩 시작...');

            // 1. 기업개황정보 목업
            const mockCompanyInfo = {
                corp_name: '조일물류(주)',
                corp_name_eng: 'JOIL LOGISTICS CO., LTD.',
                ceo_nm: '홍길동',
                adres: '경기도 안양시 동안구 엘에스로 92',
                hm_url: 'http://www.joil.co.kr',
                phn_no: '031-123-4567',
                induty_code: '49',
                induty_name: '운수업',
                est_dt_formatted: '1990-01-15',
                acc_mt_formatted: '12월',
                bizr_no: '123-45-67890',
                jurir_no: '110111-0123456',
                market_name: '비상장'
            };
            companyInfoData = mockCompanyInfo;

            // 기업개황정보 표시
            document.getElementById('companyInfoWrapper').style.display = 'block';
            const infoTable = document.getElementById('companyInfoTable');
            infoTable.innerHTML = `
                <tr><th>회사명</th><td>${mockCompanyInfo.corp_name}</td><th>영문명</th><td>${mockCompanyInfo.corp_name_eng || '-'}</td></tr>
                <tr><th>대표자</th><td>${mockCompanyInfo.ceo_nm}</td><th>업종</th><td>${mockCompanyInfo.induty_name || mockCompanyInfo.induty_code || '-'}</td></tr>
                <tr><th>주소</th><td colspan="3">${mockCompanyInfo.adres}</td></tr>
                <tr><th>전화번호</th><td>${mockCompanyInfo.phn_no || '-'}</td><th>홈페이지</th><td>${mockCompanyInfo.hm_url ? '<a href="' + mockCompanyInfo.hm_url + '" target="_blank">' + mockCompanyInfo.hm_url + '</a>' : '-'}</td></tr>
                <tr><th>설립일</th><td>${mockCompanyInfo.est_dt_formatted || '-'}</td><th>결산월</th><td>${mockCompanyInfo.acc_mt_formatted || '-'}</td></tr>
                <tr><th>사업자번호</th><td>${mockCompanyInfo.bizr_no || '-'}</td><th>법인번호</th><td>${mockCompanyInfo.jurir_no || '-'}</td></tr>
                <tr><th>시장구분</th><td colspan="3">${mockCompanyInfo.market_name || '-'}</td></tr>
            `;

            // 2. 재무분석 AI 결과 목업
            const mockAnalysisHtml = `<h1>조일물류(주) 재무 분석 보고서</h1>
<h2>요약</h2>
<p>2023년 매출총이익률은 5년 연속 하락세(2020년 6.8% → 2024년 4.2%)를 이어갔으며, 대규모 자산 매각 이후 발생한 지급임차료 부담으로 영업이익은 2.5억원 적자로 전환되었습니다.</p>
<h2>주요 발견사항</h2>
<h3>1. [2023년] 당기순이익</h3>
<ul>
<li><strong>현상</strong>: 100.6억원으로 비정상적 급증 (전년 0.8억원)</li>
<li><strong>원인 분석</strong>: 영업이익은 2.5억원 적자였으나, 영업외수익인 유형자산처분이익 133.7억원이 발생하여 당기순이익이 급증했습니다.</li>
</ul>
<h3>2. [2023~2024년] 영업활동현금흐름</h3>
<ul>
<li><strong>현상</strong>: 2년 연속 대규모 순유출 기록</li>
<li><strong>원인 분석</strong>: 비현금성 유형자산처분이익 차감 조정 및 법인세 납부 영향</li>
</ul>`;

            // analysisResult 요소에 직접 HTML 삽입
            const analysisResultEl = document.getElementById('analysisResult');
            analysisResultEl.innerHTML = mockAnalysisHtml;
            analysisResultEl.style.display = 'block';
            isAnalysisCompleted = true;

            // 분석 섹션 UI 업데이트
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('analysisStartContainer').style.display = 'none';
            document.getElementById('analysisCopyBtn').style.display = 'inline-block';
            document.getElementById('analysisOriginalBtn').style.display = 'inline-block';

            // 3. 메인 컨테이너 표시
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('resultContainer').classList.add('show');
            document.getElementById('resultContainer').classList.add('expanded');
            document.getElementById('completeSection').classList.add('show');

            // 4. VCM 데이터 직접 렌더링 (재무상태표 + 손익계산서 + 재무분석 AI)
            const financialsContent = document.getElementById('financialsContent');
            financialsContent.innerHTML = getMockVCMHtml();

            // 5. 탭 활성화
            showMainTab('financials');

            // 6. VCM 서브탭 표시 및 AI 박스 높이 조정
            const vcmSubTabs = document.getElementById('vcmSubTabs');
            if (vcmSubTabs) {
                vcmSubTabs.classList.add('show');
                // AI 버튼 활성화
                const aiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
                if (aiBtn) {
                    aiBtn.textContent = '재무분석 AI';
                    aiBtn.classList.remove('analyzing');
                    aiBtn.classList.add('active');
                }
            }

            // 7. AI 박스 높이 조정 (다른 테이블에 맞춤)
            setTimeout(() => {
                updateAiBoxHeight();
            }, 100);

            console.log('[MOCK] 전체 목업 데이터 로딩 완료!');
            console.log('[MOCK] 콘솔에서 loadMockData() 호출하여 테스트하세요.');
        }

        // VCM 목업 HTML 반환 (AI 분석 포함)
        function getMockVCMHtml() {
            return `
                <div class="vcm-wrapper">
                    <div class="vcm-box">
                        <div class="vcm-title">재무상태표</div>
                        <table class="vcm-table"><thead><tr><th>(단위: 백만원)</th><th>FY2020</th><th>FY2021</th><th>FY2022</th><th>FY2023</th><th>FY2024</th></tr></thead><tbody><tr class="category-row"><td class="">유동자산</td><td class="" title="" style="">8,897</td><td class="" title="" style="">9,845</td><td class="" title="" style="">10,005</td><td class="" title="" style="">19,421</td><td class="" title="" style="">17,373</td></tr><tr class=""><td class="sub-item">단기투자자산</td><td class="calc-cell" title="[FY2020 세부내역]&#10;단기금융상품: 2,008&#10;─────────&#10;합계: 2,008" style="">2,008</td><td class="calc-cell" title="[FY2021 세부내역]&#10;단기금융상품: 2,320&#10;─────────&#10;합계: 2,320" style="">2,320</td><td class="calc-cell" title="[FY2022 세부내역]&#10;단기금융상품: 2,057&#10;─────────&#10;합계: 2,057" style="">2,057</td><td class="calc-cell" title="[FY2023 세부내역]&#10;단기금융상품: 10,052&#10;─────────&#10;합계: 10,052" style="">10,052</td><td class="calc-cell" title="[FY2024 세부내역]&#10;단기금융상품: 7,193&#10;─────────&#10;합계: 7,193" style="">7,193</td></tr><tr class=""><td class="sub-item">매출채권및기타채권</td><td class="calc-cell" title="[FY2020 세부내역]&#10;매출채권: 4,493&#10;미수금: 344&#10;미수수익: 5&#10;선급금: 12&#10;선급비용: 45&#10;─────────&#10;합계: 4,900" style="">4,900</td><td class="calc-cell" title="[FY2021 세부내역]&#10;매출채권: 4,863&#10;미수금: 43&#10;미수수익: 5&#10;선급금: 50&#10;선급비용: 81&#10;─────────&#10;합계: 5,042" style="">5,042</td><td class="calc-cell" title="[FY2022 세부내역]&#10;매출채권: 4,793&#10;미수금: 44&#10;미수수익: 4&#10;선급금: 145&#10;선급비용: 96&#10;─────────&#10;합계: 5,082" style="">5,082</td><td class="calc-cell" title="[FY2023 세부내역]&#10;매출채권: 5,018&#10;미수금: 107&#10;미수수익: 97&#10;선급금: 186&#10;선급비용: 135&#10;─────────&#10;합계: 5,542" style="">5,542</td><td class="calc-cell" title="[FY2024 세부내역]&#10;매출채권: 5,558&#10;미수금: 4&#10;미수수익: 173&#10;선급금: 19&#10;선급비용: 100&#10;─────────&#10;합계: 5,854" style="">5,854</td></tr><tr class=""><td class="sub-item">현금및현금성자산</td><td class="" title="" style="">2,034</td><td class="" title="" style="">2,531</td><td class="" title="" style="">2,879</td><td class="" title="" style="">3,878</td><td class="" title="" style="">3,829</td></tr><tr class=""><td class="sub-item">기타유동자산</td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="calc-cell" title="[FY2022 세부내역]&#10;선납세금: 35&#10;─────────&#10;합계: 35" style="">35</td><td class="" title="" style=""></td><td class="calc-cell" title="[FY2024 세부내역]&#10;단기대여금: 500&#10;선납세금: 52&#10;─────────&#10;합계: 552" style="">552</td></tr><tr class="category-row"><td class="">비유동자산</td><td class="" title="" style="">22,671</td><td class="" title="" style="">21,536</td><td class="" title="" style="">21,928</td><td class="" title="" style="">11,595</td><td class="" title="" style="">9,393</td></tr><tr class=""><td class="sub-item">기타비유동자산</td><td class="calc-cell" title="[FY2020 세부내역]&#10;차량운반구: 4,694&#10;건물: 9,153&#10;토지: 8,083&#10;비품: 989&#10;시설장치: 896&#10;─────────&#10;합계: 24,725" style="">24,725</td><td class="calc-cell" title="[FY2021 세부내역]&#10;차량운반구: 5,709&#10;건물: 9,153&#10;토지: 8,083&#10;비품: 1,310&#10;기타비유동자산(세부): 967&#10;─────────&#10;합계: 26,232" style="">26,232</td><td class="calc-cell" title="[FY2022 세부내역]&#10;차량운반구: 7,063&#10;건물: 9,153&#10;토지: 8,083&#10;비품: 1,319&#10;기타비유동자산(세부): 1,162&#10;─────────&#10;합계: 27,894" style="">27,894</td><td class="calc-cell" title="[FY2023 세부내역]&#10;차량운반구: 8,485&#10;건물: 2,446&#10;토지: 2,130&#10;비품: 1,097&#10;기타비유동자산(세부): 1,285&#10;─────────&#10;합계: 16,378" style="">16,378</td><td class="calc-cell" title="[FY2024 세부내역]&#10;차량운반구: 8,940&#10;건물: 2,446&#10;토지: 2,130&#10;비품: 1,154&#10;기타비유동자산(세부): 785&#10;─────────&#10;합계: 16,393" style="">16,393</td></tr><tr class=""><td class="sub-item">유형자산</td><td class="" title="" style="">18,921</td><td class="" title="" style="">18,915</td><td class="" title="" style="">18,721</td><td class="" title="" style="">7,644</td><td class="" title="" style="">6,469</td></tr><tr class=""><td class="sub-item">장기투자자산</td><td class="calc-cell" title="[FY2020 세부내역]&#10;장기금융상품: 2,928&#10;─────────&#10;합계: 2,928" style="">2,928</td><td class="calc-cell" title="[FY2021 세부내역]&#10;장기금융상품: 1,549&#10;─────────&#10;합계: 1,549" style="">1,549</td><td class="calc-cell" title="[FY2022 세부내역]&#10;장기금융상품: 1,901&#10;─────────&#10;합계: 1,901" style="">1,901</td><td class="calc-cell" title="[FY2023 세부내역]&#10;장기금융상품: 1,999&#10;─────────&#10;합계: 1,999" style="">1,999</td><td class="calc-cell" title="[FY2024 세부내역]&#10;장기금융상품: 1,470&#10;─────────&#10;합계: 1,470" style="">1,470</td></tr><tr class=""><td class="sub-item">매출채권및기타채권[비유동]</td><td class="calc-cell" title="[FY2020 세부내역]&#10;임차보증금: 615&#10;기타보증금: 102&#10;─────────&#10;합계: 717" style="">717</td><td class="calc-cell" title="[FY2021 세부내역]&#10;임차보증금: 865&#10;기타보증금: 102&#10;─────────&#10;합계: 967" style="">967</td><td class="calc-cell" title="[FY2022 세부내역]&#10;임차보증금: 1,070&#10;기타보증금: 92&#10;─────────&#10;합계: 1,162" style="">1,162</td><td class="calc-cell" title="[FY2023 세부내역]&#10;임차보증금: 1,116&#10;기타보증금: 169&#10;─────────&#10;합계: 1,285" style="">1,285</td><td class="calc-cell" title="[FY2024 세부내역]&#10;임차보증금: 616&#10;기타보증금: 169&#10;─────────&#10;합계: 785" style="">785</td></tr><tr class="total-row"><td class="">자산총계</td><td class="" title="" style="">31,568</td><td class="" title="" style="">31,381</td><td class="" title="" style="">31,933</td><td class="" title="" style="">31,016</td><td class="" title="" style="">26,766</td></tr><tr class="category-row"><td class="">유동부채</td><td class="" title="" style="">16,931</td><td class="" title="" style="">24,466</td><td class="" title="" style="">23,101</td><td class="" title="" style="">12,148</td><td class="" title="" style="">9,602</td></tr><tr class=""><td class="sub-item">매입채무및기타채무</td><td class="calc-cell" title="[FY2020 세부내역]&#10;미지급금: 2,572&#10;미지급비용: 17&#10;예수금: 29&#10;선수수익: 71&#10;퇴직연금미지급금: 60&#10;─────────&#10;합계: 6,519" style="">6,519</td><td class="calc-cell" title="[FY2021 세부내역]&#10;미지급금: 2,875&#10;부가세예수금: 79&#10;미지급비용: 27&#10;예수금: 39&#10;선수수익: 52&#10;─────────&#10;합계: 6,931" style="">6,931</td><td class="calc-cell" title="[FY2022 세부내역]&#10;미지급금: 3,033&#10;부가세예수금: 108&#10;미지급비용: 94&#10;예수금: 58&#10;선수수익: 34&#10;─────────&#10;합계: 6,998" style="">6,998</td><td class="calc-cell" title="[FY2023 세부내역]&#10;미지급금: 1,201&#10;미지급비용: 82&#10;선수금: 1&#10;예수금: 92&#10;─────────&#10;합계: 5,371" style="">5,371</td><td class="calc-cell" title="[FY2024 세부내역]&#10;미지급금: 769&#10;미지급비용: 79&#10;예수금: 64&#10;─────────&#10;합계: 5,029" style="">5,029</td></tr><tr class=""><td class="sub-item">유동차입부채</td><td class="calc-cell" title="[FY2020 세부내역]&#10;단기차입금: 6,508&#10;유동성장기부채: 3,800&#10;─────────&#10;합계: 10,308" style="">10,308</td><td class="calc-cell" title="[FY2021 세부내역]&#10;단기차입금: 9,503&#10;유동성장기부채: 7,972&#10;─────────&#10;합계: 17,475" style="">17,475</td><td class="calc-cell" title="[FY2022 세부내역]&#10;단기차입금: 16,103&#10;─────────&#10;합계: 16,103" style="">16,103</td><td class="calc-cell" title="[FY2023 세부내역]&#10;단기차입금: 4,502&#10;─────────&#10;합계: 4,502" style="">4,502</td><td class="calc-cell" title="[FY2024 세부내역]&#10;단기차입금: 4,502&#10;─────────&#10;합계: 4,502" style="">4,502</td></tr><tr class=""><td class="sub-item">기타비금융부채</td><td class="calc-cell" title="[FY2020 세부내역]&#10;미지급세금: 103&#10;─────────&#10;합계: 103" style="">103</td><td class="calc-cell" title="[FY2021 세부내역]&#10;미지급세금: 60&#10;─────────&#10;합계: 60" style="">60</td><td class="" title="" style=""></td><td class="calc-cell" title="[FY2023 세부내역]&#10;미지급세금: 2,275&#10;─────────&#10;합계: 2,275" style="">2,275</td><td class="calc-cell" title="[FY2024 세부내역]&#10;미지급세금: 71&#10;─────────&#10;합계: 71" style="">71</td></tr><tr class="category-row"><td class="">비유동부채</td><td class="" title="" style="">8,968</td><td class="" title="" style="">589</td><td class="" title="" style="">3,033</td><td class="" title="" style="">3,341</td><td class="" title="" style="">1,469</td></tr><tr class=""><td class="sub-item">비유동차입부채</td><td class="calc-cell" title="[FY2020 세부내역]&#10;사채상환할증금: 96&#10;장기차입금: 7,272&#10;전환사채: 1,000&#10;─────────&#10;합계: 8,369" style="">8,369</td><td class="calc-cell" title="[FY2021 세부내역]&#10;사채상환할증금: 96&#10;─────────&#10;합계: 96" style="">96</td><td class="calc-cell" title="[FY2022 세부내역]&#10;장기차입금: 1,948&#10;─────────&#10;합계: 1,948" style="">1,948</td><td class="" title="" style=""></td><td class="" title="" style=""></td></tr><tr class=""><td class="sub-item">매입채무및기타채무[비유동]</td><td class="calc-cell" title="[FY2020 세부내역]&#10;임대보증금: 599&#10;─────────&#10;합계: 599" style="">599</td><td class="calc-cell" title="[FY2021 세부내역]&#10;임대보증금: 493&#10;─────────&#10;합계: 493" style="">493</td><td class="calc-cell" title="[FY2022 세부내역]&#10;임대보증금: 1,086&#10;─────────&#10;합계: 1,086" style="">1,086</td><td class="calc-cell" title="[FY2023 세부내역]&#10;장기미지급금: 2,626&#10;임대보증금: 715&#10;─────────&#10;합계: 3,341" style="">3,341</td><td class="calc-cell" title="[FY2024 세부내역]&#10;장기미지급금: 845&#10;임대보증금: 623&#10;─────────&#10;합계: 1,469" style="">1,469</td></tr><tr class="total-row"><td class="">부채총계</td><td class="" title="" style="">25,778</td><td class="" title="" style="">26,014</td><td class="" title="" style="">26,482</td><td class="" title="" style="">15,505</td><td class="" title="" style="">11,071</td></tr><tr class=""><td class="sub-item">자본금</td><td class="" title="" style="">200</td><td class="" title="" style="">200</td><td class="" title="" style="">200</td><td class="" title="" style="">200</td><td class="" title="" style="">200</td></tr><tr class=""><td class="sub-item">이익잉여금</td><td class="" title="" style="">5,457</td><td class="" title="" style="">6,309</td><td class="" title="" style="">6,381</td><td class="" title="" style="">16,441</td><td class="" title="" style="">16,625</td></tr><tr class=""><td class="sub-item">기타자본구성요소</td><td class="calc-cell" title="[FY2020 세부내역]&#10;자본잉여금: 132&#10;─────────&#10;합계: 132" style="">132</td><td class="calc-cell" title="[FY2021 세부내역]&#10;자본잉여금: 132&#10;자본조정: -1,274&#10;─────────&#10;합계: -1,142" style="color: #dc2626;">-1,142</td><td class="calc-cell" title="[FY2022 세부내역]&#10;자본잉여금: 132&#10;자본조정: -1,274&#10;기타자본항목: 132&#10;─────────&#10;합계: -1,010" style="color: #dc2626;">-1,010</td><td class="calc-cell" title="[FY2023 세부내역]&#10;자본잉여금: 132&#10;자본조정: -1,274&#10;기타자본항목: 132&#10;─────────&#10;합계: -1,010" style="color: #dc2626;">-1,010</td><td class="calc-cell" title="[FY2024 세부내역]&#10;자본잉여금: 132&#10;자본조정: -1,274&#10;기타자본항목: 132&#10;─────────&#10;합계: -1,010" style="color: #dc2626;">-1,010</td></tr><tr class="total-row"><td class="">자본총계</td><td class="" title="" style="">5,789</td><td class="" title="" style="">5,367</td><td class="" title="" style="">5,451</td><td class="" title="" style="">15,511</td><td class="" title="" style="">15,695</td></tr><tr class="total-row"><td class="">부채와자본총계</td><td class="" title="" style="">31,568</td><td class="" title="" style="">31,381</td><td class="" title="" style="">31,933</td><td class="" title="" style="">31,016</td><td class="" title="" style="">26,766</td></tr><tr class="total-row"><td class="">NWC</td><td class="calc-cell" title="[FY2020 세부내역]&#10;유동자산: 8,897&#10;유동부채: 16,931&#10;─────────&#10;합계: -8,034" style="color: #dc2626;">-8,034</td><td class="calc-cell" title="[FY2021 세부내역]&#10;유동자산: 9,845&#10;유동부채: 24,466&#10;─────────&#10;합계: -14,621" style="color: #dc2626;">-14,621</td><td class="calc-cell" title="[FY2022 세부내역]&#10;유동자산: 10,005&#10;유동부채: 23,101&#10;─────────&#10;합계: -13,097" style="color: #dc2626;">-13,097</td><td class="calc-cell" title="[FY2023 세부내역]&#10;유동자산: 19,421&#10;유동부채: 12,148&#10;─────────&#10;합계: 7,274" style="">7,274</td><td class="calc-cell" title="[FY2024 세부내역]&#10;유동자산: 17,373&#10;유동부채: 9,602&#10;─────────&#10;합계: 7,771" style="">7,771</td></tr><tr class="total-row"><td class="">Net Debt</td><td class="calc-cell" title="[FY2020 세부내역]&#10;유동차입부채: 10,308&#10;비유동차입부채: 8,369&#10;현금및현금성자산: -2,034&#10;단기투자자산: -2,008&#10;─────────&#10;합계: 14,635" style="">14,635</td><td class="calc-cell" title="[FY2021 세부내역]&#10;유동차입부채: 17,475&#10;비유동차입부채: 96&#10;현금및현금성자산: -2,531&#10;단기투자자산: -2,320&#10;─────────&#10;합계: 12,720" style="">12,720</td><td class="calc-cell" title="[FY2022 세부내역]&#10;유동차입부채: 16,103&#10;비유동차입부채: 1,948&#10;현금및현금성자산: -2,879&#10;단기투자자산: -2,057&#10;─────────&#10;합계: 13,115" style="">13,115</td><td class="calc-cell" title="[FY2023 세부내역]&#10;유동차입부채: 4,502&#10;현금및현금성자산: -3,878&#10;단기투자자산: -10,052&#10;─────────&#10;합계: -9,427" style="color: #dc2626;">-9,427</td><td class="calc-cell" title="[FY2024 세부내역]&#10;유동차입부채: 4,502&#10;현금및현금성자산: -3,829&#10;단기투자자산: -7,193&#10;─────────&#10;합계: -6,521" style="color: #dc2626;">-6,521</td></tr></tbody></table>
                    </div>
                    <div class="vcm-box">
                        <div class="vcm-title">손익계산서</div>
                        <table class="vcm-table"><thead><tr><th>(단위: 백만원)</th><th>FY2020</th><th>FY2021</th><th>FY2022</th><th>FY2023</th><th>FY2024</th></tr></thead><tbody><tr class="category-row"><td class="">매출</td><td class="" title="" style="">39,196</td><td class="" title="" style="">46,431</td><td class="" title="" style="">44,869</td><td class="" title="" style="">48,026</td><td class="" title="" style="">54,590</td></tr><tr class=""><td class="sub-item">  운송수입</td><td class="" title="" style="">38,266</td><td class="" title="" style="">45,052</td><td class="" title="" style="">43,473</td><td class="" title="" style="">46,300</td><td class="" title="" style="">53,713</td></tr><tr class=""><td class="sub-item">  임대료수입</td><td class="" title="" style="">930</td><td class="" title="" style="">1,379</td><td class="" title="" style="">1,396</td><td class="" title="" style="">1,726</td><td class="" title="" style="">877</td></tr><tr class="category-row"><td class="">매출원가</td><td class="" title="" style="">36,538</td><td class="" title="" style="">43,385</td><td class="" title="" style="">42,241</td><td class="" title="" style="">45,605</td><td class="" title="" style="">52,315</td></tr><tr class=""><td class="sub-item">  운송매출원가</td><td class="" title="" style="">36,538</td><td class="" title="" style="">43,385</td><td class="" title="" style="">42,241</td><td class="" title="" style="">45,605</td><td class="" title="" style="">52,315</td></tr><tr class="total-row"><td class="">매출총이익</td><td class="" title="" style="">2,658</td><td class="" title="" style="">3,046</td><td class="" title="" style="">2,628</td><td class="" title="" style="">2,420</td><td class="" title="" style="">2,275</td></tr><tr class="percent-row"><td class="sub-item">% of Sales</td><td class="" title="" style="">6.8%</td><td class="" title="" style="">6.6%</td><td class="" title="" style="">5.9%</td><td class="" title="" style="">5.0%</td><td class="" title="" style="">4.2%</td></tr><tr class="category-row"><td class="">판매비와관리비</td><td class="" title="" style="">1,608</td><td class="" title="" style="">1,524</td><td class="" title="" style="">1,793</td><td class="" title="" style="">2,671</td><td class="" title="" style="">1,989</td></tr><tr class=""><td class="sub-item">  인건비</td><td class="" title="" style="">535</td><td class="" title="" style="">583</td><td class="" title="" style="">794</td><td class="" title="" style="">906</td><td class="" title="" style="">604</td></tr><tr class=""><td class="sub-item">  임차료비용</td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="" title="" style="">815</td><td class="" title="" style="">855</td></tr><tr class=""><td class="sub-item">  수수료비용</td><td class="" title="" style="">97</td><td class="" title="" style="">106</td><td class="" title="" style="">138</td><td class="" title="" style="">157</td><td class="" title="" style="">147</td></tr><tr class=""><td class="sub-item">  세금과공과</td><td class="" title="" style="">126</td><td class="" title="" style="">141</td><td class="" title="" style="">144</td><td class="" title="" style="">131</td><td class="" title="" style="">23</td></tr><tr class=""><td class="sub-item">  접대비</td><td class="" title="" style="">30</td><td class="" title="" style="">22</td><td class="" title="" style="">30</td><td class="" title="" style="">72</td><td class="" title="" style="">36</td></tr><tr class=""><td class="sub-item">  보험료</td><td class="" title="" style="">30</td><td class="" title="" style="">11</td><td class="" title="" style="">18</td><td class="" title="" style="">18</td><td class="" title="" style="">44</td></tr><tr class=""><td class="sub-item">  기타판매비와관리비</td><td class="calc-cell" title="[FY2020 세부내역]&#10;수도광열비: 1&#10;대손상각비: 27&#10;여비교통비: 4&#10;차량유지비: 6&#10;교육훈련비: (98,000원)&#10;통신비: 14&#10;소모품비: 11&#10;건물관리비: (346,260원)&#10;─────────&#10;합계: 64" style="">64</td><td class="calc-cell" title="[FY2021 세부내역]&#10;수도광열비: 2&#10;대손상각비: 4&#10;여비교통비: 4&#10;차량유지비: 3&#10;교육훈련비: (48,000원)&#10;통신비: 18&#10;소모품비: 12&#10;건물관리비: (310,740원)&#10;─────────&#10;합계: 45" style="">45</td><td class="calc-cell" title="[FY2022 세부내역]&#10;수도광열비: (36,285원)&#10;대손상각비: 14&#10;여비교통비: 4&#10;차량유지비: 5&#10;교육훈련비: 2&#10;통신비: 17&#10;소모품비: 6&#10;─────────&#10;합계: 47" style="">47</td><td class="calc-cell" title="[FY2023 세부내역]&#10;수도광열비: (191,295원)&#10;대손상각비: 16&#10;여비교통비: 6&#10;차량유지비: 30&#10;교육훈련비: 2&#10;통신비: 15&#10;소모품비: 12&#10;─────────&#10;합계: 82" style="">82</td><td class="calc-cell" title="[FY2024 세부내역]&#10;대손상각비: 41&#10;여비교통비: 1&#10;차량유지비: 74&#10;통신비: 13&#10;소모품비: 6&#10;─────────&#10;합계: 136" style="">136</td></tr><tr class="total-row highlight-row"><td class="">영업이익</td><td class="" title="" style="">1,050</td><td class="" title="" style="">1,522</td><td class="" title="" style="">834</td><td class="" title="" style="color: #dc2626;">-251</td><td class="" title="" style="">287</td></tr><tr class="percent-row"><td class="sub-item">% of Sales (영업이익)</td><td class="" title="" style="">2.7%</td><td class="" title="" style="">3.3%</td><td class="" title="" style="">1.9%</td><td class="" title="" style="">-0.5%</td><td class="" title="" style="">0.5%</td></tr><tr class="category-row"><td class="">영업외수익</td><td class="" title="" style="">77</td><td class="" title="" style="">60</td><td class="" title="" style="">121</td><td class="" title="" style="">13,585</td><td class="" title="" style="">348</td></tr><tr class=""><td class="sub-item">  유형자산처분이익</td><td class="" title="" style="">1</td><td class="" title="" style="">9</td><td class="" title="" style="">11</td><td class="" title="" style="">13,372</td><td class="" title="" style=""></td></tr><tr class=""><td class="sub-item">  이자수익</td><td class="" title="" style="">33</td><td class="" title="" style="">23</td><td class="" title="" style="">61</td><td class="" title="" style="">153</td><td class="" title="" style="">307</td></tr><tr class=""><td class="sub-item">  자산평가이익</td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="" title="" style="">31</td><td class="" title="" style="">38</td><td class="" title="" style="">18</td></tr><tr class=""><td class="sub-item">  기타영업외수익</td><td class="" title="" style="">43</td><td class="" title="" style="">28</td><td class="" title="" style="">18</td><td class="" title="" style="">21</td><td class="" title="" style="">23</td></tr><tr class="category-row"><td class="">영업외비용</td><td class="" title="" style="">531</td><td class="" title="" style="">613</td><td class="" title="" style="">866</td><td class="" title="" style="">992</td><td class="" title="" style="">381</td></tr><tr class=""><td class="sub-item">  이자비용</td><td class="" title="" style="">521</td><td class="" title="" style="">611</td><td class="" title="" style="">812</td><td class="" title="" style="">851</td><td class="" title="" style="">350</td></tr><tr class=""><td class="sub-item">  유형자산처분손실</td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="" title="" style=""></td><td class="" title="" style="">114</td><td class="" title="" style=""></td></tr><tr class=""><td class="sub-item">  기타영업외비용</td><td class="" title="" style="">6</td><td class="calc-cell" title="[FY2021 세부내역]&#10;광고선전비: 3&#10;─────────&#10;합계: 3" style="">3</td><td class="" title="" style="">50</td><td class="" title="" style="">18</td><td class="" title="" style="">28</td></tr><tr class="total-row"><td class="">법인세비용차감전이익</td><td class="" title="" style="">596</td><td class="" title="" style="">968</td><td class="" title="" style="">90</td><td class="" title="" style="">12,342</td><td class="" title="" style="">253</td></tr><tr class=""><td class="sub-item">법인세비용</td><td class="" title="" style="">105</td><td class="" title="" style="">116</td><td class="" title="" style="">6</td><td class="" title="" style="">2,281</td><td class="" title="" style="">69</td></tr><tr class="total-row highlight-row"><td class="">당기순이익</td><td class="" title="" style="">492</td><td class="" title="" style="">852</td><td class="" title="" style="">83</td><td class="" title="" style="">10,061</td><td class="" title="" style="">184</td></tr><tr class="percent-row"><td class="sub-item">% of Sales (순이익)</td><td class="" title="" style="">1.3%</td><td class="" title="" style="">1.8%</td><td class="" title="" style="">0.2%</td><td class="" title="" style="">20.9%</td><td class="" title="" style="">0.3%</td></tr><tr class="total-row highlight-row"><td class="">EBITDA</td><td class="calc-cell" title="[FY2020 계산식]&#10;영업이익: 1,050&#10;+ 감가상각비: 706&#10;+ 무형자산상각비: 0&#10;─────────&#10;= EBITDA: 1,756" style="">1,756</td><td class="calc-cell" title="[FY2021 계산식]&#10;영업이익: 1,522&#10;+ 감가상각비: 598&#10;+ 무형자산상각비: 0&#10;─────────&#10;= EBITDA: 2,119" style="">2,119</td><td class="calc-cell" title="[FY2022 계산식]&#10;영업이익: 834&#10;+ 감가상각비: 611&#10;+ 무형자산상각비: 0&#10;─────────&#10;= EBITDA: 1,445" style="">1,445</td><td class="calc-cell" title="[FY2023 계산식]&#10;영업이익: -251&#10;+ 감가상각비: 469&#10;+ 무형자산상각비: 0&#10;─────────&#10;= EBITDA: 218" style="">218</td><td class="calc-cell" title="[FY2024 계산식]&#10;영업이익: 287&#10;+ 감가상각비: 113&#10;+ 무형자산상각비: 0&#10;─────────&#10;= EBITDA: 399" style="">399</td></tr><tr class="percent-row"><td class="sub-item">% of Sales (EBITDA)</td><td class="" title="" style="">4.5%</td><td class="" title="" style="">4.6%</td><td class="" title="" style="">3.2%</td><td class="" title="" style="">0.5%</td><td class="" title="" style="">0.7%</td></tr></tbody></table>
                    </div>
                    <div class="vcm-box vcm-box-analysis">
                        <div class="vcm-title">재무분석 AI</div>
                        <div class="vcm-analysis-content">
                            <h1>조일물류(주) 재무 분석 보고서</h1>
                            <h2>요약</h2>
                            <p>5년간 매출액은 391.9억원에서 545.9억원으로 39% 성장했으나, 매출원가율 상승과 판관비 증가로 같은 기간 영업이익은 10.5억원에서 2.8억원으로 73% 감소했습니다. 2023년 당기순이익은 100.6억원을 기록하며 전년 대비 폭증했으나, 이는 영업활동과 무관한 133.7억원의 유형자산처분이익에 따른 일회성 효과입니다.</p>
                            <h2>주요 발견사항</h2>
                            <h3>1. [2023년] 당기순이익</h3>
                            <ul>
                                <li><strong>현상</strong>: 100.6억원 기록, 전년(0.8억원) 대비 11,960% 폭증. 일회성 이익으로 인한 착시 현상.</li>
                                <li><strong>원인 분석</strong>: 영업손실 2.5억원에도 불구하고, 영업외수익 항목의 유형자산처분이익 133.7억원이 발생하여 당기순이익이 급증했습니다.</li>
                            </ul>
                            <h3>2. [2023~2024년] 영업활동으로인한현금흐름</h3>
                            <ul>
                                <li><strong>현상</strong>: 2년 연속 대규모 순유출 기록 (FY23: -13.3억원, FY24: -16.1억원)</li>
                                <li><strong>원인 분석</strong>: FY23 순유출은 비현금성 이익인 유형자산처분이익(133.7억원)을 당기순이익에서 차감 조정했기 때문입니다.</li>
                            </ul>
                            <h3>3. [2023년] 이익과 현금흐름의 괴리</h3>
                            <ul>
                                <li><strong>현상</strong>: 당기순이익은 100.6억원 흑자였으나, 영업활동현금흐름은 13.3억원 적자를 기록하여 113.9억원의 심각한 괴리 발생.</li>
                                <li><strong>원인 분석</strong>: 당기순이익에 반영된 133.7억원의 유형자산처분이익은 비현금성 수익으로, 영업활동현금흐름 계산 시 차감 조정되었기 때문입니다.</li>
                            </ul>
                            <h3>4. [2023년] 유형자산</h3>
                            <ul>
                                <li><strong>현상</strong>: 토지 및 건물을 대량 매각하여 비유동자산이 219.2억원에서 115.9억원으로 47% 급감.</li>
                                <li><strong>원인 분석</strong>: 손익계산서상 유형자산처분이익 133.7억원 발생과 함께, 재무상태표상 토지(장부가 60.7억원) 및 건물(장부가 49.5억원)을 매각했습니다.</li>
                            </ul>
                            <h3>5. [2020~2024년] 매출총이익률</h3>
                            <ul>
                                <li><strong>현상</strong>: 5년간 지속적으로 하락 (FY20: 6.8% → FY22: 5.9% → FY24: 4.2%)</li>
                                <li><strong>원인 분석</strong>: 매출액 증가율(FY24 13.7%)보다 매출원가 상승률(FY24 14.7%)이 더 높았기 때문입니다.</li>
                            </ul>
                            <h3>6. [2023년] 영업이익</h3>
                            <ul>
                                <li><strong>현상</strong>: 영업손실 2.5억원 기록, 전년(영업이익 8.3억원) 대비 적자 전환.</li>
                                <li><strong>원인 분석</strong>: 판매비와관리비가 17.9억원에서 26.7억원으로 급증한 것이 주된 원인입니다. 이는 유형자산 처분 후 임차 방식으로 전환하며 신규 발생한 지급임차료 8.2억원 때문입니다.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // 전역에서 접근 가능하도록 window에 등록
        window.loadMockData = loadMockData;

        function stripMarkdown(text) {
            return text
                // 헤더 제거: # ## ### 등
                .replace(/^#{1,6}\s+/gm, '')
                // 굵은 글씨 **text** → text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                // 기울임 *text* → text
                .replace(/\*(.*?)\*/g, '$1')
                // 리스트 기호 제거: - item → item
                .replace(/^[-*]\s+/gm, '')
                // 번호 리스트: 1. item → item (번호 유지)
                .replace(/^(\d+)\.\s+/gm, '$1. ')
                // 수평선 제거
                .replace(/^---+$/gm, '')
                // 연속 빈 줄 정리
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        async function copyAnalysisResult() {
            if (!analysisReportText) {
                alert('복사할 내용이 없습니다.');
                return;
            }

            try {
                const plainText = stripMarkdown(analysisReportText);
                await navigator.clipboard.writeText(plainText);
                const copyBtn = document.getElementById('analysisCopyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '복사됨';
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('복사 실패:', err);
                alert('복사에 실패했습니다.');
            }
        }

        async function addInsightToExcel(report, summaryReport) {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/api/add-insight/${currentTaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ report: report, summary_report: summaryReport || '' })
                });

                if (response.ok) {
                    console.log('재무분석 AI(원본+요약)가 엑셀에 추가되었습니다.');
                }
            } catch (error) {
                console.error('엑셀에 인사이트 추가 실패:', error);
            }
        }

        function toggleOriginalReport() {
            const resultEl = document.getElementById('analysisResult');
            const btn = document.getElementById('analysisOriginalBtn');

            if (isShowingOriginal) {
                // 요약본으로 전환
                resultEl.innerHTML = markdownToHtml(analysisSummaryReportText);
                analysisReportText = analysisSummaryReportText;
                btn.textContent = '원본보기';
                isShowingOriginal = false;
            } else {
                // 원본으로 전환
                resultEl.innerHTML = markdownToHtml(analysisOriginalReportText);
                analysisReportText = analysisOriginalReportText;
                btn.textContent = '요약보기';
                isShowingOriginal = true;
            }
        }

        function showAnalysisError(message) {
            // 중복 방지 플래그 리셋
            isAnalysisStarting = false;

            const statusEl = document.getElementById('analysisStatus');
            statusEl.textContent = '실패';
            statusEl.style.display = '';
            statusEl.className = 'analysis-status failed';

            // VCM 서브탭 버튼 원복 + 활성화 (에러도 보이도록)
            const vcmAiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
            if (vcmAiBtn) {
                vcmAiBtn.textContent = '재무분석 AI';
                vcmAiBtn.classList.remove('analyzing');
                vcmAiBtn.classList.add('active');
            }

            // VCM 서브탭 AI 버튼 툴팁 숨김
            const vcmAiTooltip = document.getElementById('vcmAiTooltip');
            if (vcmAiTooltip) {
                vcmAiTooltip.classList.add('hidden');
            }

            // 복사 버튼 숨김
            document.getElementById('analysisCopyBtn').style.display = 'none';

            // 로딩 애니메이션 제거
            document.getElementById('analysisMessage').classList.remove('loading');
            document.getElementById('analysisProgress').style.display = 'none';

            const resultEl = document.getElementById('analysisResult');
            resultEl.style.display = 'block';
            resultEl.innerHTML = `<p style="color: #dc2626; text-align: center; padding: 20px;">분석 실패: ${message}</p>`;

            // 실패 시 다시 분석하기 버튼 표시
            const startContainer = document.getElementById('analysisStartContainer');
            startContainer.style.display = 'block';
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.textContent = '다시 분석하기';

            // Financials VCM에 AI 박스 렌더링 (에러 내용 포함)
            renderFinancialsVCM();

            // 분석 실패해도 챗봇은 활성화 (재무데이터 기반 질의 가능)
            setTimeout(() => { initChatbot(); }, 1000);
        }

        function markdownToHtml(markdown) {
            // Mermaid 코드 블록 임시 저장
            const mermaidBlocks = [];

            // 1. 정상적인 ```mermaid 블록 처리
            let html = markdown.replace(/```mermaid\n([\s\S]*?)```/g, (match, code) => {
                const index = mermaidBlocks.length;
                mermaidBlocks.push(code.trim());
                return `%%MERMAID_BLOCK_${index}%%`;
            });

            // 2. 코드블록 없이 작성된 Mermaid 자동 감지 (pie, mindmap, timeline, flowchart, graph 등)
            const mermaidKeywords = ['pie', 'mindmap', 'timeline', 'flowchart', 'graph', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'erDiagram', 'gantt'];
            mermaidKeywords.forEach(keyword => {
                // 키워드로 시작하는 블록을 찾아서 Mermaid로 변환
                const regex = new RegExp(`(^|\\n)(${keyword}[^\\n]*\\n(?:[ \\t]+[^\\n]*\\n?)*)`, 'gm');
                html = html.replace(regex, (match, prefix, code) => {
                    const index = mermaidBlocks.length;
                    mermaidBlocks.push(code.trim());
                    return `${prefix}%%MERMAID_BLOCK_${index}%%`;
                });
            });

            // 일반 코드 블록 처리
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

            // 테이블 처리
            html = html.replace(/^\|(.+)\|\s*\n\|[-:\s|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm, (match, header, body) => {
                const headers = header.split('|').map(h => h.trim()).filter(h => h);
                const rows = body.trim().split('\n').map(row =>
                    row.split('|').map(cell => cell.trim()).filter(cell => cell)
                );
                let table = '<table class="md-table"><thead><tr>';
                headers.forEach(h => { table += `<th>${h}</th>`; });
                table += '</tr></thead><tbody>';
                rows.forEach(row => {
                    table += '<tr>';
                    row.forEach(cell => { table += `<td>${cell}</td>`; });
                    table += '</tr>';
                });
                table += '</tbody></table>';
                return table;
            });

            // 불릿 리스트 먼저 처리 (* 와 - 둘 다 지원)
            // * 리스트를 - 리스트로 통일 (굵은글씨/이탤릭 처리 전에)
            html = html.replace(/^\*\s+/gm, '- ');
            // 들여쓰기된 * 리스트도 처리
            html = html.replace(/^(\s+)\*\s+/gm, '$1- ');

            // 수평선 제거 (--- 또는 ***)
            html = html.replace(/^-{3,}$/gm, '');
            html = html.replace(/^\*{3,}$/gm, '');

            // 헤더 앞에 줄바꿈이 없는 경우 추가 (테이블 등 뒤에 바로 붙은 경우)
            html = html.replace(/([^\n])(#{1,4}\s)/g, '$1\n$2');

            // 빈 # 줄 제거 (LLM이 섹션 구분용으로 출력하는 경우)
            // 예: "# \n" 또는 "#\n" (내용 없는 헤더)
            html = html.replace(/^#{1,4}\s*$/gm, '');

            // 헤더 (### 1. 또는 ###1. 형식도 처리)
            html = html
                .replace(/^###\s*(\d+)\.\s*(.*$)/gm, '<h3 class="finding-header"><span class="finding-number">$1.</span> $2</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // 번호 목록을 헤더로 변환 (1. [2023년] 형식)
                .replace(/^(\d+)\.\s*\[([^\]]+)\]\s*(.*$)/gm, '<h3 class="finding-header"><span class="finding-number">$1.</span> [$2] $3</h3>')
                // 굵은 글씨
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // 기울임 (단독 * 만 - 리스트는 이미 위에서 처리됨)
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // [미검증] 태그를 빨간 배지로 변환
                .replace(/\[미검증[^\]]*\]/g, '<span class="badge-unverified">$&</span>')
                // 마크다운 링크를 HTML 링크로 변환 (출처 URL용)
                .replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank" class="mna-source-link" title="$2">$1</a>')
                // 단순 URL을 하이퍼링크로 변환 (href= 안에 있지 않은 것만)
                .replace(/(?<!="|'>)(https?:\/\/[^\s<)\]"']+)/g, '<a href="$1" target="_blank" class="mna-source-link">$1</a>')
                // 불릿 리스트 (- 로 통일됨)
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/^\s+- (.*$)/gm, '<li>$1</li>')
                // 줄바꿈 처리
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n(\d+)\.\s/g, '</p><p>$1. ')  // 번호 목록 앞 줄바꿈 보존
                .replace(/\n- /g, '</p><p>- ')             // 불릿 앞 줄바꿈 보존
                .replace(/\n/g, ' ');

            // 번호 매기기 리스트: "1. text" → "<li>text</li>" (헤더로 변환되지 않은 것만)
            html = html.replace(/(^|<\/p><p>|<\/h[1-6]>|<\/ul>|<\/table>)\s*(\d+)\.\s\s*((?:(?!<\/p>|<h[1-6]|<ul|<table).)+)/g,
                '$1<ol-li>$3</ol-li>');

            // 연속된 ol-li 사이의 </p><p> 제거 (개별 <ol>로 분리되는 것 방지)
            html = html.replace(/<\/ol-li>\s*<\/p><p>\s*<ol-li>/g, '</ol-li><ol-li>');

            // 리스트 래핑 - 연속된 li를 ul로 묶기 (HTML 내용 포함)
            html = html.replace(/((?:\s*<li>[\s\S]*?<\/li>)+)/g, '<ul>$1</ul>');

            // ol 리스트 래핑
            html = html.replace(/((?:\s*<ol-li>[\s\S]*?<\/ol-li>)+)/g, (match) => {
                return '<ol>' + match.replace(/<ol-li>/g, '<li>').replace(/<\/ol-li>/g, '</li>') + '</ol>';
            });

            // 불필요한 빈 p 태그 제거
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p>\s*<(h[1-6]|ul|ol|table)/g, '<$1');
            html = html.replace(/<\/(h[1-6]|ul|ol|table)>\s*<\/p>/g, '</$1>');
            // p 안에 block 요소가 감싸인 경우 정리
            html = html.replace(/<p>(\s*<(?:ul|ol|table|h[1-6])[\s\S]*?<\/(?:ul|ol|table|h[1-6])>\s*)<\/p>/g, '$1');

            // Mermaid 블록 복원
            mermaidBlocks.forEach((code, index) => {
                html = html.replace(`%%MERMAID_BLOCK_${index}%%`,
                    `<div class="mermaid">${code}</div>`);
            });

            return `<p>${html}</p>`;
        }

        // Mermaid 렌더링 함수
        function renderMermaid() {
            if (typeof mermaid !== 'undefined') {
                mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
            }
        }

        // JSON 기반 리서치 보고서 렌더링 함수
        function renderResearchReport(data) {
            // JSON 파싱 실패 시 fallback
            if (data.error) {
                return `<div class="research-error">
                    <p>보고서 파싱 중 오류가 발생했습니다.</p>
                    <pre>${data.raw_text || ''}</pre>
                </div>`;
            }

            let html = '';

            // 1. 제목
            if (data.title) {
                html += `<h2 class="research-title">${data.title}</h2>`;
            }

            // 2. 기업 개요
            if (data.overview) {
                html += `<div class="research-section overview-section">`;
                html += `<h3>기업 개요</h3>`;
                html += `<table class="overview-table">`;
                for (const [key, value] of Object.entries(data.overview)) {
                    if (value) {
                        html += `<tr><th>${key}</th><td>${value}</td></tr>`;
                    }
                }
                html += `</table></div>`;
            }

            // 3. 사업 영역
            if (data.business) {
                html += `<div class="research-section">`;
                html += `<h3>사업 영역</h3>`;
                if (data.business.summary) {
                    html += `<p class="business-summary">${data.business.summary}</p>`;
                }
                if (data.business.areas && data.business.areas.length > 0) {
                    html += `<ul class="business-areas">`;
                    for (const area of data.business.areas) {
                        html += `<li><strong>${area.name}</strong>: ${area.description}</li>`;
                    }
                    html += `</ul>`;
                }
                html += `</div>`;
            }

            // 4. 경쟁사 분석
            if (data.competitors) {
                html += `<div class="research-section">`;
                html += `<h3>경쟁사 분석</h3>`;

                // 국내 경쟁사
                if (data.competitors.domestic && data.competitors.domestic.length > 0) {
                    html += `<h4>국내 경쟁사</h4>`;
                    html += `<div class="competitors-list">`;
                    for (const comp of data.competitors.domestic) {
                        html += `<div class="competitor-card">`;
                        html += `<div class="competitor-header">`;
                        html += `<span class="competitor-name">${comp.name}</span>`;
                        if (comp.ticker) {
                            html += `<span class="competitor-ticker">(${comp.ticker})</span>`;
                        }
                        html += `</div>`;
                        if (comp.field) {
                            html += `<div class="competitor-field"><strong>경쟁 분야:</strong> ${comp.field}</div>`;
                        }
                        if (comp.reason) {
                            html += `<div class="competitor-reason"><strong>경쟁 이유:</strong> ${comp.reason}</div>`;
                        }
                        if (comp.details) {
                            html += `<div class="competitor-details">${comp.details}</div>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                // 해외 경쟁사
                if (data.competitors.international && data.competitors.international.length > 0) {
                    html += `<h4>해외 경쟁사</h4>`;
                    html += `<div class="competitors-list">`;
                    for (const comp of data.competitors.international) {
                        html += `<div class="competitor-card">`;
                        html += `<div class="competitor-header">`;
                        html += `<span class="competitor-name">${comp.name}</span>`;
                        if (comp.ticker) {
                            html += `<span class="competitor-ticker">(${comp.ticker})</span>`;
                        }
                        html += `</div>`;
                        if (comp.field) {
                            html += `<div class="competitor-field"><strong>경쟁 분야:</strong> ${comp.field}</div>`;
                        }
                        if (comp.reason) {
                            html += `<div class="competitor-reason"><strong>경쟁 이유:</strong> ${comp.reason}</div>`;
                        }
                        if (comp.details) {
                            html += `<div class="competitor-details">${comp.details}</div>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // 4-1. 협력사 분석
            if (data.partners) {
                const hasDomestic = data.partners.domestic && data.partners.domestic.length > 0;
                const hasInternational = data.partners.international && data.partners.international.length > 0;

                if (hasDomestic || hasInternational) {
                    html += `<div class="research-section">`;
                    html += `<h3>협력사 분석</h3>`;

                    const relLabels = {partner: '제휴', supplier: '공급업체', customer: '고객사'};

                    // 국내 협력사
                    if (hasDomestic) {
                        html += `<h4>국내 협력사</h4>`;
                        html += `<div class="competitors-list">`;
                        for (const p of data.partners.domestic) {
                            const relLabel = relLabels[p.relationship_type] || p.relationship_type || '협력사';
                            html += `<div class="competitor-card">`;
                            html += `<div class="competitor-header">`;
                            html += `<span class="competitor-name">${p.name}</span>`;
                            html += `<span class="competitor-ticker" style="background:#e8f5e9;color:#2e7d32;">${relLabel}</span>`;
                            if (p.ticker) {
                                html += `<span class="competitor-ticker">(${p.ticker})</span>`;
                            }
                            html += `</div>`;
                            if (p.field) {
                                html += `<div class="competitor-field"><strong>사업 분야:</strong> ${p.field}</div>`;
                            }
                            if (p.reason) {
                                html += `<div class="competitor-reason"><strong>관계:</strong> ${p.reason}</div>`;
                            }
                            if (p.details) {
                                html += `<div class="competitor-details">${p.details}</div>`;
                            }
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    // 해외 협력사
                    if (hasInternational) {
                        html += `<h4>해외 협력사</h4>`;
                        html += `<div class="competitors-list">`;
                        for (const p of data.partners.international) {
                            const relLabel = relLabels[p.relationship_type] || p.relationship_type || '협력사';
                            html += `<div class="competitor-card">`;
                            html += `<div class="competitor-header">`;
                            html += `<span class="competitor-name">${p.name}</span>`;
                            html += `<span class="competitor-ticker" style="background:#e8f5e9;color:#2e7d32;">${relLabel}</span>`;
                            if (p.ticker) {
                                html += `<span class="competitor-ticker">(${p.ticker})</span>`;
                            }
                            html += `</div>`;
                            if (p.field) {
                                html += `<div class="competitor-field"><strong>사업 분야:</strong> ${p.field}</div>`;
                            }
                            if (p.reason) {
                                html += `<div class="competitor-reason"><strong>관계:</strong> ${p.reason}</div>`;
                            }
                            if (p.details) {
                                html += `<div class="competitor-details">${p.details}</div>`;
                            }
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                }
            }

            // 5. M&A 사례
            if (data.mna) {
                const hasDomestic = data.mna.domestic && data.mna.domestic.length > 0;
                const hasInternational = data.mna.international && data.mna.international.length > 0;

                if (hasDomestic || hasInternational) {
                    html += `<div class="research-section">`;
                    html += `<h3>M&A 사례</h3>`;

                    // 국내 M&A
                    if (hasDomestic) {
                        html += `<h4>국내 M&A</h4>`;
                        html += `<table class="mna-table">`;
                        html += `<thead><tr><th>인수기업</th><th>피인수기업</th><th>시기</th><th>금액</th><th>출처</th></tr></thead>`;
                        html += `<tbody>`;
                        for (const m of data.mna.domestic) {
                            const sourceUrl = m.source_url || '';
                            const sourceCell = sourceUrl
                                ? `<a href="${sourceUrl}" target="_blank" class="mna-source-link" title="${sourceUrl}">↗</a>`
                                : `<span class="badge-unverified">미검증</span>`;
                            html += `<tr>`;
                            html += `<td>${m.acquirer || '-'}</td>`;
                            html += `<td>${m.target || '-'}</td>`;
                            html += `<td>${m.date || '-'}</td>`;
                            html += `<td>${m.price || '-'}</td>`;
                            html += `<td>${sourceCell}</td>`;
                            html += `</tr>`;
                        }
                        html += `</tbody></table>`;
                    }

                    // 해외 M&A
                    if (hasInternational) {
                        html += `<h4>해외 M&A</h4>`;
                        html += `<table class="mna-table">`;
                        html += `<thead><tr><th>인수기업</th><th>피인수기업</th><th>시기</th><th>금액</th><th>출처</th></tr></thead>`;
                        html += `<tbody>`;
                        for (const m of data.mna.international) {
                            const sourceUrl = m.source_url || '';
                            const sourceCell = sourceUrl
                                ? `<a href="${sourceUrl}" target="_blank" class="mna-source-link" title="${sourceUrl}">↗</a>`
                                : `<span class="badge-unverified">미검증</span>`;
                            html += `<tr>`;
                            html += `<td>${m.acquirer || '-'}</td>`;
                            html += `<td>${m.target || '-'}</td>`;
                            html += `<td>${m.date || '-'}</td>`;
                            html += `<td>${m.price || '-'}</td>`;
                            html += `<td>${sourceCell}</td>`;
                            html += `</tr>`;
                        }
                        html += `</tbody></table>`;
                    }

                    html += `</div>`;
                }
            }

            // 6. 주요 뉴스/공시
            if (data.news) {
                html += `<div class="research-section">`;
                html += `<h3>주요 뉴스 <span style="font-size:12px;font-weight:normal;color:#888;margin-left:8px;">최근 5년 이내 검색 결과.</span></h3>`;
                // 배열 또는 배열-like 객체 모두 안전하게 처리
                let newsArr = data.news;
                if (!Array.isArray(newsArr)) {
                    try { newsArr = Array.from(newsArr); } catch(e) { newsArr = null; }
                }
                if (newsArr && newsArr.length > 0 && typeof newsArr[0] === 'object') {
                    // 최신 날짜순 정렬 (YYYY.MM → 역순)
                    newsArr.sort((a, b) => {
                        const da = (a.date || '').replace(/[^0-9.]/g, '');
                        const db = (b.date || '').replace(/[^0-9.]/g, '');
                        if (!da && !db) return 0;
                        if (!da) return 1;
                        if (!db) return -1;
                        return db.localeCompare(da);
                    });
                    html += `<div class="news-list">`;
                    newsArr.forEach(item => {
                        if (typeof item === 'object' && item !== null) {
                            const isDisclosure = item.type === '공시';
                            const typeTag = item.type ? `<span class="news-type ${isDisclosure ? 'type-disclosure' : 'type-news'}">${item.type}</span>` : '';
                            const dateTag = item.date ? `<span class="news-date">${item.date}</span>` : '';
                            const linkTag = item.url ? `<a href="${item.url}" target="_blank" class="news-link" title="${item.url}">↗</a>` : '';
                            const descTag = item.description ? `<div class="news-description">${item.description}</div>` : '';
                            html += `<div class="news-item"><div class="news-header">${typeTag}${dateTag}<span class="news-title">${item.title || ''}</span>${linkTag}</div>${descTag}</div>`;
                        }
                    });
                    html += `</div>`;
                } else if (typeof data.news === 'string') {
                    html += `<div class="news-content">${data.news}</div>`;
                } else {
                    // 최종 fallback: JSON.stringify로 확인 가능하게
                    html += `<div class="news-content">${JSON.stringify(data.news)}</div>`;
                }
                html += `</div>`;
            }

            return html || '<p>리서치 결과가 없습니다.</p>';
        }

        // 다운로드 버튼 활성화 함수
        function enableDownloadButton() {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadTooltip = document.getElementById('downloadTooltip');

            if (downloadBtn) {
                downloadBtn.disabled = false;
            }
            if (downloadTooltip) {
                downloadTooltip.classList.add('hidden');
            }
        }

        // 다운로드 버튼 비활성화 함수 (리셋 시 사용)
        function disableDownloadButton() {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadTooltip = document.getElementById('downloadTooltip');

            if (downloadBtn) {
                downloadBtn.disabled = true;
            }
            if (downloadTooltip) {
                downloadTooltip.classList.remove('hidden');
            }
        }

        function downloadFile() {
            // AI 분석이 완료되지 않았으면 무시 (버튼이 disabled라 보통은 여기 안옴)
            if (!isAnalysisCompleted) {
                return;
            }

            // 페이지 이동 없이 다운로드 (화면 유지)
            const link = document.createElement('a');
            // filename이 있으면 직접 파일명으로 다운로드 (TASKS 만료 후에도 작동)
            if (currentFilename) {
                link.href = `/api/download-file/${encodeURIComponent(currentFilename)}`;
            } else if (currentTaskId) {
                link.href = `/api/download/${currentTaskId}`;
            } else {
                alert('다운로드할 파일이 없습니다. 다시 추출해주세요.');
                return;
            }
            link.download = '';  // 서버에서 파일명 지정
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ============================================================
        // 초기화
        // ============================================================
        function resetAll() {
            stopStatusCheck();
            stopAnalysisStatusCheck();
            stopHeartbeat();

            // 챗봇 초기화
            resetChatbot();

            // 상태 플래그 초기화
            isExtractionComplete = false;
            isAnalysisStarting = false;

            // 작업 삭제
            if (currentTaskId) {
                fetch(`/api/task/${currentTaskId}`, { method: 'DELETE' }).catch(() => {});
                currentTaskId = null;
            }

            selectedCorp = null;
            previewData = null;
            currentFilename = null;
            companyInfoData = null;

            // UI 초기화
            document.getElementById('companyInput').value = '';
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('progressSection').classList.remove('show');
            document.getElementById('extractingSection').classList.remove('show');
            document.getElementById('resultContainer').classList.remove('show');
            document.getElementById('resultContainer').classList.remove('expanded');
            document.getElementById('completeSection').classList.remove('show');
            document.getElementById('companyInfoWrapper').style.display = 'none';
            document.getElementById('mainContainer').classList.add('centered');
            hideError();

            // 기업개황정보 초기화
            document.getElementById('companyInfoLoading').style.display = 'flex';
            document.getElementById('companyInfoLoading').innerHTML = '<span class="spinner"></span> 기업정보 로딩 중...';
            document.getElementById('companyInfoTable').style.display = 'none';
            document.getElementById('companyInfoBody').innerHTML = '';
            updateCompanyInfoTitle(false);  // 제목 초기화

            // AI 분석 섹션 초기화
            document.getElementById('analysisStartContainer').style.display = 'none';
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('analysisResult').style.display = 'none';
            document.getElementById('analysisStatus').textContent = '';
            document.getElementById('analysisStatus').className = 'analysis-status';
            document.getElementById('analysisMessage').classList.remove('loading');
            document.getElementById('analysisMessage').textContent = '분석 준비 중';
            const analysisProgressBar = document.getElementById('analysisProgressBar');
            analysisProgressBar.style.width = '0%';
            analysisProgressBar.textContent = '0%';
            isIntegratedMode = false;
            isAnalysisCompleted = false;
            analysisReportText = '';

            // 다운로드 버튼 비활성화 및 툴팁 표시
            disableDownloadButton();

            // 복사 버튼 초기화
            const copyBtn = document.getElementById('analysisCopyBtn');
            copyBtn.style.display = 'none';
            copyBtn.textContent = '복사';
            copyBtn.classList.remove('copied');
            document.getElementById('analysisStatus').style.display = '';

            // 상위 탭 초기화 (재무정보 탭으로)
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active', 'analyzing', 'completed');
                if (tab.dataset.mainTab === 'financial') tab.classList.add('active');
            });
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('financialTabContent').classList.add('active');

            // VCM 서브탭 버튼 및 툴팁 초기화
            const vcmAiBtn = document.querySelector('.vcm-sub-tab[data-vcm-box="ai"]');
            if (vcmAiBtn) {
                vcmAiBtn.textContent = '재무분석 AI';
                vcmAiBtn.classList.remove('analyzing');
            }
            const vcmAiTooltip = document.getElementById('vcmAiTooltip');
            if (vcmAiTooltip) {
                vcmAiTooltip.textContent = '분석 작업은 약 1~3분 정도 소요됩니다.';
                vcmAiTooltip.classList.add('hidden');
            }

            // 진행바 초기화
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }
        
        // ============================================================
        // 에러 처리
        // ============================================================
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        // ============================================================
        // PE 챗봇
        // ============================================================
        let chatbotInitialized = false;
        let chatbotSending = false;

        function toggleCiPanel(panel) {
            const panels = document.getElementById('ciPanels');
            const infoBtn = document.querySelector('.ci-tab[data-ci-panel="info"]');
            const chatBtn = document.querySelector('.ci-tab[data-ci-panel="chat"]');
            if (!panels || !infoBtn || !chatBtn) return;

            const infoActive = infoBtn.classList.contains('active');
            const chatActive = chatBtn.classList.contains('active');

            // 숨기기 전에 기업개황 높이 캡처
            const infoSection = document.getElementById('companyInfoSection');
            if (infoSection && infoSection.offsetHeight > 0) {
                panels.style.setProperty('--ci-height', infoSection.offsetHeight + 'px');
            }

            // 독립 토글: 클릭한 탭만 on/off (단, 최소 1개는 유지)
            if (panel === 'info') {
                if (infoActive && chatActive) {
                    infoBtn.classList.remove('active');
                } else if (infoActive && !chatActive) {
                    return;
                } else {
                    infoBtn.classList.add('active');
                }
            } else if (panel === 'chat') {
                if (chatActive && infoActive) {
                    chatBtn.classList.remove('active');
                } else if (chatActive && !infoActive) {
                    return;
                } else {
                    chatBtn.classList.add('active');
                }
            }

            // 상태 반영
            const nowInfo = infoBtn.classList.contains('active');
            const nowChat = chatBtn.classList.contains('active');

            panels.classList.remove('expanded-info', 'expanded-chat');
            if (nowInfo && !nowChat) panels.classList.add('expanded-info');
            if (nowChat && !nowInfo) panels.classList.add('expanded-chat');
        }

        function toggleChatFullscreen() {
            const section = document.getElementById('chatbotSection');
            const overlay = document.getElementById('chatFullscreenOverlay');
            const btn = document.getElementById('chatFullscreenBtn');
            if (!section || !btn) return;

            const isFullscreen = section.classList.toggle('fullscreen-mode');
            if (overlay) overlay.classList.toggle('active', isFullscreen);

            if (isFullscreen) {
                btn.innerHTML = '&#x2716; 닫기';
                document.body.style.overflow = 'hidden';
            } else {
                btn.innerHTML = '&#x26F6; 전체 화면';
                document.body.style.overflow = '';
            }
            document.getElementById('chatInput')?.focus();
        }

        let chatbotInitRetries = 0;
        const CHATBOT_MAX_RETRIES = 3;

        async function initChatbot() {
            if (!currentTaskId || chatbotInitialized) return;

            try {
                const resp = await fetch(`/api/chat/init/${currentTaskId}`, { method: 'POST' });
                const data = await resp.json();

                if (data.success) {
                    chatbotInitialized = true;
                    chatbotInitRetries = 0;

                    // 환영 메시지 업데이트
                    const messagesEl = document.getElementById('chatbotMessages');
                    messagesEl.innerHTML = '';
                    appendChatMessage('assistant', `안녕하세요! **${data.company_name}**의 재무 데이터를 분석할 준비가 되었습니다. PE 관점의 분석이 필요하시면 무엇이든 물어보세요.`);

                    // 추천 질문 렌더링
                    renderRecentQuestions(data.recent_questions || []);

                    // 챗봇 활성화
                    const wrapper = document.getElementById('companyInfoWrapper');
                    wrapper.classList.add('with-chatbot');
                    document.getElementById('chatbotSection').style.display = 'flex';
                    document.getElementById('ciTabs').classList.add('show');
                    document.getElementById('chatbotStatus').textContent = '준비 완료';

                    // AI 어시스턴트 탭 버튼 활성화
                    const chatTabBtn = document.querySelector('.ci-tab[data-ci-panel="chat"]');
                    if (chatTabBtn) {
                        chatTabBtn.disabled = false;
                        chatTabBtn.style.opacity = '';
                        chatTabBtn.style.cursor = '';
                        chatTabBtn.classList.add('active');
                    }

                    // expanded-info 해제 (양쪽 패널 표시)
                    const ciPanels = document.getElementById('ciPanels');
                    if (ciPanels) {
                        ciPanels.classList.remove('expanded-info');
                    }

                    // 기업개황 높이 캡처 (챗봇 높이 동기화)
                    const infoSection = document.getElementById('companyInfoSection');
                    if (ciPanels && infoSection) {
                        ciPanels.style.setProperty('--ci-height', infoSection.offsetHeight + 'px');
                        // 기업개황 높이 변경 시 자동 동기화
                        new ResizeObserver(() => {
                            if (infoSection.offsetHeight > 0) {
                                ciPanels.style.setProperty('--ci-height', infoSection.offsetHeight + 'px');
                            }
                        }).observe(infoSection);
                    }

                    // VCM wrapper 너비에 맞추기
                    syncWrapperWidth();
                } else {
                    // 서버 응답은 있지만 실패 → 재시도
                    chatbotInitRetries++;
                    if (chatbotInitRetries < CHATBOT_MAX_RETRIES) {
                        console.warn(`[Chatbot] 초기화 실패, ${chatbotInitRetries}/${CHATBOT_MAX_RETRIES} 재시도 (5초 후)`);
                        setTimeout(() => { initChatbot(); }, 5000);
                    }
                }
            } catch (e) {
                console.error('[Chatbot] 초기화 실패:', e);
                // 네트워크 오류 시 재시도
                chatbotInitRetries++;
                if (chatbotInitRetries < CHATBOT_MAX_RETRIES) {
                    console.warn(`[Chatbot] 네트워크 오류, ${chatbotInitRetries}/${CHATBOT_MAX_RETRIES} 재시도 (5초 후)`);
                    setTimeout(() => { initChatbot(); }, 5000);
                }
            }
        }

        function syncWrapperWidth() {
            const vcmWrapper = document.querySelector('.vcm-wrapper');
            const wrapper = document.getElementById('companyInfoWrapper');
            if (vcmWrapper && wrapper) {
                const vcmWidth = vcmWrapper.offsetWidth;
                if (vcmWidth > 0) {
                    wrapper.style.width = vcmWidth + 'px';
                }
            }
        }

        window.addEventListener('resize', () => {
            if (chatbotInitialized) syncWrapperWidth();
        });

        function renderRecentQuestions(questions) {
            const container = document.getElementById('chatbotSuggestions');
            container.innerHTML = '';
            if (!questions || !questions.length) return;
            questions.forEach(q => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';

                const text = document.createElement('span');
                text.className = 'q-text';
                text.textContent = q.question;
                text.onclick = () => {
                    document.getElementById('chatInput').value = q.question;
                    sendChatMessage();
                };

                const x = document.createElement('span');
                x.className = 'remove-btn';
                x.textContent = '✕';
                x.onclick = async (e) => {
                    e.stopPropagation();
                    await fetch(`/api/chat/recent-question/${q.id}`, { method: 'DELETE' });
                    btn.remove();
                };

                btn.appendChild(text);
                btn.appendChild(x);
                container.appendChild(btn);
            });
        }

        function appendChatMessage(role, content) {
            const messagesEl = document.getElementById('chatbotMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${role}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'chat-bubble';

            if (role === 'assistant') {
                bubbleDiv.innerHTML = markdownToHtml(content);
            } else {
                bubbleDiv.textContent = content;
            }

            msgDiv.appendChild(bubbleDiv);
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return bubbleDiv;
        }

        function appendChatStatus(text) {
            const messagesEl = document.getElementById('chatbotMessages');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'chat-status-msg';
            statusDiv.id = 'chatStatusMsg';
            statusDiv.innerHTML = `${text} <span class="status-dots"><span></span><span></span><span></span></span>`;
            messagesEl.appendChild(statusDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return statusDiv;
        }

        function removeChatStatus() {
            const el = document.getElementById('chatStatusMsg');
            if (el) el.remove();
        }

        function showTypingIndicator() {
            const messagesEl = document.getElementById('chatbotMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'chatTypingIndicator';
            typingDiv.innerHTML = '<div class="chat-typing-indicator"><span></span><span></span><span></span></div>';
            messagesEl.appendChild(typingDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('chatTypingIndicator');
            if (el) el.remove();
        }

        function handleChatKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
            if (e.key === 'Escape') {
                const section = document.getElementById('chatbotSection');
                if (section && section.classList.contains('fullscreen-mode')) {
                    toggleChatFullscreen();
                }
            }
        }

        async function sendChatMessage() {
            if (chatbotSending || !chatbotInitialized || !currentTaskId) return;

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            chatbotSending = true;
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('chatSendBtn').disabled = true;
            document.getElementById('chatbotStatus').textContent = '응답 중...';

            // 추천 질문 숨기기
            document.getElementById('chatbotSuggestions').innerHTML = '';

            // 사용자 메시지 표시
            appendChatMessage('user', message);

            // 타이핑 인디케이터
            showTypingIndicator();

            try {
                const resp = await fetch(`/api/chat/message/${currentTaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }

                // SSE 스트리밍 처리 (타이핑 인디케이터는 첫 토큰까지 유지)
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let assistantBubble = null;
                let fullText = '';
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const jsonStr = line.slice(6).trim();
                        if (!jsonStr) continue;

                        try {
                            const event = JSON.parse(jsonStr);

                            if (event.type === 'classify') {
                                removeTypingIndicator();
                                const typeMap = { default: '🔍 분석 중...', search: '🌐 검색 중...' };
                                const statusMsg = typeMap[event.content] || '응답 중...';
                                document.getElementById('chatbotStatus').textContent = statusMsg;
                                appendChatStatus(statusMsg);
                            } else if (event.type === 'status') {
                                removeChatStatus();
                                appendChatStatus(event.content);
                            } else if (event.type === 'search_start') {
                                removeChatStatus();
                                appendChatStatus('웹 검색 중...');
                            } else if (event.type === 'search_done') {
                                removeChatStatus();
                                appendChatStatus('검색 결과 분석 중...');
                            } else if (event.type === 'token') {
                                if (!assistantBubble) {
                                    removeChatStatus();
                                    removeTypingIndicator();
                                    assistantBubble = appendChatMessage('assistant', '');
                                }
                                fullText += event.content;
                                // 스트리밍 중 렌더링 스로틀 (테이블 깨짐 방지)
                                if (!assistantBubble._renderPending) {
                                    assistantBubble._renderPending = true;
                                    requestAnimationFrame(() => {
                                        assistantBubble.innerHTML = markdownToHtml(fullText);
                                        assistantBubble._renderPending = false;
                                        const messagesEl = document.getElementById('chatbotMessages');
                                        messagesEl.scrollTop = messagesEl.scrollHeight;
                                    });
                                }
                            } else if (event.type === 'references') {
                                // 참고 자료 접이식 추가
                                if (assistantBubble && event.content && event.content.length > 0) {
                                    const refsHtml = event.content.map((ref, i) => {
                                        const domain = new URL(ref.url).hostname.replace('www.', '');
                                        const title = ref.title || domain;
                                        return `<div class="ref-item"><span class="ref-num">[${i+1}]</span><a href="${ref.url}" target="_blank" title="${ref.url}">${title}</a></div>`;
                                    }).join('');
                                    const detailsEl = document.createElement('details');
                                    detailsEl.className = 'chat-references';
                                    detailsEl.innerHTML = `<summary>참고 자료 (${event.content.length}건)</summary><div class="ref-list">${refsHtml}</div>`;
                                    assistantBubble.appendChild(detailsEl);
                                }
                            } else if (event.type === 'error') {
                                removeChatStatus();
                                removeTypingIndicator();
                                appendChatMessage('assistant', `오류가 발생했습니다: ${event.content}`);
                            } else if (event.type === 'done') {
                                removeChatStatus();
                                // 최종 렌더링 (스트리밍 중 누락분 보정)
                                if (assistantBubble && fullText) {
                                    assistantBubble.innerHTML = markdownToHtml(fullText);
                                }
                            }
                        } catch (parseErr) {
                            // JSON 파싱 실패 무시
                        }
                    }
                }
            } catch (e) {
                removeTypingIndicator();
                removeChatStatus();
                appendChatMessage('assistant', `연결 오류가 발생했습니다. 다시 시도해주세요.`);
                console.error('[Chatbot] 전송 실패:', e);
            } finally {
                chatbotSending = false;
                document.getElementById('chatSendBtn').disabled = false;
                document.getElementById('chatbotStatus').textContent = '준비 완료';

                // 최근 질문 목록 갱신
                if (currentTaskId) {
                    try {
                        const rResp = await fetch(`/api/chat/init/${currentTaskId}`, { method: 'POST' });
                        const rData = await rResp.json();
                        if (rData.recent_questions) renderRecentQuestions(rData.recent_questions);
                    } catch (e) { /* ignore */ }
                }
            }
        }

        // 챗봇 컨텍스트 업데이트 (AI 분석/리서치 완료 후)
        async function updateChatbotContext() {
            if (!chatbotInitialized || !currentTaskId) return;
            try {
                const resp = await fetch(`/api/chat/update-context/${currentTaskId}`, { method: 'POST' });
                const data = await resp.json();
                if (data.success && data.recent_questions) {
                    renderRecentQuestions(data.recent_questions);
                }
            } catch (e) {
                console.error('[Chatbot] 컨텍스트 업데이트 실패:', e);
            }
        }

        // 리셋 시 챗봇 정리
        function resetChatbot() {
            chatbotInitialized = false;
            chatbotSending = false;
            document.getElementById('chatbotSection').style.display = 'none';
            const ciWrapper = document.getElementById('companyInfoWrapper');
            ciWrapper.classList.remove('with-chatbot');
            ciWrapper.style.width = '';
            document.getElementById('chatbotMessages').innerHTML = '';
            document.getElementById('chatbotSuggestions').innerHTML = '';
            document.getElementById('chatbotStatus').textContent = '대기 중';
            // 탭 리셋
            const ciTabs = document.getElementById('ciTabs');
            if (ciTabs) ciTabs.classList.remove('show');
            const ciPanels = document.getElementById('ciPanels');
            if (ciPanels) ciPanels.classList.remove('expanded-info', 'expanded-chat');
            document.querySelectorAll('.ci-tab').forEach(t => t.classList.add('active'));
        }
    </script>
</body>
</html>
